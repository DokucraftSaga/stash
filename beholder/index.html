<!DOCTYPE html><html><head><title>Beholder - Panorama Viewer</title><meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1, maximum-scale=1"><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/108/three.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.8/hammer.min.js"></script><style>* {
  margin: 0;
  padding: 0;
}
body {
  background: #000;
  overflow: hidden;
  width: 100%;
  height: 100%;
}
canvas {
  opacity: 0;
  transition: opacity 2.5s;
}
#loading-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: Consolas,monospace;
  color: #999999;
  font-size: 72px;
  opacity: 1;
  transition: opacity 2s;
  pointer-events: none;
  cursor: default;
  user-select: none;
}</style></head><body><div id="loading-hint">Loading...</div><script>THREE.PointerLockControls=function(t,e){function o(e){if(!1!==r.isLocked){var o=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;u.setFromQuaternion(t.quaternion),u.y-=.002*o,u.x-=.002*n,u.x=Math.max(-d,Math.min(d,u.x)),t.quaternion.setFromEuler(u),r.dispatchEvent(c)}}function n(){document.pointerLockElement===r.domElement?(r.dispatchEvent(s),r.isLocked=!0):(r.dispatchEvent(m),r.isLocked=!1)}function i(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}this.domElement=e||document.body,this.isLocked=!1;var r=this,c={type:"change"},s={type:"lock"},m={type:"unlock"},u=new THREE.Euler(0,0,0,"YXZ"),d=Math.PI/2,a=new THREE.Vector3;this.connect=function(){document.addEventListener("mousemove",o,!1),document.addEventListener("pointerlockchange",n,!1),document.addEventListener("pointerlockerror",i,!1)},this.disconnect=function(){document.removeEventListener("mousemove",o,!1),document.removeEventListener("pointerlockchange",n,!1),document.removeEventListener("pointerlockerror",i,!1)},this.dispose=function(){this.disconnect()},this.getObject=function(){return t},this.getDirection=function(){var e=new THREE.Vector3(0,0,-1);return function(o){return o.copy(e).applyQuaternion(t.quaternion)}}(),this.moveForward=function(e){a.setFromMatrixColumn(t.matrix,0),a.crossVectors(t.up,a),t.position.addScaledVector(a,e)},this.moveRight=function(e){a.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(a,e)},this.lock=function(){this.domElement.requestPointerLock()},this.unlock=function(){document.exitPointerLock()},this.connect()},THREE.PointerLockControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.PointerLockControls.prototype.constructor=THREE.PointerLockControls;</script><script>function getURLParams(e=location.search){if(e.length<2)return null;let n={};const a=/(?:^\?|&)([A-z0-9-]+)(?:=([^&]+)|(?=&)|$|=)/g;let t;for(;t=a.exec(e);)n[t[1]]=!t[2]||decodeURIComponent(t[2].replace(/\+/g,"%20"));return n}function cors(e){return e.match(/^https?:/)&&new URL(e).origin!=window.origin?"https://dokustash-cors.herokuapp.com/"+e:e}const skyboxUVs=e=>{const n=.5/e,a=n,t=1-n,i=1/3-n,o=1/3+n,r=2/3-n,s=2/3+n,c=.5-n,d=.5+n;return[[[{x:s,y:a},{x:s,y:c},{x:t,y:a}],[{x:s,y:c},{x:t,y:c},{x:t,y:a}],[{x:a,y:a},{x:a,y:c},{x:i,y:a}],[{x:a,y:c},{x:i,y:c},{x:i,y:a}],[{x:a,y:d},{x:a,y:t},{x:i,y:d}],[{x:a,y:t},{x:i,y:t},{x:i,y:d}],[{x:o,y:d},{x:o,y:t},{x:r,y:d}],[{x:o,y:t},{x:r,y:t},{x:r,y:d}],[{x:o,y:a},{x:o,y:c},{x:r,y:a}],[{x:o,y:c},{x:r,y:c},{x:r,y:a}],[{x:s,y:d},{x:s,y:t},{x:t,y:d}],[{x:s,y:t},{x:t,y:t},{x:t,y:d}]]]};(async()=>{const e=new THREE.Scene,n=new THREE.PerspectiveCamera(110,window.innerWidth/window.innerHeight,.1,1e3);window.innerWidth>window.innerHeight&&(n.fov=360*Math.atan(Math.tan(110*Math.PI/360)/n.aspect)/Math.PI,n.updateProjectionMatrix());const a=new THREE.PointerLockControls(n);e.add(a.getObject());const t=new THREE.Euler(0,0,0,"YXZ"),i=new THREE.WebGLRenderer;i.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(i.domElement),window.addEventListener("resize",()=>{n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),i.setSize(window.innerWidth,window.innerHeight)},!1);let o=!1;const r=()=>{window.removeEventListener("touchstart",r),o=!0,d.noCameraRotation=!0;const e=[null,null];new Hammer.Manager(document.body,{recognizers:[[Hammer.Pan,{threshold:0}]]}).on("pan",a=>{null==e[0]&&(e[0]=a.center.x,e[1]=a.center.y);const i=[a.center.x+a.deltaX,a.center.y+a.deltaY];t.setFromQuaternion(n.quaternion),t.y-=.001*(i[0]-e[0]),t.x-=.001*(i[1]-e[1]),t.x=Math.min(Math.max(-1.5,t.x),1.5),n.quaternion.setFromEuler(t),a.isFinal?(e[0]=null,e[1]=null):(e[0]=i[0],e[1]=i[1])})};window.addEventListener("touchstart",r);const s=new THREE.TextureLoader,c=e=>new Promise((n,a)=>{s.load(e,e=>{n(e)},null,e=>{a(e)})}),d=getURLParams();if(null==d||!d.src)return void(document.getElementById("loading-hint").textContent="Nothing to display.");let l;const y=async()=>{function r(){requestAnimationFrame(r),i.render(e,n),a.enabled||d.noCameraRotation||(t.setFromQuaternion(n.quaternion),t.y+=.001,n.quaternion.setFromEuler(t)),d.rotate&&(l.rotation.z+=2e-4)}if(document.body.addEventListener("click",e=>{d.noControl||o||(a.enabled?(a.unlock(),a.enabled=!1):(a.lock(),a.enabled=!0))},!1),d.terrain){const n=await c(`/stash/resources/beholder/terrain_${d.terrain}.png`);n.magFilter=THREE.NearestFilter,n.minFilter=THREE.LinearFilter;const a=new THREE.BoxGeometry(1,1,1);a.faceVertexUvs=skyboxUVs(n.image.height/2);const t=new THREE.MeshBasicMaterial({side:THREE.BackSide,map:n,transparent:!0}),i=new THREE.Mesh(a,t);e.add(i),i.scale.z=-1,i.scale.y=-1}i.domElement.style.opacity=1,document.getElementById("loading-hint").style.opacity=0,r()};if("skybox"==d.format){const n=await c(cors(d.src));n.magFilter=THREE.NearestFilter,n.minFilter=THREE.LinearFilter;const a=new THREE.BoxGeometry(5,5,5);a.faceVertexUvs=skyboxUVs(n.image.height/2);const t=new THREE.MeshBasicMaterial({side:THREE.BackSide,map:n});l=new THREE.Mesh(a,t),e.add(l),l.scale.z=-1,l.scale.y=-1,y()}else if("panorama"==d.format){const n=await fetch(cors(d.src));if(200!=n.status)throw new Error(n);const a=await JSZip.loadAsync(n.blob()),t=new THREE.BoxGeometry(5,5,5),i=new THREE.MeshFaceMaterial([await c("data:image/png;base64,"+await a.file("panorama_1.png").async("base64")),await c("data:image/png;base64,"+await a.file("panorama_3.png").async("base64")),await c("data:image/png;base64,"+await a.file("panorama_4.png").async("base64")),await c("data:image/png;base64,"+await a.file("panorama_5.png").async("base64")),await c("data:image/png;base64,"+await a.file("panorama_0.png").async("base64")),await c("data:image/png;base64,"+await a.file("panorama_2.png").async("base64"))].map(e=>(e.magFilter=THREE.NearestFilter,e.minFilter=THREE.LinearFilter,new THREE.MeshBasicMaterial({map:e,side:THREE.BackSide}))));l=new THREE.Mesh(t,i),e.add(l),y()}else document.getElementById("loading-hint").textContent="Invalid format."})();</script></body></html>