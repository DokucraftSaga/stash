<!DOCTYPE html><html><head><title>Beholder - Panorama Viewer</title><script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/108/three.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.2.2/jszip.min.js"></script><style>* {
  margin: 0;
  padding: 0;
}
body {
  background: #000;
  overflow: hidden;
  width: 100%;
  height: 100%;
}
canvas {
  opacity: 0;
  transition: opacity 2.5s;
}
#loading-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-family: Consolas,monospace;
  color: #999999;
  font-size: 72px;
  opacity: 1;
  transition: opacity 2s;
  pointer-events: none;
  cursor: default;
  user-select: none;
}</style></head><body><div id="loading-hint">Loading...</div><script>THREE.PointerLockControls=function(t,e){function o(e){if(!1!==r.isLocked){var o=e.movementX||e.mozMovementX||e.webkitMovementX||0,n=e.movementY||e.mozMovementY||e.webkitMovementY||0;u.setFromQuaternion(t.quaternion),u.y-=.002*o,u.x-=.002*n,u.x=Math.max(-d,Math.min(d,u.x)),t.quaternion.setFromEuler(u),r.dispatchEvent(c)}}function n(){document.pointerLockElement===r.domElement?(r.dispatchEvent(s),r.isLocked=!0):(r.dispatchEvent(m),r.isLocked=!1)}function i(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}this.domElement=e||document.body,this.isLocked=!1;var r=this,c={type:"change"},s={type:"lock"},m={type:"unlock"},u=new THREE.Euler(0,0,0,"YXZ"),d=Math.PI/2,a=new THREE.Vector3;this.connect=function(){document.addEventListener("mousemove",o,!1),document.addEventListener("pointerlockchange",n,!1),document.addEventListener("pointerlockerror",i,!1)},this.disconnect=function(){document.removeEventListener("mousemove",o,!1),document.removeEventListener("pointerlockchange",n,!1),document.removeEventListener("pointerlockerror",i,!1)},this.dispose=function(){this.disconnect()},this.getObject=function(){return t},this.getDirection=function(){var e=new THREE.Vector3(0,0,-1);return function(o){return o.copy(e).applyQuaternion(t.quaternion)}}(),this.moveForward=function(e){a.setFromMatrixColumn(t.matrix,0),a.crossVectors(t.up,a),t.position.addScaledVector(a,e)},this.moveRight=function(e){a.setFromMatrixColumn(t.matrix,0),t.position.addScaledVector(a,e)},this.lock=function(){this.domElement.requestPointerLock()},this.unlock=function(){document.exitPointerLock()},this.connect()},THREE.PointerLockControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.PointerLockControls.prototype.constructor=THREE.PointerLockControls;</script><script>function getURLParams(e=location.search){if(e.length<2)return null;let a={};const n=/(?:^\?|&)([A-z0-9-]+)(?:=([^&]+)|(?=&)|$|=)/g;let t;for(;t=n.exec(e);)a[t[1]]=!t[2]||decodeURIComponent(t[2].replace(/\+/g,"%20"));return a}function cors(e){return e.match(/^https?:/)&&new URL(e).origin!=window.origin?"https://dokustash-cors.herokuapp.com/"+e:e}const skyboxUVs=e=>{const a=.5/e,n=a,t=1-a,i=1/3-a,o=1/3+a,r=2/3-a,s=2/3+a,c=.5-a,d=.5+a;return[[[{x:s,y:n},{x:s,y:c},{x:t,y:n}],[{x:s,y:c},{x:t,y:c},{x:t,y:n}],[{x:n,y:n},{x:n,y:c},{x:i,y:n}],[{x:n,y:c},{x:i,y:c},{x:i,y:n}],[{x:n,y:d},{x:n,y:t},{x:i,y:d}],[{x:n,y:t},{x:i,y:t},{x:i,y:d}],[{x:o,y:d},{x:o,y:t},{x:r,y:d}],[{x:o,y:t},{x:r,y:t},{x:r,y:d}],[{x:o,y:n},{x:o,y:c},{x:r,y:n}],[{x:o,y:c},{x:r,y:c},{x:r,y:n}],[{x:s,y:d},{x:s,y:t},{x:t,y:d}],[{x:s,y:t},{x:t,y:t},{x:t,y:d}]]]};(async()=>{const e=new THREE.Scene,a=new THREE.PerspectiveCamera(85,window.innerWidth/window.innerHeight,.1,1e3),n=new THREE.PointerLockControls(a);e.add(n.getObject());const t=new THREE.Euler(0,0,0,"YXZ"),i=new THREE.WebGLRenderer;i.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(i.domElement),window.addEventListener("resize",()=>{a.aspect=window.innerWidth/window.innerHeight,a.updateProjectionMatrix(),i.setSize(window.innerWidth,window.innerHeight)},!1);const o=new THREE.TextureLoader,r=e=>new Promise((a,n)=>{o.load(e,e=>{a(e)},null,e=>{n(e)})}),s=getURLParams();if(null==s||!s.src)return void(document.getElementById("loading-hint").textContent="Nothing to display.");let c;const d=async()=>{function o(){requestAnimationFrame(o),i.render(e,a),n.enabled||s.noCameraRotation||(t.setFromQuaternion(a.quaternion),t.y+=.001,a.quaternion.setFromEuler(t)),s.rotate&&(c.rotation.z+=2e-4)}if(s.noControl||document.body.addEventListener("click",e=>{n.enabled?(n.unlock(),n.enabled=!1):(n.lock(),n.enabled=!0)},!1),s.terrain){const a=await r(`/stash/resources/beholder/terrain_${s.terrain}.png`);a.magFilter=THREE.NearestFilter,a.minFilter=THREE.LinearFilter;const n=new THREE.BoxGeometry(1,1,1);n.faceVertexUvs=skyboxUVs(a.image.height/2);const t=new THREE.MeshBasicMaterial({side:THREE.BackSide,map:a,transparent:!0}),i=new THREE.Mesh(n,t);e.add(i),i.scale.z=-1,i.scale.y=-1}i.domElement.style.opacity=1,document.getElementById("loading-hint").style.opacity=0,o()};if("skybox"==s.format){const a=await r(cors(s.src));a.magFilter=THREE.NearestFilter,a.minFilter=THREE.LinearFilter;const n=new THREE.BoxGeometry(5,5,5);n.faceVertexUvs=skyboxUVs(a.image.height/2);const t=new THREE.MeshBasicMaterial({side:THREE.BackSide,map:a});c=new THREE.Mesh(n,t),e.add(c),c.scale.z=-1,c.scale.y=-1,d()}else if("panorama"==s.format){const a=await fetch(cors(s.src));if(200!=a.status)throw new Error(a);const n=await JSZip.loadAsync(a.blob()),t=new THREE.BoxGeometry(5,5,5),i=new THREE.MeshFaceMaterial([await r("data:image/png;base64,"+await n.file("panorama_1.png").async("base64")),await r("data:image/png;base64,"+await n.file("panorama_3.png").async("base64")),await r("data:image/png;base64,"+await n.file("panorama_4.png").async("base64")),await r("data:image/png;base64,"+await n.file("panorama_5.png").async("base64")),await r("data:image/png;base64,"+await n.file("panorama_0.png").async("base64")),await r("data:image/png;base64,"+await n.file("panorama_2.png").async("base64"))].map(e=>(e.magFilter=THREE.NearestFilter,e.minFilter=THREE.LinearFilter,new THREE.MeshBasicMaterial({map:e,side:THREE.BackSide}))));c=new THREE.Mesh(t,i),e.add(c),d()}else document.getElementById("loading-hint").textContent="Invalid format."})();</script></body></html>