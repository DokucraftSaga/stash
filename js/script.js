function E(t){return $(document.createElement(t))}function onPageLoad(){$("#content-wrapper,#content-scroller,#content").each((t,e)=>e.removeAttribute("style")),stash.page.closeModal($(".stash-page-wrapper>.modal")),$(".stash-page-content").each((t,e)=>{"function"==typeof e.onUnload&&(e.onUnload(),e.onUnload=null),e.onSidebarToggle=null}),removeAllTooltips(),$("#searchbar input").val("");let t=getURLParams();if(null!=t){for(let e=0;e<pages.length;e++)if(t.hasOwnProperty(pages[e]))return void $("#content").load(`pages/${pages[e]}.html`,()=>stash.page.loaded($("#content")));$("#content").empty().append('<div class="hint">This page does not exist.</div>'),stash.workError()}else $("#content").load("pages/shortcuts.html",()=>stash.page.loaded($("#content")))}function removeAllTooltips(){$(".tippy-popper").remove()}function idSort(t,e){return stash.data[t].id-stash.data[e].id}function getApproxTime(t){if(t>legacyTimeData[legacyTimeData.length-1].id)return-1;for(let e=0;e<legacyTimeData.length;e++)if(t>legacyTimeData[e].id&&t<=legacyTimeData[e+1].id)return lerp(legacyTimeData[e].time,legacyTimeData[e+1].time,(t-legacyTimeData[e].id)/(legacyTimeData[e+1].id-legacyTimeData[e].id));return-1}function getExt(t){return rgxExt.exec(t)[1].toLowerCase()}function getContributor(t){return rgxContributor.exec(t)[1]}function getID(t){return parseInt(rgxID.exec(t)[1])}function getTimestamp(t){return stash.data[t].timestamp||getApproxTime(getID(t))}function createFilePreview(t,e){let a=stash.data[t].size;if(e.attr("data-file",t).addClass("file"),stash.data[t].mcmeta&&e.addClass("mcmeta").attr("data-filetype","Animation"),stash.data[t].packageType&&e.addClass(stash.data[t].packageType+" zip").attr("data-filetype",stash.typeNames[stash.data[t].packageType]),t.match(/\.png$/)){let s=stashURL+t;e.addClass("png"),stash.data[t].mcmeta||a[1]/a[0]>=6&&a[1]%a[0]==0?e.append(E("img").addClass("animated b-lazy").attr("src","/stash/resources/transparent.png").attr("data-src",s),E("div").addClass(`img b-lazy thumbnail${a[0]<128?" pixelated":""}`).attr("data-src",thumbnails+t)):a[0]>128||a[1]>128?e.append(E("div").addClass("img b-lazy thumbnail").attr("data-src",thumbnails+t),E("div").addClass("img b-lazy original").attr("data-src",s)):e.append(E("div").addClass(`img b-lazy${a[0]<128&&a[1]<128?" pixelated":""}`).attr("data-src",s))}else{let s=thumbnails+t.replace(/\.zip$/,".png");stash.data[t].mcmeta||a[1]/a[0]>6&&a[1]%a[0]==0?e.addClass("no-thumbnail").append(E("img").addClass("animated b-lazy").attr("src","/stash/resources/transparent.png").attr("data-src",s)):e.append(E("div").addClass(`img b-lazy${a[0]<128&&a[1]<128?" pixelated":""}`).attr("data-src",s))}let s=E("div").addClass("overlay").appendTo(e);return s.append(E("a").addClass("action-button download-image-button").attr("download",t.split("/")[1]).attr("title","Download").attr("href",stashURL+t).on("click",t=>{t.stopPropagation()}).on("contextmenu",t=>{t.stopPropagation()})),t.match(/\.png$/)&&s.append(E("div").addClass("action-button fullscreen-button").attr("title","Fullscreen").on("click",e=>{stash.fullscreenImage(stashURL+t),e.stopPropagation(),e.preventDefault()})),tippy(s.find(".action-button").toArray(),{arrow:!0,animation:"perspective",performance:!0}),e}function lerp(t,e,a){return e*a+t*(1-a)}function getURLParams(t){let e=t;if(e||(e=location.search),e.length<2)return null;let a,s={};for(;a=rgxURLParams.exec(e);)s[a[1]]=!a[2]||decodeURIComponent(a[2].replace(/\+/g,"%20"));return s}function toURLParams(t){let e=[];for(let a in t)if(t.hasOwnProperty(a)&&null!=t[a])if(!0===t[a])e.push(`${0==e.length?"?":"&"}${a}`);else{let s=encodeURIComponent(t[a]).replace(/%3A/g,":").replace(/%3B/g,";").replace(/%20/g,"+").replace(/%2C/g,",").replace(/%2F/g,"/").replace(/%40/g,"@");e.push(`${0==e.length?"?":"&"}${a}=${s}`)}return e.join("")}function formatNum(t,e){let a=t;if("undefined"!=typeof Intl&&void 0!==Intl.NumberFormat&&(a=(new Intl.NumberFormat).format(t)),!e)return a;const s=t%10,n=t%100;return 1==s&&11!=n?a+"st":2==s&&12!=n?a+"nd":3==s&&13!=n?a+"rd":a+"th"}function formatBytes(t){if(0==t)return"0 B";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(1))+" "+["B","KB","MB","GB","TB"][e]}function formatDate(t){const e=new Date(1e3*t);return months[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()}function naturalSorter(t,e){let a,s,n,i,o,r,l=0,c=/(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;if(t===e)return 0;for(a=t.toLowerCase().match(c),s=e.toLowerCase().match(c),r=a.length;l<r;){if(!s[l])return 1;if(n=a[l],i=s[l++],n!==i)return o=n-i,isNaN(o)?n>i?1:-1:o}return s[l]?-1:0}function hexToRgb(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(t,e,a,s)=>e+e+a+a+s+s);let e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:null}function rgbToLab(t){let e,a,s,n=t[0]/255,i=t[1]/255,o=t[2]/255;return n=n>.04045?Math.pow((n+.055)/1.055,2.4):n/12.92,i=i>.04045?Math.pow((i+.055)/1.055,2.4):i/12.92,o=o>.04045?Math.pow((o+.055)/1.055,2.4):o/12.92,e=(.4124*n+.3576*i+.1805*o)/.95047,a=(.2126*n+.7152*i+.0722*o)/1,s=(.0193*n+.1192*i+.9505*o)/1.08883,e=e>.008856?Math.pow(e,1/3):7.787*e+16/116,a=a>.008856?Math.pow(a,1/3):7.787*a+16/116,s=s>.008856?Math.pow(s,1/3):7.787*s+16/116,[116*a-16,500*(e-a),200*(a-s)]}function deltaE(t,e){const a=t[0]-e[0],s=t[1]-e[1],n=t[2]-e[2],i=Math.sqrt(t[1]*t[1]+t[2]*t[2]),o=i-Math.sqrt(e[1]*e[1]+e[2]*e[2]);let r=s*s+n*n-o*o;const l=a/1,c=o/(1+.045*i),d=(r=r<0?0:Math.sqrt(r))/(1+.015*i),h=l*l+c*c+d*d;return h<0?0:Math.sqrt(h)}var CCInput=null;(()=>{const t=new Event("change");CCInput=((t,e)=>(t.each((t,o)=>{o.ccinput=e,o.ccinput.lists=o.ccinput.lists||[];const r=$(o).addClass("ccin-wrapper ccin-menu-hidden").on("focusout",t=>n(o,t));o.ccinput.select?(r.attr("data-type","select").append(E("div").attr("tabindex",0).addClass("ccin-select").on("keydown",t=>s(o,t)).on("focus",t=>i(o,t)),E("span").addClass("ccin-ph"),E("ul").addClass("ccin-menu ccin-menu-empty").attr("tabindex",0)),o.val=(t=>{if(void 0===t)return r.attr("data-value");{const e=o.ccinput.lists.map(t=>"function"==typeof t?t():t).find(e=>e.list.find(e=>e.value==t));if(!e)throw"Invalid value.";r.attr("data-value",t),r.children(".ccin-select").html(e.list.find(e=>e.value==t).name)}}),o.ccinput.lists.map(t=>"function"==typeof t?t():t).find(t=>{const e=t.list.find(t=>t.selected);if(e)return r.attr("data-value",e.value),r.children(".ccin-select").html(e.name),!0})):r.attr("data-type","text").append(E("input").attr("type","text").attr("title"," ").attr("spellcheck","false").addClass("ccin-input").prop("required",!0).on("input",t=>a(o,t)).on("keydown",t=>s(o,t)).on("focus",t=>i(o,t)),E("span").addClass("ccin-ph"),E("ul").addClass("ccin-menu ccin-menu-empty").attr("tabindex",0)),e.placeholder&&("function"==typeof e.placeholder.then?e.placeholder.then(t=>r.children(".ccin-ph").append(t)):r.children(".ccin-ph").append(e.placeholder))}),t));const e=t=>{const e=$(t).children(".ccin-input"),a="function"==typeof t.ccinput.value?t.ccinput.value(e.val()):e.val(),s=$(t).children(".ccin-menu").empty();if(a.length<1)return s.addClass("ccin-menu-empty"),void $(t).addClass("ccin-menu-hidden");s.removeClass("ccin-menu-empty"),$(t).removeClass("ccin-menu-hidden");const n=a.toLowerCase(),i=new RegExp(`(${a})`,"gi");t.ccinput.lists.map(t=>({name:t.name,list:("function"==typeof t.list?t.list():t.list).filter(t=>t.match(i)).sort((t,e)=>{return t.toLowerCase().indexOf(n)-e.toLowerCase().indexOf(n)||e.match(i).length-t.match(i).length})})).filter(t=>t.list.length).map(t=>$.extend({score:t.list[0].toLowerCase().indexOf(n)},t)).sort((t,e)=>t.score-e.score).forEach(e=>{s.append(E("li").addClass("ccin-menu-group").html(e.name),e.list.map(a=>E("li").addClass("ccin-menu-item").html(a.replace(i,"<mark>$1</mark>")).attr("data-category",e.name).attr("data-value",a).on("click",e=>r(t,e.currentTarget))))}),s.children(".ccin-menu-item").first().addClass("ccin-selected-item")},a=(t,a)=>{0!=t.ccinput.lists.length&&e(t)},s=(t,e)=>{if(27===e.which)return $(t).children(".ccin-menu").addClass("ccin-menu-empty").empty(),$(t).addClass("ccin-menu-hidden").off("click",o),!0;if(13===e.which&&"function"==typeof t.ccinput.enter&&0==$(t).children(".ccin-menu").children(".ccin-selected-item").length)return t.ccinput.enter($(t).children(".ccin-input").val(),e),!0;if($(t).children(".ccin-menu").is(".ccin-menu-empty"))return!0;if(40===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.nextAll(".ccin-menu-item").length>0&&(a.removeClass("ccin-selected-item").nextAll(".ccin-menu-item").first().addClass("ccin-selected-item"),scrollIntoView(a[0],{behavior:"instant"})),e.preventDefault()}else if(38===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.prevAll(".ccin-menu-item").length>0&&(a.removeClass("ccin-selected-item").prevAll(".ccin-menu-item").first().addClass("ccin-selected-item"),scrollIntoView(a[0],{behavior:"instant"})),e.preventDefault()}else if(9===e.which||13===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.length&&(r(t,a[0]),e.preventDefault())}},n=(t,e)=>{$(t).is(":focus-within")||($(t).children(".ccin-menu").addClass("ccin-menu-empty").empty(),$(t).addClass("ccin-menu-hidden").off("click",o))},i=(t,a)=>{if(t.ccinput.select){const e=$(t).children(".ccin-menu").removeClass("ccin-menu-empty").empty();t.ccinput.lists.map(t=>"function"==typeof t.list?{name:t.name,list:t.list()}:t).sort((t,e)=>naturalSorter(t.name,e.name)).forEach(a=>{e.append(E("li").addClass("ccin-menu-group").html(a.name),a.list.map(e=>E("li").addClass("ccin-menu-item").html(e.name).attr("data-category",a.name).attr("data-value",e.value).attr("data-name",e.name).on("click",e=>r(t,e.currentTarget))))}),$(t).attr("data-value")?e.children(`.ccin-menu-item[data-value=${$(t).attr("data-value")}]`).first().addClass("ccin-selected-item"):e.children(".ccin-menu-item").first().addClass("ccin-selected-item"),$(t).removeClass("ccin-menu-hidden").on("mouseup",()=>setTimeout(()=>$(t).off("mouseup").on("click",o),100))}else!t.ccinput.refocusing&&t.ccinput.lists.length>0&&$(t).children(".ccin-input").val().length>0?e(t):t.ccinput.refocusing||"function"!=typeof t.ccinput.hint||($(t).children(".ccin-menu").removeClass("ccin-menu-empty").empty().append(E("div").addClass("ccin-menu-hint").append(t.ccinput.hint())),$(t).removeClass("ccin-menu-hidden"));t.ccinput.refocusing=!1},o=t=>{$(t.currentTarget).children(".ccin-select").blur(),$(t.currentTarget).children(".ccin-menu").empty(),$(t.currentTarget).addClass("ccin-menu-hidden").off("click",o)},r=(e,a)=>{if(e.ccinput.select)$(e).children(".ccin-select").html($(a).attr("data-name")).blur(),$(e).attr("data-value",$(a).attr("data-value")),$(e).children(".ccin-menu").empty().addClass("ccin-menu-empty"),$(e).addClass("ccin-menu-hidden").off("click",o),e.dispatchEvent(t);else{const t=$(e).children(".ccin-input");t.val("function"==typeof e.ccinput.replace?e.ccinput.replace(t.val(),$(a).attr("data-value"),$(a).attr("data-category")):$(a).attr("data-value")),$(e).children(".ccin-menu").empty().addClass("ccin-menu-empty"),$(e).addClass("ccin-menu-hidden"),e.ccinput.refocusing=!0,t.focus()}}})();const legacyTimeData=[{time:1312051806,id:0},{time:1314221974,id:1e3},{time:1317388666,id:2e3},{time:1319090950,id:3e3},{time:1323408627,id:4e3},{time:1327695347,id:5e3},{time:1332070004,id:6e3},{time:1335737826,id:7e3},{time:1339451376,id:8e3},{time:1346105014,id:9e3},{time:1354211287,id:1e4},{time:1361130865,id:11e3},{time:1366174956,id:12e3},{time:1368929856,id:13e3},{time:1372727962,id:14e3},{time:1378402172,id:15e3},{time:1389405209,id:16e3},{time:1402541195,id:17e3},{time:1414832158,id:18e3},{time:1451429522,id:19e3},{time:1460483638,id:19160},{time:1460536130,id:19348},{time:1463713609,id:19398},{time:1464735265,id:19404},{time:1465704958,id:19415},{time:1469905303,id:19433},{time:1470202364,id:19444},{time:1478645533,id:19693},{time:1500235159,id:20122},{time:1512422195,id:20145}];class MCAnimation{constructor(t,e){this.texture=new Image,this.texture.src=t,this.mcmeta="object"==typeof e?e:{animation:{}},this.mcmeta.animation||(this.mcmeta.animation={}),this.canvas=document.createElement("canvas"),this.canvas.className="mc-animation",this.context=this.canvas.getContext("2d"),this.frames=[],this.currentFrame=0,this.ticks=0,this.texture.addEventListener("load",()=>this.init())}init(){this.canvas.width=this.texture.width,this.canvas.height=this.texture.width;let t=Math.max(this.mcmeta.animation.frametime||1,1);if(Array.isArray(this.mcmeta.animation.frames)&&this.mcmeta.animation.frames.length>0){this.mcmeta.animation.interpolate||this.mcmeta.animation.frames.find(e=>"object"==typeof e&&e.time%t!=0)?this.interval=1:this.interval=t;for(let e=0;e<this.mcmeta.animation.frames.length;e++){const a=this.mcmeta.animation.frames[e];"number"==typeof a?this.frames.push({index:a,duration:t/this.interval}):this.frames.push({index:a.index,duration:Math.max(a.time,1)/this.interval})}}else{this.mcmeta.animation.interpolate?this.interval=1:this.interval=t;let e=this.texture.height/this.texture.width;for(let a=0;a<e;a++)this.frames.push({index:a,duration:t/this.interval})}this.draw(),this.play()}draw(t=0,e=0){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.imageSmoothingEnabled=this.texture.width>this.canvas.width,this.context.globalAlpha=1,this.context.drawImage(this.texture,0,this.texture.width*this.frames[t].index,this.texture.width,this.texture.width,0,0,this.canvas.width,this.canvas.height),this.mcmeta.animation.interpolate&&(this.context.globalAlpha=e/this.frames[t].duration,this.context.drawImage(this.texture,0,this.texture.width*this.frames[(t+1)%this.frames.length].index,this.texture.width,this.texture.width,0,0,this.canvas.width,this.canvas.height))}update(){this.frames[this.currentFrame].duration<=++this.ticks?(this.currentFrame=(this.currentFrame+1)%this.frames.length,this.ticks=0,this.draw(this.currentFrame,this.ticks),"function"==typeof this.onNewFrame&&this.onNewFrame()):this.mcmeta.animation.interpolate&&this.draw(this.currentFrame,this.ticks)}play(){this.frames.length>1?this.timer=setInterval(()=>{window.requestAnimationFrame(()=>this.update())},50*this.interval):window.requestAnimationFrame(()=>this.draw()),this.canvas.classList.add("playing")}pause(){this.timer&&(clearInterval(this.timer),this.timer=null),this.canvas.classList.remove("playing")}stop(){this.pause(),this.currentFrame=0,this.canvas.classList.remove("playing")}get frameIndex(){return this.frames.length>0?this.frames[this.currentFrame].index:0}get playing(){return null!=this.timer}}const stashURL="https://dokucraft.co.uk/stash-files/",thumbnails="/stash/resources/thumbnails/",contentData="/stash/resources/content-data/",cors="https://cors-anywhere.herokuapp.com/",cloudFunctions="https://us-central1-dokucraft-stash.cloudfunctions.net/api",pages=["search","about","contributors","profile","details","submit","help","status"],months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],opTime=1312035589,rgxSize=/^\s*([<>]?=|[<>])?\s*(\d+)(\s*x\s*(\d+))?\s*$/,rgxContributor=/(.+)_\d+/,rgxID=/.+_(\d+)/,rgxExt=/\.([^.]*)$/,rgxURLParams=/(?:^\?|&)([A-z0-9]+)(?:=([^&]+)|(?=&)|$)/g,rgxValidTag=/^[a-z0-9][a-z0-9-]+[a-z0-9]$/,rgxInvalidTag=/^[0-9][0-9-]+[0-9]$/;tippy.defaults.arrow=!0,tippy.defaults.animation="perspective",tippy.defaults.performance=!0,tippy.defaults.delay=200,tippy.defaults.popperOptions={modifiers:{preventOverflow:{enabled:!1},hide:{enabled:!1}}};const bLazy=new Blazy({success:t=>{if($(t).is("img.animated")&&!$(t).parent().attr("data-animation-done"))if($(t).parent().attr("data-animation-done",!0),$(t).parent().is(".mcmeta"))$.ajax({url:t.src+".mcmeta",success:e=>{let a=new MCAnimation(t.src,JSON.parse(e));stash.animations.push(a),$(t).parent().removeClass("no-thumbnail"),$(t).hide().after(a.canvas),$(t).siblings(".thumbnail").remove()}});else{let e=new MCAnimation(t.src);stash.animations.push(e),$(t).parent().removeClass("no-thumbnail"),$(t).hide().after(e.canvas),$(t).siblings(".thumbnail").remove()}}});var stash={data:{},contributors:[],page:{},cache:{},displayOptions:{grouping:"none",sorting:"id",order:"des",scale:1},animations:[],files:[],selection:{files:[]},typeNames:{model:"Model",ctm:"CTM",cit:"CIT",set:"Texture set"},firebase:{auth:firebase.auth(),db:firebase.firestore()},loadingHint:E("div").addClass("hint").text("Loading...")[0]};stash.firebase.db.settings({timestampsInSnapshots:!0}),$(window).on("popstate",onPageLoad),stash.getZIPContent=((t,e=(t=>t.match(/\.png$/)?"base64":"text"))=>stash.cache.zipContent&&stash.cache.zipContent.file==t?Promise.resolve(stash.cache.zipContent.content):$.ajax(stashURL+t,{xhrFields:{responseType:"blob"}}).then(t=>JSZip.loadAsync(t)).then(t=>Promise.all(Object.keys(t.files).filter(e=>!t.files[e].dir).map(a=>t.file(a).async(e(a)).then(e=>({path:a.split("/").slice(0,-1).join("/"),name:a.split("/").pop(),content:e,size:t.files[a]._data.uncompressedSize}))))).then(e=>(stash.cache.zipContent={file:t,content:e},e)).catch(e=>(stash.notify(`Failed to load file: ${t}<br>(${e.status} ${e.statusText})`,null,"error"),Promise.reject(e)))),stash.getImage=(t=>new Promise((e,a)=>{const s=new Image;s.onload=(()=>e(s)),s.onerror=(()=>a(s)),s.src=t})),stash.blockInput=((t,e=!0)=>{removeAllTooltips();const a=E("div").addClass("fullscreen-blocker "+(t||"")).appendTo($("body")).animate({opacity:1},500);return e&&a.attr("tabindex",1).focus().on("keyup",t=>{27===t.which&&stash.removeInputBlocker(a)}),a}),stash.removeInputBlocker=(t=>new Promise(e=>{t.addClass("fading").stop().animate({opacity:0},250,()=>{t.remove(),e()})})),stash.fullscreenImage=(t=>stash.blockInput().append(E("div").addClass("fs-img-container").append(E("div").addClass("img b-lazy").attr("data-src",t))).on("click",function(){stash.removeInputBlocker($(this))})),stash.search=((t,e=stash.files)=>{if(!t)return[];const a="string"==typeof t?stash.query.parse(t):t;return a?e.filter(t=>stash.query.match(a,t)):[]}),stash.setWorkProgress=(t=>{const e=Math.floor(100*t)||stash.cache.workProgress;stash.cache.workProgress=e,$("#work-progress-bar").removeClass("indeterminate").stop().animate({width:t+"%"},250)}),stash.workIndeterminate=(()=>{$("#work-progress-bar").addClass("indeterminate").stop()}),stash.workError=(t=>{stash.cache.workProgress;$("#work-progress-bar").css("background-color","#f58"),$("#work-progress-bar").is(".indeterminate")&&$("#work-progress-bar").removeClass("indeterminate").css("width","100%"),setTimeout(()=>{$("#work-progress-bar").stop().animate({width:0},500,()=>$("#work-progress-bar").css("background-color","#58f")),"function"==typeof t&&t()},3500)}),stash.workComplete=(()=>{stash.page.hasWork=!1,stash.cache.workProgress=0,$("#work-progress-bar").is(".indeterminate")?$("#work-progress-bar").stop().removeClass("indeterminate").css("width","100%").animate({height:0},500,()=>$("#work-progress-bar").css("width",0).css("height","4px")):$("#work-progress-bar").stop().animate({height:0,width:"100%"},500,()=>$("#work-progress-bar").css("width",0).css("height","4px"))}),stash.cleanUpAnimations=(()=>{stash.animations.filter(t=>!$.contains(document.body,t.canvas)).forEach(t=>t.stop()),stash.animations=stash.animations.filter(t=>t.timer)}),stash.anchor=(t=>{const e=toURLParams(t);return E("a").attr("href",e).on("click",t=>{stash.page.load(e),t.preventDefault()})}),stash.modalAnchor=((t,e)=>{const a=toURLParams(t);return E("a").attr("href",a).on("click",t=>{stash.page.modal(a,e),t.preventDefault()})}),stash.getFirebaseUser=(t=>{const e=stash.firebase.auth.onAuthStateChanged(a=>{e(),"function"==typeof t&&t(a)})}),$(()=>{const t=[$.getJSON("/stash/data.json"),$.getJSON("/stash/shortcuts.json"),$.getJSON("/stash/alias-tags.json")];Promise.all(t).then(t=>{stash.files=Object.keys(t[0]),stash.shortcuts=t[1];const e=["V","LV","DV","M","LM","DM"],a=new Set;let s=0;if(stash.files.forEach(n=>{const i=getID(n),o={};if(t[0][n].P.forEach((t,a)=>{0!==t&&(o[e[a]]=hexToRgb(t))}),stash.data[n]={id:i,contributor:getContributor(n),ext:getExt(n),colors:o,size:t[0][n].S,mcmeta:t[0][n].M,timestamp:t[0][n].D||getApproxTime(i),tags:{official:(t[0][n].T||"").split(",").filter(t=>t.length>=2).sort(naturalSorter),user:null,implicit:new Set}},stash.data[n].date=new Date(1e3*stash.data[n].timestamp),t[0][n].Z)stash.data[n].tags.implicit.add("zip"),stash.data[n].tags.implicit.add("set"==stash.data[n].Z?"texture-set":stash.data[n].Z),stash.data[n].packageType=t[0][n].Z;else{stash.data[n].tags.implicit.add("image");const e=t[0][n].S;t[0][n].M?(stash.data[n].tags.implicit.add("mcmeta"),stash.data[n].tags.implicit.add("animated")):e[1]/e[0]>=6&&e[1]%e[0]==0&&stash.data[n].tags.implicit.add("animated")}stash.tags.checkDynamicImplicits(n),a.add(stash.data[n].contributor),s=Math.max(s,i)}),stash.files.sort((t,e)=>stash.data[t].id-stash.data[e].id),stash.files.slice(-250).forEach(t=>{stash.data[t].tags.implicit.add("latest")}),Object.keys(t[2]).forEach(e=>{stash.tags.alias[e]=stash.query.parse(`"${e}"|(${t[2][e]})`)}),stash.tags.updateNames(),stash.contributors=Array.from(a).sort(naturalSorter),null!=localStorage.getItem("stash-max-id")){let t=parseInt(localStorage.getItem("stash-max-id"));if(s>t){const e={search:t+1+"-"+s},a=stash.search(e.search);stash.notify(`${a.length>1?a.length:"A"} new file${a.length>1?"s":""} has been added to the stash.`,[{text:"View",func:()=>{stash.page.load(toURLParams(e))}}]),localStorage.setItem("stash-max-id",s)}}else localStorage.setItem("stash-max-id",s);const n=/(^|[!@\(\) |])([A-z0-9_-]+|"[A-z0-9_ -]+"?)$/;CCInput($("#searchbar"),{placeholder:new Promise(t=>$.get("/stash/resources/search.svg",e=>t(e+" Search..."),"text")),lists:[{name:"Tags",list:()=>stash.tags.names.all},{name:"Contributors",list:stash.contributors}],value:t=>{const e=t.match(n);return e?e[2]:""},replace:(t,e,a)=>t.replace(n,(s,n,i,o)=>("@"!==n&&"Contributors"===a&&"@"!==t.substring(o-1,o)?(n.length?n:"")+"@":n)+(~e.indexOf(" ")?'"'+e+'"':e)),enter:(t,e)=>{t.length&&(stash.page.load(toURLParams({search:t})),$(e.currentTarget).blur())},hint:()=>[E("h4").text("Search"),E("p").append("Search for files by entering one or more tags that may apply to them. For example, ",stash.anchor({search:"diamond sword"}).append(E("code").text("diamond sword")).on("click",()=>$("#searchbar *").blur())," will show all diamond swords in the stash."),E("p").html("You can search for files made by a specific contributor by adding <code>@</code> before their name."),E("br"),E("p").text("For in-depth information about searching, check out the full guide by clicking the button below."),E("br"),E("div").addClass("inline button").text("Search Guide").on("click",()=>{$("#searchbar *").blur(),stash.page.modal(toURLParams({help:"searching"}))})]}),$("#search-button").on("click",()=>{const t=$("#searchbar input").val();t.length&&stash.page.load(toURLParams({search:t}))}),$("#login-button").on("click",()=>{const t=new firebase.auth.GithubAuthProvider;t.addScope("public_repo"),stash.firebase.auth.signInWithPopup(t).then(t=>{localStorage.setItem("gh-login-token",t.credential.accessToken)}).catch(function(t){localStorage.removeItem("gh-login-token"),stash.notify("Failed to log in:"+t.message,null,"error")})}),$("#signout-button").on("click",()=>{stash.firebase.auth.signOut()}),stash.selection.loadStored(),getURLParams()?stash.userTagsLoaded.then(onPageLoad):onPageLoad()}),$("body").on("touchend",t=>{$(t.target).is(".menu-title")?$(".menu.touch-open").not($(t.target).find(".menu")).removeClass("touch-open"):$(".menu.touch-open").removeClass("touch-open")});const e=t=>e=>{const a=$(e.currentTarget),s=a.find(".menu").addClass(t||"").css("left",a[0].getBoundingClientRect().left),n=s[0].getBoundingClientRect(),i=document.documentElement.clientWidth;n.right>i&&s.css({left:"auto",right:0})};$(".menu-title").on("mouseenter",e()),$(".menu-title").on("touchend",t=>e("touch-open")),stash.page.optimizeScrolling($("#content-scroller"));let a=()=>{setTimeout(()=>{bLazy.revalidate(),a()},500)};a(),stash.userTagsLoaded=new Promise(t=>{stash.firebase.auth.onAuthStateChanged(e=>{if(e){$(".when-logged-in").removeClass("hidden"),$(".when-not-logged-in").addClass("hidden"),stash.github=new GitHub({token:localStorage.getItem("gh-login-token")}),new Promise(t=>{e.displayName?t(e.displayName):stash.github.getUser().getProfile((a,s)=>{t(a?e.email:s.login)})}).then(t=>{$("#user-name").empty().append(E("img").attr("id","user-image").attr("src",e.photoURL),t)});const a=stash.notify("Loading user tags...","working");stash.firebase.db.collection("users").doc(e.uid).get().then(e=>{const s=e.get("tags");s&&(stash.files.forEach(t=>{const e=stash.data[t].id;stash.data[t].tags.user=s[e]?s[e].split(",").filter(t=>t.length>=2).sort(naturalSorter):null,stash.data[t].tags.user&&stash.tags.checkDynamicImplicits(t)}),stash.tags.updateNames(),stash.tags.updateElements()),stash.dismissNotification(a),t()}).catch(e=>{stash.dismissNotification(a),stash.notify("An error occurred while trying to load user tags",null,"error"),t()})}else localStorage.getItem("gh-login-token")&&($(".stash-page-content").each((t,e)=>"function"==typeof e.onUserLogout&&e.onUserLogout()),stash.notify("You have been signed out")),localStorage.removeItem("gh-login-token"),stash.github=null,stash.files.forEach(t=>{stash.data[t].tags.user=null,stash.tags.checkDynamicImplicits(t)}),stash.tags.updateNames(),stash.tags.updateElements(),$(".when-not-logged-in").removeClass("hidden"),$(".when-logged-in").addClass("hidden"),t()})})}),stash.chart={},$(()=>{stash.chart.timeline=(()=>{const t={maintainAspectRatio:!1,legend:{display:!1},tooltips:{bodyFontSize:16,footerFontSize:0,callbacks:{label:t=>"    "+t.yLabel,title:()=>"",footer:()=>" "},custom:t=>{t&&(t.displayColors=!1)}}},e=$("#title svg").css("fill"),a=e.replace(/rgb\(([^)]+)\)/,(t,e)=>`rgba(${e},0.2)`),s=$("#header-bar .menu-group").css("color"),n=$("#header-bar").css("border-bottom-color");return(i,...o)=>{let r=1/0,l=-1/0;const c={};for(let t=0;t<i.length;t++){const e=i[t],a=stash.data[e].timestamp;r=Math.min(r,a),l=Math.max(l,a);const s=stash.data[e].date,n=s.getFullYear()+" Q"+Math.floor((s.getMonth()+3)/3);(c[n]=c[n]||[]).push(e)}const d=new Date(1e3*r),h=new Date(1e3*l),p=d.getFullYear(),m=h.getFullYear();for(let t=d.getFullYear();t<=m;t++){const e=t!=p?1:Math.floor((d.getMonth()+3)/3),a=t!=m?4:Math.floor((h.getMonth()+3)/3);for(let s=e;s<=a;s++)c[t+" Q"+s]=c[t+" Q"+s]||[]}const u=Object.keys(c);u.sort(naturalSorter);const g=i=>{const o=E("canvas");return setTimeout(()=>new Chart(o,{type:"line",options:$.extend({},t,{title:{display:!0,fontColor:s,text:i.title},scales:{xAxes:[{id:"xAxis1",gridLines:{display:!1},ticks:{fontColor:s,callback:t=>t.split(" ")[1]}},{id:"xAxis2",gridLines:{display:!1},ticks:{fontColor:s,callback:t=>~t.indexOf("Q1")||0==u.indexOf(t)?t.split(" ")[0]:""}}],yAxes:[{gridLines:{color:n},ticks:{fontColor:s,beginAtZero:!0,suggestedMax:i.maxValue}}]}}),data:{labels:u,datasets:[{data:i.dataHandler(u,c),xAxisID:"xAxis1",backgroundColor:a,borderColor:e,pointHoverBorderColor:"#fff",borderWidth:2,pointRadius:5,lineTension:0}]}}),100),E("div").addClass("chart").append(o)};return"string"==typeof o[0]?g({title:o[0],dataHandler:o[2],maxValue:o[3]}):o.map(g)}})()}),stash.dismissNotification=(t=>{const e=t.outerHeight();t.prevAll(".notification").animate({bottom:`-=${e+20}px`},250),t.is(":animated")?setTimeout(()=>t.animate({right:"-800px"},250,()=>t.remove()),500):t.animate({right:"-800px"},250,()=>t.remove())}),stash.notify=((t,e,a)=>{const s=E("div").addClass("notification").append(E("div").addClass("notification-content").html(t)),n=E("div").addClass("button-row");"string"==typeof a&&s.addClass(a),Array.isArray(e)&&e.forEach(t=>{n.append(E("div").addClass("button inline").text(t.text).on("click",()=>{"function"==typeof t.func&&t.func(),stash.dismissNotification(s)}))}),"working"===e?(E("div").addClass("spinner").appendTo(s).load("/stash/resources/dokucraft.svg"),s.addClass("working")):(n.append(E("div").addClass("button inline").text("Dismiss").on("click",t=>{stash.dismissNotification(s)})),s.append(n)),s.appendTo($("body"));const i=s.outerHeight();return $(".notification").not(s).animate({bottom:`+=${i+20}px`},250),s.animate({right:"60px"},250),s}),stash.page.load=((t,e,a)=>new Promise(s=>{if(null!=a&&a.preventDefault(),null!=getURLParams()&&getURLParams().hasOwnProperty(t))return;stash.workIndeterminate();let n=e;if(n||(n=$("#content")),stash.page.closeModal(n.closest(".stash-page-wrapper").find(".modal")),"function"==typeof n[0].onUnload&&(n[0].onUnload(),n[0].onUnload=null),n[0].onUserLogout=null,n[0].onTagsUpdate=null,"root"==t)e||history.pushState(null,"","/stash/"),n.empty().append(stash.loadingHint).load("pages/shortcuts.html",()=>s(n));else if(t.match(/^\?/)){const a=getURLParams(t);let i=null;for(let t=0;t<pages.length;t++)if(a.hasOwnProperty(pages[t])){i=pages[t];break}e?n.attr("data-params",t):history.pushState(null,"",t),n.empty().append(stash.loadingHint).load(`pages/${i}.html`,()=>s(n))}else{const a={};a[t]=!0,e?n.attr("data-params",toURLParams(a)):history.pushState(null,"",toURLParams(a)),n.empty().append(stash.loadingHint).load(`pages/${t}.html`,()=>s(n))}}).then(t=>(removeAllTooltips(),stash.cleanUpAnimations(),e||$("#searchbar input").val(""),stash.page.loaded(t.closest(".stash-page-wrapper>*")),t))),stash.page.identifier=(()=>new Promise(t=>{stash.page.identifierLoaded=(e=>{stash.page.identifierLoaded=null;const a=$(e).parent();$(e).remove(),t(a)})})),stash.page.loaded=(t=>{requestAnimationFrame(()=>{t.css("opacity",0).animate({opacity:1},500),stash.page.hasWork||stash.workComplete()})}),stash.page.optimizeScrolling=(t=>t.on("scroll",()=>{for(const t of document.querySelectorAll(".tippy-popper")){const e=t._tippy;e.state.visible&&(e.popperInstance.disableEventListeners(),e.hide())}})),stash.page.modal=((t,e="#content-wrapper")=>{if(removeAllTooltips(),t){const a=E("div").addClass("modal").appendTo(e).append(E("div").addClass("content stash-page-wrapper").append(stash.page.optimizeScrolling(E("div").addClass("stash-page-scroller").append(E("div").addClass("stash-page-content"))))).on("click",t=>{t.target==t.currentTarget&&stash.page.closeModal($(t.target))});return stash.page.load(t,a.find(".stash-page-content")).then(()=>{setTimeout(()=>a.addClass("open"),100);const e=E("div").addClass("go-to-page-button").attr("title","Go to page").on("click",()=>stash.page.load(t)).html($("#open-page-icon").html()).appendTo(a.find(".stash-page-wrapper"));tippy(e[0],{placement:"right"})}),a}return E("div").addClass("modal open").appendTo(e).append(E("div").addClass("content")).on("click",t=>{t.target==t.currentTarget&&stash.page.closeModal($(t.target))})}),stash.page.closeModal=(t=>new Promise(e=>{t.addClass("fading"),setTimeout(()=>{t.find(".stash-page-content").each((t,e)=>{"function"==typeof e.onUnload&&e.onUnload()}),t.remove(),stash.cleanUpAnimations(),e(t)},250)})),stash.page.requireLogin=(t=>new Promise((e,a)=>{t.is("#content")?t[0].onUserLogout=(()=>stash.page.load("root")):t[0].onUserLogout=(()=>stash.page.closeModal(t.closest("modal"))),stash.getFirebaseUser(s=>{s?e(t):a()})})),(()=>{const t=/\(([^\(\)]*)\)/g,e=/^w([<>]?=|[<>])(\d+)$/,a=/^h([<>]?=|[<>])(\d+)$/,s=/^([<>]?=|[<>])?(\d+):(\d+)$/,n=/^([<>]=|[<>])\{(.+)\}$/,i=/^(?:([<>]?=|[<>])(\d+)|(\d+)(?:-(\d+))?)$/,o=/([^\s\|!])([!@])/g,r=/^"([a-z0-9][a-z0-9-]+[a-z0-9])"$/,l=/\s(?=(?:(?:[^"]*"){2})*[^"]*$)(?![^\{\}]*\})/g,c=/\.png$/,d=/\s+\|\s+|\s+\||\|\s+/g,h=/!\s+/g;stash.query={};const p=(t,c)=>{if(t.match(o))return p(t.replace(o,(t,e,a)=>e+" "+a),c);if(t.match(h))return p(t.replace(h,"!"),c);if(t.match(d))return p(t.replace(d,"|"),c);if(t.match(l))return{op:"AND",cons:t.split(l).filter(t=>t.length).map(t=>p(t,c)).filter(t=>t)};if(~t.indexOf("|"))return{op:"OR",cons:t.split("|").map(t=>t.trim()).filter(t=>t.length).map(t=>p(t,c)).filter(t=>t)};if(0===t.indexOf("!")){const e=p(t.substring(1),c);return e?{op:"NOT",con:e}:null}if(0===t.indexOf("ยง"))return p(c[t.substring(1)],c);if(0===t.indexOf("@"))return{type:"contributor",name:t.substring(1).replace(/"/g,"")};if(t.match(i)){const e=t.match(i);return e[4]?{type:"id",range:[parseInt(e[3]),parseInt(e[4])]}:{type:"id",op:e[1]||"=",id:parseInt(e[2]||e[3])}}if(t.match(e)){const a=t.match(e);return{type:"width",op:a[1],value:parseInt(a[2])}}if(t.match(a)){const e=t.match(a);return{type:"height",op:e[1],value:parseInt(e[2])}}if(t.match(s)){const e=t.match(s);return{type:"aspect-ratio",op:e[1]||"=",value:parseInt(e[2])/parseInt(e[3]),x:parseInt(e[2]),y:parseInt(e[3])}}if(t.match(n)){const e=t.match(n);return{type:"date",op:e[1],date:new Date(e[2]),dateString:e[2]}}if(t.match(r)){return{type:"exact-tag",name:t.match(r)[1]}}return t.match(rgxValidTag)?t:null};stash.query.contributor=(t=>~t.indexOf(" ")?'@"'+t+'"':"@"+t),stash.query.toString=((t,e)=>"string"==typeof t||null==t?t:"AND"===t.op?(e?"(":"")+t.cons.map(t=>stash.query.toString(t,!0)).join(" ")+(e?")":""):"OR"===t.op?t.cons.map(t=>stash.query.toString(t,!0)).join("|"):"NOT"===t.op?"!"+stash.query.toString(t.con,!0):"contributor"===t.type?stash.query.contributor(t.name):"id"===t.type?(t.op&&"="!=t.op?t.op:"")+(t.range?t.range.join("-"):t.id):"width"===t.type?"w"+t.op+t.value:"height"===t.type?"h"+t.op+t.value:"aspect-ratio"===t.type?(t.op&&"="!=t.op?t.op:"")+t.x+":"+t.y:"date"===t.type?t.op+"{"+t.dateString+"}":"exact-tag"===t.type?`"${t.name}"`:void 0),stash.query.parse=(e=>{const a=[];let s=e;for(;s.match(t);)s=s.replace(t,(t,e)=>(a.push(e),` ยง${a.length-1} `));return p(s,a)}),stash.query.match=((t,e,a)=>{if(a||(a=stash.tags.of(e)),null==t)return!1;if("string"==typeof t)return~stash.tags.names.alias.indexOf(t)?stash.query.match(stash.tags.alias[t],e,a):null!=a.find(e=>t==e.name);if(t.type){if("exact-tag"===t.type)return null!=a.find(e=>t.name==e.name);if("contributor"===t.type)return t.name==stash.data[e].contributor;if("id"===t.type){if(t.range)return stash.data[e].id>=t.range[0]&&stash.data[e].id<=t.range[1];if("="===t.op)return stash.data[e].id==t.id;if("<"===t.op)return stash.data[e].id<t.id;if(">"===t.op)return stash.data[e].id>t.id;if("<="===t.op)return stash.data[e].id<=t.id;if(">="===t.op)return stash.data[e].id>=t.id}else if("width"===t.type&&e.match(c)){if("="===t.op)return stash.data[e].size[0]==t.value;if("<"===t.op)return stash.data[e].size[0]<t.value;if(">"===t.op)return stash.data[e].size[0]>t.value;if("<="===t.op)return stash.data[e].size[0]<=t.value;if(">="===t.op)return stash.data[e].size[0]>=t.value}else if("height"===t.type&&e.match(c)){if("="===t.op)return stash.data[e].size[1]==t.value;if("<"===t.op)return stash.data[e].size[1]<t.value;if(">"===t.op)return stash.data[e].size[1]>t.value;if("<="===t.op)return stash.data[e].size[1]<=t.value;if(">="===t.op)return stash.data[e].size[1]>=t.value}else if("aspect-ratio"===t.type&&e.match(c)){if("="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]==t.value;if("<"===t.op)return stash.data[e].size[0]/stash.data[e].size[1]<t.value;if(">"===t.op)return stash.data[e].size[0]/stash.data[e].size[1]>t.value;if("<="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]<=t.value;if(">="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]>=t.value}else if("date"===t.type){if("<"===t.op)return stash.data[e].date<t.date;if(">"===t.op)return stash.data[e].date>t.date;if("<="===t.op)return stash.data[e].date<=t.date;if(">="===t.op)return stash.data[e].date>=t.date}}else{if("AND"===t.op){for(let s=0;s<t.cons.length;s++)if(!stash.query.match(t.cons[s],e,a))return!1;return!0}if("OR"===t.op)return null!=t.cons.find(t=>stash.query.match(t,e,a));if("NOT"===t.op)return!stash.query.match(t.con,e,a)}return!1})})(),(()=>{function t(t){stash.page.closeModal($(".selection-required"));let e=stash.selection.files.length;if(e>0){$(".sp-search-wrapper .result").each((t,e)=>{let a=$(e).attr("data-file");stash.selection.contains(a)?$(e).addClass("selected"):$(e).removeClass("selected")});const a=stash.selection.toString();a.replace(/(.{50}).+/,(t,e)=>e?e+"...":t);t||localStorage.setItem("stash-selected-files",a),$("#selection-menu").removeClass("no-selection"),$("#selection-file-count").text(`${e} file${1===e?"":"s"}`),a.length>1900?$("#selection-copy-link-button").addClass("hidden"):($("#selection-link").val("https://dokucraft.co.uk/stash/"+toURLParams({search:a})),$("#selection-copy-link-button").removeClass("hidden"))}else t||localStorage.removeItem("stash-selected-files"),$("#selection-menu").addClass("no-selection"),$(".selected.file").removeClass("selected")}stash.selection.contains=(t=>~stash.selection.files.indexOf(t)),stash.selection.toString=(()=>stash.selection.files.map(t=>stash.data[t].id).sort().reduce((t,e)=>{if(0==t.length)return t.push([e]),t;const a=t[t.length-1];return a[a.length-1]==e-1?(a.push(e),t[t.length-1]=a.filter((t,e)=>0==e||e==a.length-1)):t.push([e]),t},[]).reduce((t,e,a)=>{const s=a>0?"|":"";return 1==e.length?t+=s+e[0]:t+=`${s}${e[0]}-${e[1]}`,t},"")),stash.selection.download=(()=>{const t=stash.notify("Working...","working"),e=stash.blockInput(null,!1);stash.workIndeterminate();const a=new JSZip,s=[];let n=stash.selection.files.slice();n=n.concat(n.filter(t=>stash.data[t].mcmeta&&t.match(/\.png$/)).map(t=>t+".mcmeta"));let i=0,o=!1;for(let r=0;r<n.length&&!o;r++)s.push($.ajax(stashURL+n[r],{xhrFields:{responseType:"blob"}}).done(t=>{a.file(n[r],t,{createFolders:!0}),stash.setWorkProgress(++i/n.length)}).fail(a=>{o=!0,s.forEach(t=>t.abort()),stash.dismissNotification(t),stash.removeInputBlocker(e),stash.workComplete(),stash.notify(`Failed to load file: ${n[r]}<br>(${a.status} ${a.statusText})`,null,"error")}));Promise.all(s).then(()=>{a.generateAsync({type:"blob"}).then(a=>{stash.dismissNotification(t),stash.removeInputBlocker(e),stash.workComplete(),saveAs(a,"dokustash.zip")})})}),stash.selection.loadStored=(()=>{localStorage.getItem("stash-selected-files")&&(stash.selection.files=stash.search(localStorage.getItem("stash-selected-files")),stash.selection.files.forEach(t=>stash.data[t].tags.implicit.add("selected")),t(!1))}),stash.selectFile=(e=>{stash.selection.contains(e)||(stash.selection.files.push(e),stash.data[e].tags.implicit.add("selected"),t())}),stash.selectFiles=(e=>{e.forEach(t=>{stash.selection.contains(t)||(stash.selection.files.push(t),stash.data[t].tags.implicit.add("selected"))}),t()}),stash.deselectFile=(e=>{let a=stash.selection.files.indexOf(e);a>-1&&(stash.selection.files.splice(a,1),stash.data[e].tags.implicit.delete("selected"),t())}),stash.deselectAllFiles=(()=>{stash.selection.files.forEach(t=>stash.data[t].tags.implicit.delete("selected")),stash.selection.files=[],t()}),$(()=>{$("#selection-deselect-all-button").on("click",stash.deselectAllFiles),$("#selection-download-button").on("click",stash.selection.download),$("#selection-copy-link-button").on("click",()=>{$("#selection-link").select(),document.execCommand("Copy")}),$("#selection-tags-button").on("click",()=>{if($(".common-tags-modal").length>0)return;const t={};stash.selection.files.forEach(e=>{t[e]=(stash.data[e].tags.user||stash.data[e].tags.official).slice()});const e=e=>{const a=$(e.currentTarget).attr("data-tag-name");stash.selection.files.forEach(e=>{t[e]=t[e].filter(t=>t!=a)}),$(e.currentTarget).remove()},a=a=>{a.split(" ").filter(t=>t.length&&stash.tags.isValid(t)&&!~stash.tags.names.implicit.indexOf(t)).forEach(a=>{stash.selection.files.forEach(e=>{~t[e].indexOf(a)||t[e].push(a)}),n.find(`[data-tag-name=${a}]`).length?n.find(`[data-tag-name=${a}]`).children(".count").text(stash.selection.files.length):n.find(".tags").append(E("span").addClass("tag with-count").append(a,E("span").addClass("count").text(stash.selection.files.length)).attr("data-tag-name",a).on("click",e))}),n.find(".tag-input input").val("")},s={};stash.selection.files.map(t=>stash.tags.of(t,!1)).reduce((t,e)=>t.concat(e),[]).forEach(t=>s[t.name]=(s[t.name]||0)+1);const n=stash.page.modal().addClass("selection-required selection-tag-editor");n.find(".content").css("width","800px").append(E("h2").text("Tags for selected files"),E("p").text("Below are all tags from the selected files and the number of times they occur. To add a tag to all of the selected files, type it into the field below and click Add. You can add multiple at once by separating each tag with a space. To remove a tag from all applicable files, click the tag in the list."),E("p").append(E("i").addClass("faded").text("Tags may only contain lower case letters, numbers or hyphens, and must not start or end with a hyphen. They must contain at least one lower case letter.")),E("br"),E("div").addClass("row").append(E("div").addClass("tag-input"),E("div").addClass("button add-button").text("Add")),E("br"),E("div").addClass("tags").append(Object.keys(s).sort((t,e)=>s[e]-s[t]).map(t=>E("span").addClass("tag with-count").append(t,E("span").addClass("count").text(s[t])).attr("data-tag-name",t).on("click",e))),E("br"),E("div").addClass("row").append(E("div").addClass("inline button").text("Cancel").on("click",t=>stash.page.closeModal(n)),E("div").addClass("inline button").text("Done").on("click",e=>{const a=[];if(stash.selection.files.forEach(e=>{t[e].sort(naturalSorter);const s=(stash.data[e].tags.user||stash.data[e].tags.official).slice();(s.length!=t[e].length||s.find(a=>!~t[e].indexOf(a))||t[e].find(t=>!~s.indexOf(t)))&&a.push({id:stash.data[e].id,tags:t[e].join(",")})}),a.length){const e=stash.notify("Validating tags...","working");stash.tags.updateUser(a).then(()=>{stash.selection.files.forEach(e=>{stash.data[e].tags.user=t[e],stash.tags.checkDynamicImplicits(e)}),stash.page.closeModal(n),stash.tags.updateNames(),stash.tags.updateElements()}).finally(()=>{stash.dismissNotification(e)})}else stash.page.closeModal(n)}),E("div").addClass("filler"),E("div").addClass("inline button warning tt").text("Reset").attr("title","Reset tags of selected files.").on("click",t=>{const e=stash.page.modal(null,n.find(".content")).addClass("selection-required selection-tag-editor");e.find(".content").append(E("h2").text("Are you sure?"),E("p").text("This will undo any changes to tags you have made for the selected files on this account."),E("div").addClass("row").append(E("div").addClass("inline button").text("Cancel").on("click",()=>stash.page.closeModal(e)),E("div").addClass("inline button warning").text("Reset tags").on("click",()=>{const t=stash.notify("Resetting tags...","working");stash.tags.updateUser(stash.selection.files.map(t=>({id:stash.data[t].id,tags:null}))).then(()=>{stash.selection.files.forEach(t=>{stash.data[t].tags.user=null,stash.tags.checkDynamicImplicits(t)}),stash.page.closeModal(n),stash.tags.updateNames(),stash.tags.updateElements()}).finally(()=>{stash.dismissNotification(t)})})))})));const i=/(^|\s)([a-z0-9-]+)$/;CCInput(n.find(".tag-input"),{placeholder:"Example: iron sword",lists:[{name:"Tags",list:stash.tags.names.explicit}],value:t=>{const e=t.match(i);return e?e[2]:""},replace:(t,e,a)=>t.replace(i,(t,a)=>a+e),enter:a}),n.find(".add-button").on("click",()=>a(n.find(".tag-input input").val())),tippy(n.find(".tt").toArray())})})})(),stash.tags={names:{implicit:["untagged","selected","latest","image","zip","model","ctm","cit","texture-set","animated","user-tagged","mcmeta"].sort(naturalSorter),explicit:[],all:[]},alias:{}},stash.tags.updateNames=(()=>{const t=new Set;stash.files.forEach(e=>{stash.data[e].tags.official.forEach(e=>t.add(e)),stash.data[e].tags.user&&stash.data[e].tags.user.forEach(e=>t.add(e))}),stash.tags.names.explicit=Array.from(t).sort(naturalSorter),stash.tags.names.alias=Object.keys(stash.tags.alias).sort(naturalSorter),stash.tags.names.all=[].concat(stash.tags.names.implicit,stash.tags.names.explicit,stash.tags.names.alias).filter((t,e,a)=>a.indexOf(t)==e).sort(naturalSorter)}),stash.tags.of=((t,e=!0)=>{const a=(stash.data[t].tags.user||stash.data[t].tags.official).map(e=>({name:e,type:~stash.data[t].tags.official.indexOf(e)?"official":"user"}));if(e)for(const e of stash.data[t].tags.implicit.values())a.push({name:e,type:"implicit"});return a}),stash.tags.checkDynamicImplicits=(t=>{(stash.data[t].tags.user||stash.data[t].tags.official).length?stash.data[t].tags.implicit.delete("untagged"):stash.data[t].tags.implicit.add("untagged"),stash.data[t].tags.user?stash.data[t].tags.implicit.add("user-tagged"):stash.data[t].tags.implicit.delete("user-tagged")}),stash.tags.element=(t=>E("div").addClass("tags").attr("data-file",t).append(stash.tags.of(t).filter(t=>"implicit"!=t.type).map(t=>E("span").addClass(t.type+" tag").text(t.name)))),stash.tags.updateElements=(()=>{$(".tags[data-file]").each((t,e)=>$(e).replaceWith(stash.tags.element($(e).attr("data-file")))),$(".stash-page-content").each((t,e)=>"function"==typeof e.onTagsUpdate&&e.onTagsUpdate())}),stash.tags.updateUser=(t=>new Promise((e,a)=>{stash.getFirebaseUser(s=>{s?s.getIdToken().then(s=>{$.ajax({url:cloudFunctions+"/tags/user",type:"POST",dataType:"json",contentType:"application/json",headers:{Authorization:"Bearer "+s},data:JSON.stringify(t)}).done(t=>{e(t)}).fail(t=>{t.responseJSON?stash.notify(`Failed to update user tags: ${t.responseJSON.message}`,null,"error"):stash.notify(`Failed to update user tags: ${t.status} ${t.statusText}`,null,"error"),console.log("Failed to update user tags",t),a(t)})}):(stash.notify("Failed to update user tags: User not logged in.",null,"error"),a())})})),stash.tags.isValid=(t=>t.match(rgxValidTag)&&!t.match(rgxInvalidTag));