function E(t){return $(document.createElement(t))}function onPageLoad(){$("#content-wrapper,#content-scroller,#content").each((t,e)=>e.removeAttribute("style")),stash.page.closeModal($(".stash-page-wrapper>.modal")),$(".stash-page-content").each((t,e)=>{"function"==typeof e.onUnload&&(e.onUnload(),e.onUnload=null),e.onSidebarToggle=null}),removeAllTooltips(),$("#searchbar input").val("");let t=getURLParams();if(null!=t){for(let e=0;e<pages.length;e++)if(t.hasOwnProperty(pages[e]))return void $("#content").load(`pages/${pages[e]}.html`,()=>stash.page.loaded($("#content")));$("#content").empty().append('<div class="hint">This page does not exist.</div>'),stash.workError()}else $("#content").load("pages/shortcuts.html",()=>stash.page.loaded($("#content")))}function removeAllTooltips(){$(".tippy-popper").remove()}function idSort(t,e){return stash.data[t].id-stash.data[e].id}function getApproxTime(t){if(t>legacyTimeData[legacyTimeData.length-1].id)return-1;for(let e=0;e<legacyTimeData.length;e++)if(t>legacyTimeData[e].id&&t<=legacyTimeData[e+1].id)return lerp(legacyTimeData[e].time,legacyTimeData[e+1].time,(t-legacyTimeData[e].id)/(legacyTimeData[e+1].id-legacyTimeData[e].id));return-1}function getExt(t){return rgxExt.exec(t)[1].toLowerCase()}function getContributor(t){return rgxContributor.exec(t)[1]}function getID(t){return parseInt(rgxID.exec(t)[1])}function getTimestamp(t){return stash.data[t].timestamp||getApproxTime(getID(t))}function createFilePreview(t,e){const a=stash.data[t].size;if(e.attr("data-file",t).addClass("file"),stash.data[t].mcmeta&&(e.addClass("mcmeta"),"png"==stash.data[t].ext&&e.append(E("div").addClass("type-indicator tt").load("/stash/resources/code-braces.svg"))),"zip"==stash.data[t].ext&&e.addClass("zip").append(E("div").addClass("type-indicator tt").load("/stash/resources/package.svg")),"png"==stash.data[t].ext){let s=stash.url.files+t;if(e.addClass("png"),stash.data[t].animated){const n=E("div").addClass(`img thumbnail${a[0]<128?" pixelated":""}`).attr("data-src",stash.url.thumbnails+t).appendTo(e);stash.lazy.imageObserver.observe(n[0]);const i=E("img").addClass("animated").attr("src","/stash/resources/transparent.png").attr("data-src",s).attr("data-mcmeta",stash.data[t].mcmeta).appendTo(e).on("lazyload",t=>{n.remove()});stash.lazy.animationObserver.observe(i[0])}else if(a[0]>128||a[1]>128){const a=E("div").addClass("img thumbnail").attr("data-src",stash.url.thumbnails+t).appendTo(e);stash.lazy.imageObserver.observe(a[0]);const n=E("div").addClass("img original").attr("data-src",s).appendTo(e);stash.lazy.imageObserver.observe(n[0])}else{const t=E("div").addClass(`img ${a[0]<128&&a[1]<128?" pixelated":""}`).attr("data-src",s).appendTo(e);stash.lazy.imageObserver.observe(t[0])}}else{let s=stash.url.thumbnails+t.replace(/\.zip$/,".png");if(stash.data[t].animated){const a=E("img").addClass("animated").attr("src","/stash/resources/transparent.png").attr("data-src",s).attr("data-mcmeta",stash.data[t].mcmeta).appendTo(e.addClass("no-thumbnail")).on("lazyload",t=>{e.removeClass("no-thumbnail")});stash.lazy.animationObserver.observe(a[0])}else{const t=E("div").addClass(`img ${a[0]<128&&a[1]<128?" pixelated":""}`).attr("data-src",s).appendTo(e);stash.lazy.imageObserver.observe(t[0])}}let s=E("div").addClass("overlay").appendTo(e);s.append(E("a").addClass("action-button download-image-button").attr("title","Download").attr("href",stash.url.files+t).on("click",e=>{if("png"==stash.data[t].ext&&stash.data[t].mcmeta){const e=new JSZip;Promise.all([t,t+".mcmeta"].map(t=>new Promise((a,s)=>{$.ajax(stash.url.files+t,{xhrFields:{responseType:"blob"}}).done(s=>{e.file(t,s,{createFolders:!0}),a()}).fail(e=>{stash.notify(`Failed to load file: ${t}`,null,"error"),s()})}))).then(()=>{e.generateAsync({type:"blob"}).then(e=>{saveAs(e,t.replace(/\.png$/,".zip"))})})}else saveAs(stash.url.files+t,t);e.preventDefault(),e.stopPropagation()}).on("contextmenu",t=>{t.stopPropagation()}));const n=stash.tags.of(t);return stash.data[t].sketchfabID?s.append(E("div").addClass("action-button preview-3d-button").attr("title","3D Preview").on("click",e=>{stash.sketchfabPreview(stash.data[t].sketchfabID),e.stopPropagation(),e.preventDefault()})):n.find(t=>"beholder-panorama"==t.name)?s.append(E("div").addClass("action-button preview-panorama-button").attr("title","Panorama Preview").on("click",e=>{stash.beholderPreview({src:stash.url.files+t,format:"panorama"}),e.stopPropagation(),e.preventDefault()})):n.find(t=>"beholder-skybox"==t.name)?s.append(E("div").addClass("action-button preview-panorama-button").attr("title","Skybox Preview").on("click",e=>{stash.beholderPreview({src:stash.url.files+t,format:"skybox"}),e.stopPropagation(),e.preventDefault()})):"png"==stash.data[t].ext&&s.append(E("div").addClass("action-button fullscreen-button").attr("title","Fullscreen").on("click",e=>{stash.fullscreenImage(stash.url.files+t),e.stopPropagation(),e.preventDefault()})),tippy(s.find(".action-button").toArray(),{arrow:!0,animation:"perspective",performance:!0}),e}function lerp(t,e,a){return e*a+t*(1-a)}function getURLParams(t){let e=t;if(e||(e=location.search),e.length<2)return null;let a,s={};for(;a=rgxURLParams.exec(e);)s[a[1]]=!a[2]||decodeURIComponent(a[2].replace(/\+/g,"%20"));return s}function toURLParams(t){let e=[];for(let a in t)if(t.hasOwnProperty(a)&&null!=t[a])if(!0===t[a])e.push(`${0==e.length?"?":"&"}${a}`);else{let s=encodeURIComponent(t[a]).replace(/%3A/g,":").replace(/%3B/g,";").replace(/%20/g,"+").replace(/%2C/g,",").replace(/%2F/g,"/").replace(/%40/g,"@");e.push(`${0==e.length?"?":"&"}${a}=${s}`)}return e.join("")}function formatNum(t,e,a){let s=t;if("undefined"!=typeof Intl&&void 0!==Intl.NumberFormat&&(s=(new Intl.NumberFormat).format(t)),!e)return s;const n=t%10,i=t%100;return 1==n&&11!=i?a?[s,"st"]:s+"st":2==n&&12!=i?a?[s,"nd"]:s+"nd":3==n&&13!=i?a?[s,"rd"]:s+"rd":a?[s,"th"]:s+"th"}function formatBytes(t){if(0==t)return"0 B";const e=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,e)).toFixed(1))+" "+["B","KB","MB","GB","TB"][e]}function formatDate(t){const e=new Date(1e3*t);return months[e.getMonth()]+" "+e.getDate()+", "+e.getFullYear()}function naturalSorter(t,e){let a,s,n,i,r,o,l=0,c=/(\.\d+)|(\d+(\.\d+)?)|([^\d.]+)|(\.\D+)|(\.$)/g;if(t===e)return 0;for(a="string"!=typeof t?t.toString().toLowerCase().match(c):t.toLowerCase().match(c),s="string"!=typeof e?e.toString().toLowerCase().match(c):e.toLowerCase().match(c),o=a.length;l<o;){if(!s[l])return 1;if(n=a[l],i=s[l++],n!==i)return r=n-i,isNaN(r)?n>i?1:-1:r}return s[l]?-1:0}var CCInput=null;(()=>{const t=new Event("change");CCInput=((t,e={})=>(t.each((t,r)=>{if(r.ccinput=e,"file"!==r.ccinput.type){r.ccinput.lists=r.ccinput.lists||[];const t=$(r).addClass("ccin-wrapper ccin-menu-hidden"+(r.ccinput.readonly?" readonly":"")).on("focusout",t=>n(r,t));"select"===r.ccinput.type?(t.attr("data-type","select").append(E("div").attr("tabindex",0).addClass("ccin-select").on("keydown",t=>s(r,t)).on("focus",t=>i(r,t)),E("span").addClass("ccin-readonly-text"),E("span").addClass("ccin-ph"),E("ul").addClass("ccin-menu ccin-menu-empty").attr("tabindex",0)),r.val=(e=>{if(void 0===e)return t.attr("data-value");{const a=r.ccinput.lists.map(t=>"function"==typeof t?t():t).find(t=>t.list.find(t=>t.value==e));if(!a)throw"Invalid value.";return t.attr("data-value",e),t.children(".ccin-select").html(a.list.find(t=>t.value==e).name),r}}),r.ccinput.lists.map(t=>"function"==typeof t?t():t).find(e=>{const a=e.list.find(t=>t.selected);if(a)return t.attr("data-value",a.value),t.children(".ccin-select").html(a.name),!0})):(t.attr("data-type","text").append(E("input").attr("type","string"==typeof r.ccinput.type?r.ccinput.type:"text").attr("title"," ").attr("spellcheck","false").attr("size","1").addClass("ccin-input").prop("required",!0).on("input",t=>a(r,t)).on("keydown",t=>s(r,t)).on("focus",t=>i(r,t)),E("span").addClass("ccin-readonly-text"),E("span").addClass("ccin-ph"),E("ul").addClass("ccin-menu ccin-menu-empty").attr("tabindex",0)),r.val=(e=>void 0===e?t.children(".ccin-input").val():(t.children(".ccin-input").val(e),t))),void 0!==r.ccinput.default&&(t.children(".ccin-input").val(r.ccinput.default),t.children(".ccin-readonly-text").text(r.ccinput.default)),"number"===r.ccinput.type&&(void 0!==r.ccinput.min&&t.children(".ccin-input").attr("min",r.ccinput.min),void 0!==r.ccinput.max&&t.children(".ccin-input").attr("max",r.ccinput.max)),e.placeholder&&("function"==typeof e.placeholder.then?e.placeholder.then(e=>t.children(".ccin-ph").append(e)):t.children(".ccin-ph").append(e.placeholder))}else{const t=$(r).addClass("ccin-drop-zone"),e=E("input").attr("type","file").addClass("ccin-file-input").appendTo(t);r.ccinput.multiple&&e.prop("multiple",!0),r.ccinput.accept&&e.attr("accept",r.ccinput.accept.join(",")),e.on("change",t=>{"function"==typeof r.ccinput.fileHandler&&[...t.currentTarget.files].forEach(t=>r.ccinput.fileHandler(t)),$(t.currentTarget).val(null)}),t.on("drop",t=>{const e=t.originalEvent;$(e.currentTarget).removeClass("dragging"),e.preventDefault(),"function"==typeof r.ccinput.fileHandler&&(e.dataTransfer.items?[...e.dataTransfer.items].forEach(t=>{if("file"!==t.kind)return;const e=t.getAsFile();~r.ccinput.accept.indexOf(e.type)&&r.ccinput.fileHandler(e)}):[...e.dataTransfer.files].forEach(t=>{~r.ccinput.accept.indexOf(t.type)&&r.ccinput.fileHandler(t)}))}),t.on("dragover dragenter",t=>{$(t.currentTarget).addClass("dragging"),t.preventDefault()}),t.on("dragend dragleave",t=>{$(t.currentTarget).removeClass("dragging"),t.preventDefault()}),t.on("click",t=>{e[0].click()}),r.ccinput.hint&&("function"==typeof r.ccinput.hint.then?r.ccinput.hint.then(e=>t.append(E("div").addClass("ccin-drop-zone-hint").append(e))):t.append(E("div").addClass("ccin-drop-zone-hint").append(r.ccinput.hint)))}}),t));const e=t=>{const e=$(t).children(".ccin-input"),a="function"==typeof t.ccinput.value?t.ccinput.value(e.val()):e.val(),s=$(t).children(".ccin-menu").empty();if(a.length<1)return s.addClass("ccin-menu-empty"),void $(t).addClass("ccin-menu-hidden");s.removeClass("ccin-menu-empty"),$(t).removeClass("ccin-menu-hidden");const n=a.toLowerCase(),i=new RegExp(`(${a})`,"gi");t.ccinput.lists.map(t=>({name:t.name,list:("function"==typeof t.list?t.list():t.list).filter(t=>t.match(i)).sort((t,e)=>{return t.toLowerCase().indexOf(n)-e.toLowerCase().indexOf(n)||e.match(i).length-t.match(i).length||t.length-e.length})})).filter(t=>t.list.length).map(t=>$.extend({score:t.list[0].toLowerCase().indexOf(n)},t)).sort((t,e)=>t.score-e.score).forEach(e=>{s.append(e.name?E("li").addClass("ccin-menu-group").html(e.name):"",e.list.map(a=>E("li").addClass("ccin-menu-item").html(a.replace(i,"<mark>$1</mark>")).attr("data-category",e.name).attr("data-value",a).on("click",e=>o(t,e.currentTarget))))}),s.children(".ccin-menu-item").first().addClass("ccin-selected-item")},a=(t,a)=>{$(t).children(".ccin-readonly-text").text(a.currentTarget.value),0!=t.ccinput.lists.length&&e(t)},s=(t,e)=>{if(27===e.which)return $(t).children(".ccin-menu").addClass("ccin-menu-empty").empty(),$(t).addClass("ccin-menu-hidden").off("click",r),!0;if(13===e.which&&"function"==typeof t.ccinput.enter&&0==$(t).children(".ccin-menu").children(".ccin-selected-item").length)return t.ccinput.enter($(t).children(".ccin-input").val(),e),!0;if($(t).children(".ccin-menu").is(".ccin-menu-empty"))return!0;if(40===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.nextAll(".ccin-menu-item").length>0&&(a.removeClass("ccin-selected-item").nextAll(".ccin-menu-item").first().addClass("ccin-selected-item"),scrollIntoView(a[0],{behavior:"instant"})),e.preventDefault()}else if(38===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.prevAll(".ccin-menu-item").length>0&&(a.removeClass("ccin-selected-item").prevAll(".ccin-menu-item").first().addClass("ccin-selected-item"),scrollIntoView(a[0],{behavior:"instant"})),e.preventDefault()}else if(9===e.which||13===e.which){const a=$(t).children(".ccin-menu").children(".ccin-selected-item");a.length&&(o(t,a[0]),e.preventDefault())}},n=(t,e)=>{$(t).is(":focus-within")||($(t).children(".ccin-menu").addClass("ccin-menu-empty").empty(),$(t).addClass("ccin-menu-hidden").off("click",r))},i=(t,a)=>{if("select"===t.ccinput.type){const e=$(t).children(".ccin-menu").removeClass("ccin-menu-empty").empty();t.ccinput.lists.map(t=>"function"==typeof t.list?{name:t.name,list:t.list()}:t).sort((t,e)=>naturalSorter(t.name,e.name)).forEach(a=>{e.append(a.name?E("li").addClass("ccin-menu-group").html(a.name):"",a.list.map(e=>E("li").addClass("ccin-menu-item").html(e.name).attr("data-category",a.name).attr("data-value",e.value).attr("data-name",e.name).on("click",e=>o(t,e.currentTarget))))}),$(t).attr("data-value")?e.children(`.ccin-menu-item[data-value=${$(t).attr("data-value")}]`).first().addClass("ccin-selected-item"):e.children(".ccin-menu-item").first().addClass("ccin-selected-item"),$(t).removeClass("ccin-menu-hidden").on("mouseup",()=>setTimeout(()=>$(t).off("mouseup").on("click",r),100))}else!t.ccinput.refocusing&&t.ccinput.lists.length>0&&$(t).children(".ccin-input").val().length>0?e(t):t.ccinput.refocusing||"function"!=typeof t.ccinput.hint||($(t).children(".ccin-menu").removeClass("ccin-menu-empty").empty().append(E("div").addClass("ccin-menu-hint").append(t.ccinput.hint())),$(t).removeClass("ccin-menu-hidden"));t.ccinput.refocusing=!1},r=t=>{$(t.currentTarget).children(".ccin-select").blur(),$(t.currentTarget).children(".ccin-menu").empty(),$(t.currentTarget).addClass("ccin-menu-hidden").off("click",r)},o=(e,a)=>{if("select"===e.ccinput.type)$(e).children(".ccin-select").html($(a).attr("data-name")).blur(),$(e).attr("data-value",$(a).attr("data-value")),$(e).children(".ccin-menu").empty().addClass("ccin-menu-empty"),$(e).addClass("ccin-menu-hidden").off("click",r),e.dispatchEvent(t);else{const t=$(e).children(".ccin-input");t.val("function"==typeof e.ccinput.replace?e.ccinput.replace(t.val(),$(a).attr("data-value"),$(a).attr("data-category")):$(a).attr("data-value")).trigger("change"),$(e).children(".ccin-menu").empty().addClass("ccin-menu-empty"),$(e).addClass("ccin-menu-hidden"),e.ccinput.refocusing=!0,t.focus()}}})();const legacyTimeData=[{time:1312051806,id:0},{time:1314221974,id:1e3},{time:1317388666,id:2e3},{time:1319090950,id:3e3},{time:1323408627,id:4e3},{time:1327695347,id:5e3},{time:1332070004,id:6e3},{time:1335737826,id:7e3},{time:1339451376,id:8e3},{time:1346105014,id:9e3},{time:1354211287,id:1e4},{time:1361130865,id:11e3},{time:1366174956,id:12e3},{time:1368929856,id:13e3},{time:1372727962,id:14e3},{time:1378402172,id:15e3},{time:1389405209,id:16e3},{time:1402541195,id:17e3},{time:1414832158,id:18e3},{time:1451429522,id:19e3},{time:1460483638,id:19160},{time:1460536130,id:19348},{time:1463713609,id:19398},{time:1464735265,id:19404},{time:1465704958,id:19415},{time:1469905303,id:19433},{time:1470202364,id:19444},{time:1478645533,id:19693},{time:1500235159,id:20122},{time:1512422195,id:20145}];class MCAnimation{constructor(t,e){this.texture=new Image,this.texture.src=t,this.mcmeta="object"==typeof e?e:{animation:{}},this.mcmeta.animation||(this.mcmeta.animation={}),this.canvas=document.createElement("canvas"),this.canvas.className="mc-animation",this.context=this.canvas.getContext("2d"),this.frames=[],this.currentFrame=0,this.ticks=0,this.texture.addEventListener("load",()=>this.init())}init(){this.canvas.width=this.texture.width,this.canvas.height=this.texture.width;let t=Math.max(this.mcmeta.animation.frametime||1,1);if(Array.isArray(this.mcmeta.animation.frames)&&this.mcmeta.animation.frames.length>0){this.mcmeta.animation.interpolate||this.mcmeta.animation.frames.find(e=>"object"==typeof e&&e.time%t!=0)?this.interval=1:this.interval=t;for(let e=0;e<this.mcmeta.animation.frames.length;e++){const a=this.mcmeta.animation.frames[e];"number"==typeof a?this.frames.push({index:a,duration:t/this.interval}):this.frames.push({index:a.index,duration:Math.max(a.time,1)/this.interval})}}else{this.mcmeta.animation.interpolate?this.interval=1:this.interval=t;let e=this.texture.height/this.texture.width;for(let a=0;a<e;a++)this.frames.push({index:a,duration:t/this.interval})}this.draw(),this.play()}draw(t=0,e=0){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.imageSmoothingEnabled=this.texture.width>this.canvas.width,this.context.globalAlpha=1,this.context.drawImage(this.texture,0,this.texture.width*this.frames[t].index,this.texture.width,this.texture.width,0,0,this.canvas.width,this.canvas.height),this.mcmeta.animation.interpolate&&(this.context.globalAlpha=e/this.frames[t].duration,this.context.drawImage(this.texture,0,this.texture.width*this.frames[(t+1)%this.frames.length].index,this.texture.width,this.texture.width,0,0,this.canvas.width,this.canvas.height))}update(){this.frames[this.currentFrame].duration<=++this.ticks?(this.currentFrame=(this.currentFrame+1)%this.frames.length,this.ticks=0,this.draw(this.currentFrame,this.ticks),"function"==typeof this.onNewFrame&&this.onNewFrame()):this.mcmeta.animation.interpolate&&this.draw(this.currentFrame,this.ticks)}play(){this.frames.length>1?this.timer=setInterval(()=>{window.requestAnimationFrame(()=>this.update())},50*this.interval):window.requestAnimationFrame(()=>this.draw()),this.canvas.classList.add("playing")}pause(){this.timer&&(clearInterval(this.timer),this.timer=null),this.canvas.classList.remove("playing")}stop(){this.pause(),this.currentFrame=0,this.canvas.classList.remove("playing")}get frameIndex(){return this.frames.length>0?this.frames[this.currentFrame].index:0}get playing(){return null!=this.timer}}const pages=["search","about","contributors","profile","details","submit","help","status","animation-editor","admin","my-submissions","mod-support-downloader","pack-builder","addon-editor"],months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],opTime=1312035589,rgxContributor=/(.+)_\d+/,rgxID=/.+_(\d+)/,rgxExt=/\.([^.]*)$/,rgxURLParams=/(?:^\?|&)([A-z0-9-]+)(?:=([^&]+)|(?=&)|$|=)/g,rgxValidTag=/^[a-z0-9][a-z0-9-]+[a-z0-9]$/,rgxInvalidTag=/^[0-9][0-9-]+[0-9]$/;tippy.defaults.arrow=!0,tippy.defaults.animation="perspective",tippy.defaults.performance=!0,tippy.defaults.delay=200,tippy.defaults.ignoreAttributes=!0,tippy.defaults.popperOptions={modifiers:{preventOverflow:{enabled:!1},hide:{enabled:!1}}};var stash={url:{files:"/stash-files/files/",data:"/stash-files/",thumbnails:"/stash-files/thumbnails/",cors:"https://dokustash-cors.herokuapp.com/",cloudFunctions:"https://us-central1-dokucraft-stash.cloudfunctions.net/api",cloudFunctions1G:"https://us-central1-dokucraft-stash.cloudfunctions.net/api1g",beholder:"/stash/beholder/"},data:{},contributors:[],page:{},cache:{},displayOptions:{grouping:"none",sorting:"id",order:"des",scale:1},animations:[],files:[],selection:{files:[]},typeNames:{model:"Model",ctm:"CTM",cit:"CIT",set:"Texture set"},firebase:{auth:firebase.auth(),db:firebase.firestore(),storage:firebase.storage()},loadingHint:"",lazy:{},popularShortcuts:["Latest","Animations","Armor Icons","Armor Textures","Axes","CTM","Models","Stone","Swords","Tools"]};$(window).on("popstate",onPageLoad),stash.getZIPContent=((t,e=(t=>t.match(/\.png$/)?"base64":"text"))=>stash.cache.zipContent&&stash.cache.zipContent.file==t?Promise.resolve(stash.cache.zipContent.content):$.ajax(stash.url.files+t,{xhrFields:{responseType:"blob"}}).then(t=>JSZip.loadAsync(t)).then(t=>Promise.all(Object.keys(t.files).filter(e=>!t.files[e].dir).map(a=>t.file(a).async(e(a)).then(s=>({path:a.split("/").slice(0,-1).join("/"),name:a.split("/").pop(),content:s,size:t.files[a]._data.uncompressedSize,encoded:"base64"==e(a)}))))).then(e=>(stash.cache.zipContent={file:t,content:e},e)).catch(e=>(stash.notify(`Failed to load file: ${t}<br>(${e.status} ${e.statusText})`,null,"error"),Promise.reject(e)))),stash.getImage=(t=>new Promise((e,a)=>{const s=new Image;s.onload=(()=>e(s)),s.onerror=(()=>a(s)),s.src=t})),stash.blockInput=((t,e=!0)=>{removeAllTooltips();const a=E("div").addClass("fullscreen-blocker "+(t||"")).appendTo($("body")).animate({opacity:1},500);return e&&a.attr("tabindex",1).focus().on("keyup",t=>{27===t.which&&stash.removeInputBlocker(a)}),a}),stash.removeInputBlocker=(t=>new Promise(e=>{t.addClass("fading").stop().animate({opacity:0},250,()=>{t.remove(),e()})})),stash.fullscreenImage=(t=>{const e=E("div").addClass("img").attr("data-src",t)[0];return stash.lazy.imageObserver.observe(e),stash.blockInput().append(E("div").addClass("fs-img-container").append(e)).on("click",function(){stash.removeInputBlocker($(this))})}),stash.sketchfabPreview=(t=>stash.blockInput().append(E("iframe").addClass("fs-iframe").attr("src",`https://sketchfab.com/models/${t}/embed?autostart=1`)).on("click",function(t){t.currentTarget==this&&stash.removeInputBlocker($(this))})),stash.beholderPreview=(t=>stash.blockInput().append(E("iframe").addClass("fs-iframe").attr("src",stash.url.beholder+toURLParams(t))).on("click",function(t){t.currentTarget==this&&stash.removeInputBlocker($(this))})),stash.search=((t,e=stash.files,a)=>{if(!t)return[];const s="string"==typeof t?stash.query.parse(t):t;return s?a?e.filter(t=>stash.query.match(s,t)).filter((t,e)=>a[e]):e.filter(t=>stash.query.match(s,t)):[]}),stash.nameOf=(t=>{const e=(a,s)=>{if(s<a)return null;const n=Math.floor(.5*(a+s));return stash.data[stash.files[n]].id==t?stash.files[n]:stash.data[stash.files[n]].id<t?e(n+1,s):e(a,n-1)};return e(0,stash.files.length-1)}),stash.bounds=(t=>{const e=t.filter(t=>stash.data.hasOwnProperty(t)).map(t=>stash.data[t].id);return[e.reduce((t,e)=>e<t?e:t,1/0),e.reduce((t,e)=>e>t?e:t,-1/0)]});const BASE64_CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz/-";stash.createMask=((t,e=stash.files)=>{let a=e.map(e=>~t.indexOf(e)?1:0).join("");for(let t=0;t<a.length%6;t++)a+="0";return btoa(RawDeflate.deflate(a.match(/.{1,6}/g).map(t=>BASE64_CHARS.charAt(parseInt(t,2))).join(""))).replace(/=/g,"-").replace(/\+/g,"_")}),stash.decodeMask=(t=>RawDeflate.inflate(atob(t.replace(/-/g,"=").replace(/_/g,"+"))).split("").map((t,e,a)=>BASE64_CHARS.indexOf(t).toString(2).padStart(6,"0")).join("").replace(/^0+/,"").split("").map(t=>parseInt(t))),stash.setWorkProgress=(t=>{const e=Math.floor(100*t)||stash.cache.workProgress;stash.cache.workProgress=e,$("#work-progress-bar").removeClass("indeterminate").stop().animate({width:t+"%"},250)}),stash.workIndeterminate=(()=>{$("#work-progress-bar").addClass("indeterminate").stop()}),stash.workError=(t=>{stash.cache.workProgress;$("#work-progress-bar").css("background-color","#f58"),$("#work-progress-bar").is(".indeterminate")&&$("#work-progress-bar").removeClass("indeterminate").css("width","100%"),setTimeout(()=>{$("#work-progress-bar").stop().animate({width:0},500,()=>$("#work-progress-bar").css("background-color","#58f")),"function"==typeof t&&t()},3500)}),stash.workComplete=(()=>{stash.page.hasWork=!1,stash.cache.workProgress=0,$("#work-progress-bar").is(".indeterminate")?$("#work-progress-bar").stop().removeClass("indeterminate").css("width","100%").animate({height:0},500,()=>$("#work-progress-bar").css("width",0).css("height","4px")):$("#work-progress-bar").stop().animate({height:0,width:"100%"},500,()=>$("#work-progress-bar").css("width",0).css("height","4px"))});const lazyLoadEvent=new Event("lazyload");"IntersectionObserver"in window?(stash.lazy.imageObserver=new IntersectionObserver(function(t,e){t.forEach(function(t){if(t.isIntersecting){const e=t.target;"IMG"===e.tagName?e.src=e.dataset.src:e.style.backgroundImage=`url("${e.dataset.src}")`,e.dispatchEvent(lazyLoadEvent),stash.lazy.imageObserver.unobserve(e)}})}),stash.lazy.animationObserver=new IntersectionObserver(function(t,e){t.forEach(function(t){if(t.isIntersecting){const e=t.target;if(stash.lazy.animationObserver.unobserve(e),"true"===e.dataset.mcmeta)$.getJSON(e.dataset.src+".mcmeta").done(t=>{const a=new MCAnimation(e.dataset.src,t);stash.animations.push(a),e.dispatchEvent(lazyLoadEvent),e.replaceWith(a.canvas)}).fail(t=>{console.error("Failed to load animation MCMETA: ",e.dataset.src,t)});else{const t=new MCAnimation(e.dataset.src);stash.animations.push(t),e.dispatchEvent(lazyLoadEvent),$(e).is(".pixelated")&&$(t.canvas).addClass("pixelated"),e.replaceWith(t.canvas)}}})})):(stash.notify("Your browser is missing certain features that the stash uses to improve performance.\nConsider using a different browser if pages take a long time to load.",null,"error"),stash.lazy.imageObserver={observe:t=>{"IMG"===t.tagName?t.src=t.dataset.src:t.style.backgroundImage=`url("${t.dataset.src}")`,t.dispatchEvent(lazyLoadEvent)}},stash.lazy.animationObserver={observe:t=>{if("true"===t.dataset.mcmeta)$.getJSON(t.dataset.src+".mcmeta").done(e=>{const a=new MCAnimation(t.dataset.src,e);stash.animations.push(a),t.dispatchEvent(lazyLoadEvent),t.replaceWith(a.canvas)}).fail(e=>{console.error("Failed to load animation MCMETA: ",t.dataset.src,e)});else{const e=new MCAnimation(t.dataset.src);stash.animations.push(e),t.dispatchEvent(lazyLoadEvent),t.replaceWith(e.canvas)}}}),stash.cleanUpAnimations=(()=>{stash.animations.filter(t=>!$.contains(document.body,t.canvas)).forEach(t=>t.stop()),stash.animations=stash.animations.filter(t=>t.timer)}),stash.anchor=(t=>{const e=toURLParams(t);return E("a").attr("href",e).on("click",t=>{stash.page.load(e),t.preventDefault()})}),stash.modalAnchor=((t,e)=>{const a=toURLParams(t);return E("a").attr("href",a).on("click",t=>{stash.page.modal(a,e),t.preventDefault()})}),stash.firebase.getUser=(()=>new Promise((t,e)=>{const a=stash.firebase.auth.onAuthStateChanged(s=>{a(),s?t(s):e("Not logged in.")})})),stash.firebase.post=((t,e,a=!1)=>new Promise((s,n)=>{stash.firebase.getUser().then(i=>i?i.getIdToken().then(i=>{$.ajax({url:(a?stash.url.cloudFunctions1G:stash.url.cloudFunctions)+t,type:"POST",dataType:"json",contentType:"application/json",headers:{Authorization:"Bearer "+i},data:JSON.stringify(e)}).done(s).fail(n)}):n("Not logged in.")).catch(n)})),stash.printUserID=(()=>{stash.firebase.getUser().then(t=>console.log("User ID: "+t.uid))}),stash.parseAddonScript=((t,e=console.error)=>{const a=t.split("\n"),s=[],n=[s],i=/"(?:[^"\\]|\\")*"|\S+/g,r=/^"((?:[^"\\]|\\")*)"$/;for(let t=0;t<a.length;t++){const s=a[t];if(0==s.trim().length)continue;const o=s.match(i);if("if"==o[0]){const t={if:o.slice(1).join(" "),then:[]};n[n.length-1].push(t),n.push(t.then)}else if("else"==o[0]){if(1==n.length)return e("Addon Script Error:",'"else" statements must come after an "if" statement. Line '+(t+1)),null;const a=n[n.length-2],s=a[a.length-1];if(s.hasOwnProperty("else"))return e("Addon Script Error:",'Conditions may only have one "else" statement. Line '+(t+1)),null;n.pop(),s.else=[],n.push(s.else)}else if("endif"==o[0]){if(1==n.length)return e("Addon Script Error:",'"endif" statements must come after an "if" statement. Line '+(t+1)),null;n.pop()}else n[n.length-1].push(o.map(t=>{const e=t.match(r);return e?e[1].replace(/\\"/g,'"'):t}))}return s}),stash.addonScriptToString=(t=>{let e=0;const a=[],s=t=>{t.forEach(t=>{Array.isArray(t)?a.push("  ".repeat(e)+t.map(t=>t.toString().match(/"|\s|^$/)?`"${t.replace(/"/g,'\\"')}"`:t).join(" ")):t.hasOwnProperty("if")&&(a.push("  ".repeat(e)+"if "+t.if),e++,s(t.then),e--,t.hasOwnProperty("else")&&(a.push("  ".repeat(e)+"else"),e++,s(t.else),e--),a.push("  ".repeat(e)+"endif"))})};return s(t),a.join("\n")}),stash.blobFromURL=(t=>fetch(t).then(t=>t.blob())),$(()=>{const t=[$.getJSON(stash.url.data+"files.json"),$.getJSON(stash.url.data+"shortcuts.json"),$.getJSON(stash.url.data+"implicit-tags.json")];Promise.all(t).then(t=>{stash.files=Object.keys(t[0]),stash.shortcuts=t[1];const e=new Set;let a=0;if(stash.files.forEach(s=>{const n=getID(s);stash.data[s]={id:n,contributor:getContributor(s),ext:getExt(s),size:t[0][s].S,mcmeta:!!t[0][s].M,animated:!!t[0][s].A,timestamp:t[0][s].D||getApproxTime(n),tags:{official:(t[0][s].T||"").split(",").filter(t=>t.length>=2).sort(naturalSorter),user:null,implicit:new Set}},stash.data[s].date=new Date(1e3*stash.data[s].timestamp),t[0][s].P&&(stash.data[s].parents=t[0][s].P),t[0][s].Z?(stash.data[s].packageType=t[0][s].Z,t[0][s].F&&(stash.data[s].sketchfabID=t[0][s].F),stash.data[s].tags.implicit.add("zip"),stash.data[s].tags.implicit.add("set"==stash.data[s].packageType?"texture-set":stash.data[s].packageType)):(stash.data[s].tags.implicit.add("image"),stash.data[s].mcmeta&&stash.data[s].tags.implicit.add("mcmeta"),stash.data[s].animated&&stash.data[s].tags.implicit.add("animated")),stash.tags.checkDynamicImplicits(s),e.add(stash.data[s].contributor),a=Math.max(a,n)}),stash.files.sort((t,e)=>stash.data[t].id-stash.data[e].id),stash.files.slice(-250).forEach(t=>{stash.data[t].tags.implicit.add("latest")}),Object.keys(t[2]).forEach(e=>{stash.tags.alias[e]=stash.query.parse(`"${e}"|(${t[2][e]})`)}),stash.tags.updateNames(),stash.contributors=Array.from(e).sort(naturalSorter),null!=localStorage.getItem("stash-max-id")){let t=parseInt(localStorage.getItem("stash-max-id"));if(a>t){const e={search:t+1+"-"+a,sc:"notification"},s=stash.search(e.search);stash.notify(`${s.length>1?s.length:"A"} new file${s.length>1?"s":""} has been added to the stash.`,[{text:"View",func:()=>{stash.page.load(toURLParams(e))}}]),localStorage.setItem("stash-max-id",a)}}else localStorage.setItem("stash-max-id",a);const s=/(^|[!@\(\) |])([A-z0-9_-]+|"[A-z0-9_ -]+"?)$/;CCInput($("#searchbar"),{placeholder:new Promise(t=>$.get("/stash/resources/search.svg",e=>t(e+" Search..."),"text")),lists:[{name:"Tags",list:()=>stash.tags.names.nonHidden},{name:"Contributors",list:stash.contributors}],value:t=>{const e=t.match(s);return e?e[2]:""},replace:(t,e,a)=>t.replace(s,(s,n,i,r)=>("@"!==n&&"Contributors"===a&&"@"!==t.substring(r-1,r)?(n.length?n:"")+"@":n)+(~e.indexOf(" ")?'"'+e+'"':e)),enter:(t,e)=>{t.length&&(e.ctrlKey?stash.page.modal(toURLParams({search:t})):stash.page.load(toURLParams({search:t})),$(e.currentTarget).blur())},hint:()=>[E("h4").text("Search"),E("p").append("Search for files by entering one or more tags that may apply to them. For example, ",stash.anchor({search:"diamond sword"}).append(E("code").text("diamond sword")).on("click",()=>$("#searchbar *").blur())," will show all diamond swords in the stash."),E("p").html("You can search for files made by a specific contributor by adding <code>@</code> before their name."),E("br"),E("p").text("For in-depth information about searching, check out the full guide by clicking the button below."),E("br"),E("div").addClass("inline button").text("Search Guide").on("click",()=>{$("#searchbar *").blur(),stash.page.modal(toURLParams({help:"searching"}))})]}),$("#search-button").on("click",t=>{const e=$("#searchbar input").val();e.length&&(t.ctrlKey?stash.page.modal(toURLParams({search:e})):stash.page.load(toURLParams({search:e})))}),$("#login-button").on("click",()=>{const t=new firebase.auth.GithubAuthProvider;t.addScope("public_repo"),stash.firebase.auth.signInWithPopup(t).then(t=>{localStorage.setItem("gh-login-token",t.credential.accessToken)}).catch(function(t){localStorage.removeItem("gh-login-token"),stash.notify("Failed to log in:"+t.message,null,"error")})}),$("#signout-button").on("click",()=>{stash.firebase.auth.signOut()}),stash.selection.loadStored(),getURLParams()?stash.userTagsLoaded.then(onPageLoad):onPageLoad()}),stash.loadingHint=$("#content>.hint")[0].outerHTML,$("body").on("keyup",t=>{if("c"==t.key&&event.ctrlKey){const t=$("[data-file]:hover");if(t.length){const e=stash.data[t.attr("data-file")].id;$("#clipboard-input").val(e).select(),document.execCommand("Copy");const a=stash.notify("File ID copied: "+stash.data[t.attr("data-file")].id,"working");setTimeout(()=>stash.dismissNotification(a),3e3)}}}),$("body").on("touchend",t=>{$(t.target).is(".menu-title")?$(".menu.touch-open").not($(t.target).find(".menu")).removeClass("touch-open"):$(".menu.touch-open").removeClass("touch-open")});const e=t=>e=>{const a=$(e.currentTarget),s=a.find(".menu").addClass(t||"").css("left",a[0].getBoundingClientRect().left),n=s[0].getBoundingClientRect(),i=document.documentElement.clientWidth;n.right>i&&s.css({left:"auto",right:0})};$(".menu-title").on("mouseenter",e()),$(".menu-title").on("touchend",t=>e("touch-open")),tippy($(".header-button.tt").toArray(),{placement:"bottom",dynamicTitle:!0}),stash.page.optimizeScrolling($("#content-scroller")),stash.userTagsLoaded=new Promise(t=>{stash.firebase.auth.onAuthStateChanged(e=>{if(e){stash.firebase.auth.currentUser.getIdTokenResult().then(t=>{t.claims.admin?($("body").attr("data-logged-in","admin"),stash.firebase.db.collection("pending-submissions").where("type","==","file").orderBy("time").get().then(t=>{t.docs.length&&($("#admin-notification-count").text(t.docs.length),$("#admin-panel-button").attr("title","<h4>Admin Control Panel</h4><p>"+t.docs.length+" files pending review</p>"))})):t.claims.contributor?$("body").attr("data-logged-in","contributor"):$("body").attr("data-logged-in","user")}),stash.github=new GitHub({token:localStorage.getItem("gh-login-token")}),new Promise(t=>{e.displayName?t(e.displayName):stash.github.getUser().getProfile((a,s)=>{t(a?e.email:s.login)})}).then(t=>{$("#user-name").empty().append(E("img").attr("id","user-image").attr("src",e.photoURL),t)});const a=stash.notify("Loading user tags...","working");stash.firebase.db.collection("users").doc(e.uid).get().then(e=>{const s=e.get("tags");s&&(stash.files.forEach(t=>{const e=stash.data[t].id;stash.data[t].tags.user=s[e]?s[e].split(",").filter(t=>t.length>=2).sort(naturalSorter):null,stash.data[t].tags.user&&stash.tags.checkDynamicImplicits(t)}),stash.tags.updateNames(),stash.tags.updateElements()),stash.dismissNotification(a),t()}).catch(e=>{stash.dismissNotification(a),stash.notify("An error occurred while trying to load user tags",null,"error"),t()})}else localStorage.getItem("gh-login-token")&&($(".stash-page-content").each((t,e)=>"function"==typeof e.onUserLogout&&e.onUserLogout()),stash.notify("You have been signed out")),localStorage.removeItem("gh-login-token"),stash.github=null,stash.files.forEach(t=>{stash.data[t].tags.user=null,stash.tags.checkDynamicImplicits(t)}),stash.tags.updateNames(),stash.tags.updateElements(),$("body").attr("data-logged-in",null),t()})})}),stash.chart={},$(()=>{stash.chart.timeline=(()=>{const t={maintainAspectRatio:!1,legend:{display:!1},tooltips:{bodyFontSize:16,footerFontSize:0,callbacks:{label:t=>"    "+t.yLabel,title:()=>"",footer:()=>" "},custom:t=>{t&&(t.displayColors=!1)}}};return(e,...a)=>{let s=1/0,n=-1/0;const i={};for(let t=0;t<e.length;t++){const a=e[t],r=stash.data[a].timestamp;s=Math.min(s,r),n=Math.max(n,r);const o=stash.data[a].date,l=o.getFullYear()+" Q"+Math.floor((o.getMonth()+3)/3);(i[l]=i[l]||[]).push(a)}const r=new Date(1e3*s),o=new Date(1e3*n),l=r.getFullYear(),c=o.getFullYear();for(let t=r.getFullYear();t<=c;t++){const e=t!=l?1:Math.floor((r.getMonth()+3)/3),a=t!=c?4:Math.floor((o.getMonth()+3)/3);for(let s=e;s<=a;s++)i[t+" Q"+s]=i[t+" Q"+s]||[]}const d=Object.keys(i);d.sort(naturalSorter);const h=e=>{const a=E("canvas");return setTimeout(()=>new Chart(a,{type:"line",options:$.extend({},t,{title:{display:!0,fontColor:"#A1A7B3",text:e.title},scales:{xAxes:[{id:"xAxis1",gridLines:{display:!1},ticks:{fontColor:"#A1A7B3",callback:t=>t.split(" ")[1]}},{id:"xAxis2",gridLines:{display:!1},ticks:{fontColor:"#A1A7B3",callback:t=>~t.indexOf("Q1")||0==d.indexOf(t)?t.split(" ")[0]:""}}],yAxes:[{gridLines:{color:"#32353C"},ticks:{fontColor:"#A1A7B3",beginAtZero:!0,suggestedMax:e.maxValue}}]}}),data:{labels:d,datasets:[{data:e.dataHandler(d,i),xAxisID:"xAxis1",backgroundColor:"rgba(85,136,255,0.2)",borderColor:"#5588FF",pointHoverBorderColor:"#fff",borderWidth:2,pointRadius:5,lineTension:0}]}}),100),E("div").addClass("chart").append(a)};return"string"==typeof a[0]?h({title:a[0],dataHandler:a[2],maxValue:a[3]}):a.map(h)}})()}),stash.dismissNotification=(t=>{const e=t.outerHeight();t.prevAll(".notification").animate({bottom:`-=${e+20}px`},250),t.is(":animated")?setTimeout(()=>t.animate({right:"-800px"},250,()=>t.remove()),500):t.animate({right:"-800px"},250,()=>t.remove())}),stash.notify=((t,e,a)=>{const s=E("div").addClass("notification").append(E("div").addClass("notification-content").html(t)),n=E("div").addClass("button-row");"string"==typeof a&&s.addClass(a),Array.isArray(e)&&e.forEach(t=>{n.append(E("div").addClass("button inline").text(t.text).on("click",()=>{"function"==typeof t.func&&t.func(),stash.dismissNotification(s)}))}),"working"===e?(E("div").addClass("spinner").appendTo(s).load("/stash/resources/dokucraft.svg"),s.addClass("working")):(n.append(E("div").addClass("button inline").text("Dismiss").on("click",t=>{stash.dismissNotification(s)})),s.append(n)),s.appendTo($("body"));const i=s.outerHeight();return $(".notification").not(s).animate({bottom:`+=${i+20}px`},250),s.animate({right:"60px"},250),s}),stash.page.load=((t,e,a)=>new Promise(s=>{if(null!=a&&a.preventDefault(),!t.match(/\?/)&&null!=getURLParams()&&!0===getURLParams()[t])return;stash.workIndeterminate();let n=e;if(n||(n=$("#content")),stash.page.closeModal(n.closest(".stash-page-wrapper").find(".modal")),"function"==typeof n[0].onUnload&&(n[0].onUnload(),n[0].onUnload=null),n[0].onUserLogout=null,n[0].onTagsUpdate=null,"root"==t)e||(history.pushState(null,"","/stash/"),ga("set","page","/stash/"),ga("send","pageview")),n.empty().append(stash.loadingHint).load("pages/shortcuts.html",()=>s(n));else if(t.match(/^\?/)){const a=getURLParams(t);let i=null;for(let t=0;t<pages.length;t++)if(a.hasOwnProperty(pages[t])){i=pages[t];break}e?n.attr("data-params",t):(history.pushState(null,"",t),ga("set","page","/stash/"+t),ga("send","pageview")),n.empty().append(stash.loadingHint).load(`pages/${i}.html`,()=>s(n))}else{const a={};if(a[t]=!0,e)n.attr("data-params",toURLParams(a));else{const t=toURLParams(a);history.pushState(null,"",t),ga("set","page","/stash/"+t),ga("send","pageview")}n.empty().append(stash.loadingHint).load(`pages/${t}.html`,()=>s(n))}}).then(t=>(removeAllTooltips(),stash.cleanUpAnimations(),e||$("#searchbar input").val(""),stash.page.loaded(t.closest(".stash-page-wrapper>*")),t))),stash.page.identifier=(()=>new Promise(t=>{stash.page.identifierLoaded=(e=>{stash.page.identifierLoaded=null;const a=$(e).parent();$(e).remove(),t(a)})})),stash.page.loaded=(t=>{requestAnimationFrame(()=>{t.css("opacity",0).animate({opacity:1},500),stash.page.hasWork||stash.workComplete()})}),stash.page.optimizeScrolling=(t=>t.on("scroll",()=>{for(const t of document.querySelectorAll(".tippy-popper")){const e=t._tippy;e.state.visible&&(e.popperInstance.disableEventListeners(),e.hide())}})),stash.page.modal=((t,e="#content-wrapper")=>{if(removeAllTooltips(),t){const a=E("div").addClass("modal").appendTo(e).append(E("div").addClass("content stash-page-wrapper").append(stash.page.optimizeScrolling(E("div").addClass("stash-page-scroller").append(E("div").addClass("stash-page-content"))))).on("click",t=>{t.target==t.currentTarget&&stash.page.closeModal($(t.target))});return stash.page.load(t,a.find(".stash-page-content")).then(()=>{setTimeout(()=>a.addClass("open"),100);const e=E("div").addClass("go-to-page-button").attr("title","Go to page").on("click",()=>stash.page.load(t)).html($("#open-page-icon").html()).appendTo(a.find(".stash-page-wrapper"));tippy(e[0],{placement:"right"})}),a}return E("div").addClass("modal open").appendTo(e).append(E("div").addClass("content")).on("click",t=>{t.target==t.currentTarget&&stash.page.closeModal($(t.target))})}),stash.page.closeModal=(t=>new Promise(e=>{t.addClass("fading"),setTimeout(()=>{t.find(".stash-page-content").each((t,e)=>{"function"==typeof e.onUnload&&e.onUnload()}),t.remove(),stash.cleanUpAnimations(),e(t)},250)})),stash.page.requireLogin=(t=>e=>new Promise((a,s)=>{e.is("#content")?e[0].onUserLogout=(()=>stash.page.load("root")):e[0].onUserLogout=(()=>stash.page.closeModal(e.closest("modal"))),stash.firebase.getUser().then(n=>{if(n)return t?void n.getIdTokenResult().then(n=>{t.reduce((t,e)=>t=t||n.claims[e],!1)?a(e):s("Access denied.")}):void a(e);s("Access denied.")})})),(()=>{const t=/\(([^\(\)]*)\)/g,e=/^source=(.+)$/,a=/^sources([<>]?=|[<>])(\d+)$/,s=/^w([<>]?=|[<>])(\d+)$/,n=/^h([<>]?=|[<>])(\d+)$/,i=/^t([<>]?=|[<>])(\d+)$/,r=/^([<>]?=|[<>])?(\d+):(\d+)$/,o=/^([<>]=|[<>])\{(.+)\}$/,l=/^(?:([<>]?=|[<>])(\d+)|(\d+)(?:-(\d+))?)$/,c=/([^\s\|!])([!@])/g,d=/^"([a-z0-9][a-z0-9-]+[a-z0-9])"$/,h=/\s(?=(?:(?:[^"]*"){2})*[^"]*$)(?![^\{\}]*\})/g,p=/\.png$/,u=/\s+\|\s+|\s+\||\|\s+/g,m=/!\s+/g;stash.query={};const g=(t,p)=>{if(t.match(c))return g(t.replace(c,(t,e,a)=>e+" "+a),p);if(t.match(m))return g(t.replace(m,"!"),p);if(t.match(u))return g(t.replace(u,"|"),p);if(t.match(h))return{op:"AND",cons:t.split(h).filter(t=>t.length).map(t=>g(t,p)).filter(t=>t)};if(~t.indexOf("|"))return{op:"OR",cons:t.split("|").map(t=>t.trim()).filter(t=>t.length).map(t=>g(t,p)).filter(t=>t)};if(0===t.indexOf("!")){const e=g(t.substring(1),p);return e?{op:"NOT",con:e}:null}if(0===t.indexOf("ยง"))return g(p[t.substring(1)],p);if(0===t.indexOf("@"))return{type:"contributor",name:t.substring(1).replace(/"/g,"")};if(t.match(l)){const e=t.match(l);return e[4]?{type:"id",range:[parseInt(e[3]),parseInt(e[4])]}:{type:"id",op:e[1]||"=",id:parseInt(e[2]||e[3])}}if(t.match(e)){const a=t.match(e);return{type:"source",value:a[1].match(/^\d+$/)?parseInt(a[1]):a[1].replace(/"/g,"")}}if(t.match(a)){const e=t.match(a);return{type:"source-count",op:e[1],value:parseInt(e[2])}}if(t.match(s)){const e=t.match(s);return{type:"width",op:e[1],value:parseInt(e[2])}}if(t.match(n)){const e=t.match(n);return{type:"height",op:e[1],value:parseInt(e[2])}}if(t.match(i)){const e=t.match(i);return{type:"tag-count",op:e[1],value:parseInt(e[2])}}if(t.match(r)){const e=t.match(r);return{type:"aspect-ratio",op:e[1]||"=",value:parseInt(e[2])/parseInt(e[3]),x:parseInt(e[2]),y:parseInt(e[3])}}if(t.match(o)){const e=t.match(o);return{type:"date",op:e[1],date:new Date(e[2]),dateString:e[2]}}if(t.match(d)){return{type:"exact-tag",name:t.match(d)[1]}}return t.match(rgxValidTag)?t:null};stash.query.contributor=(t=>~t.indexOf(" ")?'@"'+t+'"':"@"+t),stash.query.toString=((t,e)=>"string"==typeof t||null==t?t:"AND"===t.op?(e?"(":"")+t.cons.map(t=>stash.query.toString(t,!0)).join(" ")+(e?")":""):"OR"===t.op?t.cons.map(t=>stash.query.toString(t,!0)).join("|"):"NOT"===t.op?"!"+stash.query.toString(t.con,!0):"contributor"===t.type?stash.query.contributor(t.name):"id"===t.type?(t.op&&"="!=t.op?t.op:"")+(t.range?t.range.join("-"):t.id):"source"===t.type?"string"==typeof t.value?"source="+(t.value.match(/\s/)?'"'+t.value+'"':t.value):"source="+t.value:"source-count"===t.type?"sources"+t.op+t.value:"width"===t.type?"w"+t.op+t.value:"height"===t.type?"h"+t.op+t.value:"tag-count"===t.type?"t"+t.op+t.value:"aspect-ratio"===t.type?(t.op&&"="!=t.op?t.op:"")+t.x+":"+t.y:"date"===t.type?t.op+"{"+t.dateString+"}":"exact-tag"===t.type?`"${t.name}"`:void 0),stash.query.parse=(e=>{const a=[];let s=e;for(;s.match(t);)s=s.replace(t,(t,e)=>(a.push(e),` ยง${a.length-1} `));return g(s,a)}),stash.query.match=((t,e,a)=>{if(a||(a=stash.tags.of(e)),null==t)return!1;if("string"==typeof t)return~stash.tags.names.alias.indexOf(t)?stash.query.match(stash.tags.alias[t],e,a):null!=a.find(e=>t==e.name);if(t.type){if("exact-tag"===t.type)return null!=a.find(e=>t.name==e.name);if("contributor"===t.type)return t.name==stash.data[e].contributor;if("id"===t.type){if(t.range)return stash.data[e].id>=t.range[0]&&stash.data[e].id<=t.range[1];if("="===t.op)return stash.data[e].id==t.id;if("<"===t.op)return stash.data[e].id<t.id;if(">"===t.op)return stash.data[e].id>t.id;if("<="===t.op)return stash.data[e].id<=t.id;if(">="===t.op)return stash.data[e].id>=t.id}else{if("source"===t.type&&stash.data[e].parents)return~stash.data[e].parents.indexOf(t.value);if("source-count"===t.type){const a=stash.data[e].parents?stash.data[e].parents.length:0;if("="===t.op)return a==t.value;if("<"===t.op)return a<t.value;if(">"===t.op)return a>t.value;if("<="===t.op)return a<=t.value;if(">="===t.op)return a>=t.value}else if("width"===t.type&&e.match(p)){if("="===t.op)return stash.data[e].size[0]==t.value;if("<"===t.op)return stash.data[e].size[0]<t.value;if(">"===t.op)return stash.data[e].size[0]>t.value;if("<="===t.op)return stash.data[e].size[0]<=t.value;if(">="===t.op)return stash.data[e].size[0]>=t.value}else if("height"===t.type&&e.match(p)){if("="===t.op)return stash.data[e].size[1]==t.value;if("<"===t.op)return stash.data[e].size[1]<t.value;if(">"===t.op)return stash.data[e].size[1]>t.value;if("<="===t.op)return stash.data[e].size[1]<=t.value;if(">="===t.op)return stash.data[e].size[1]>=t.value}else if("tag-count"===t.type){if("="===t.op)return(stash.data[e].tags.user||stash.data[e].tags.official).length==t.value;if("<"===t.op)return(stash.data[e].tags.user||stash.data[e].tags.official).length<t.value;if(">"===t.op)return(stash.data[e].tags.user||stash.data[e].tags.official).length>t.value;if("<="===t.op)return(stash.data[e].tags.user||stash.data[e].tags.official).length<=t.value;if(">="===t.op)return(stash.data[e].tags.user||stash.data[e].tags.official).length>=t.value}else if("aspect-ratio"===t.type&&e.match(p)){if("="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]==t.value;if("<"===t.op)return stash.data[e].size[0]/stash.data[e].size[1]<t.value;if(">"===t.op)return stash.data[e].size[0]/stash.data[e].size[1]>t.value;if("<="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]<=t.value;if(">="===t.op)return stash.data[e].size[0]/stash.data[e].size[1]>=t.value}else if("date"===t.type){if("<"===t.op)return stash.data[e].date<t.date;if(">"===t.op)return stash.data[e].date>t.date;if("<="===t.op)return stash.data[e].date<=t.date;if(">="===t.op)return stash.data[e].date>=t.date}}}else{if("AND"===t.op){for(let s=0;s<t.cons.length;s++)if(!stash.query.match(t.cons[s],e,a))return!1;return!0}if("OR"===t.op)return null!=t.cons.find(t=>stash.query.match(t,e,a));if("NOT"===t.op)return!stash.query.match(t.con,e,a)}return!1})})(),(()=>{const t=t=>{stash.page.closeModal($(".selection-required"));let e=stash.selection.files.length;if(e>0){$(".sp-search-wrapper .result").each((t,e)=>{let a=$(e).attr("data-file");stash.selection.contains(a)?$(e).addClass("selected"):$(e).removeClass("selected")});const a=stash.bounds(stash.selection.files).join("-"),s=stash.createMask(stash.selection.files,stash.search(a));t||(localStorage.setItem("stash-selection-range",a),localStorage.setItem("stash-selection-mask",s)),$("#selection-menu").removeClass("no-selection"),$("#selection-file-count").text(e),s.length>1e3?$("#selection-copy-link-button").addClass("hidden"):($("#clipboard-input").val("https://dokucraft.co.uk/stash/"+toURLParams({search:a,mask:s})),$("#selection-copy-link-button").removeClass("hidden"))}else t||(localStorage.removeItem("stash-selection-range"),localStorage.removeItem("stash-selection-mask")),$("#selection-menu").addClass("no-selection"),$(".selected.file").removeClass("selected")};stash.selection.contains=(t=>~stash.selection.files.indexOf(t)),stash.selection.download=(()=>{const t=stash.notify("Working...","working"),e=stash.blockInput(null,!1);stash.workIndeterminate();const a=new JSZip,s=[];let n=stash.selection.files.slice();n=n.concat(n.filter(t=>stash.data[t].mcmeta&&t.match(/\.png$/)).map(t=>t+".mcmeta"));let i=0,r=!1;for(let o=0;o<n.length&&!r;o++)s.push($.ajax(stash.url.files+n[o],{xhrFields:{responseType:"blob"}}).done(t=>{a.file(n[o],t,{createFolders:!0}),stash.setWorkProgress(++i/n.length)}).fail(a=>{r=!0,s.forEach(t=>t.abort()),stash.dismissNotification(t),stash.removeInputBlocker(e),stash.workComplete(),stash.notify(`Failed to load file: ${n[o]}<br>(${a.status} ${a.statusText})`,null,"error")}));Promise.all(s).then(()=>{a.generateAsync({type:"blob"}).then(a=>{stash.dismissNotification(t),stash.removeInputBlocker(e),stash.workComplete(),saveAs(a,"dokustash.zip")})})}),stash.selection.loadStored=(()=>{try{localStorage.getItem("stash-selection-range")&&localStorage.getItem("stash-selection-mask")&&(stash.selection.files=stash.search(localStorage.getItem("stash-selection-range"),stash.files,stash.decodeMask(localStorage.getItem("stash-selection-mask")))),stash.selection.files.forEach(t=>stash.data[t].tags.implicit.add("selected")),t(!0)}catch(t){console.error(t.toString()),stash.notify("Failed to load file selection.",null,"error")}}),stash.selection.add=(e=>{Array.isArray(e)?(e.forEach(t=>{stash.selection.contains(t)||(stash.selection.files.push(t),stash.data[t].tags.implicit.add("selected"))}),t()):stash.selection.contains(e)||(stash.selection.files.push(e),stash.data[e].tags.implicit.add("selected"),t())}),stash.selection.remove=(e=>{let a=stash.selection.files.indexOf(e);a>-1&&(stash.selection.files.splice(a,1),stash.data[e].tags.implicit.delete("selected"),t())}),stash.selection.clear=(()=>{stash.selection.files.forEach(t=>stash.data[t].tags.implicit.delete("selected")),stash.selection.files=[],t()}),$(()=>{$("#selection-deselect-all-button").on("click",stash.selection.clear),$("#selection-download-button").on("click",stash.selection.download),$("#selection-copy-link-button").on("click",()=>{$("#clipboard-input").select(),document.execCommand("Copy")}),$("#selection-tags-button").on("click",()=>{if($(".common-tags-modal").length>0)return;const t={};stash.selection.files.forEach(e=>{t[e]=(stash.data[e].tags.user||stash.data[e].tags.official).slice()});const e=e=>{const a=$(e.currentTarget).attr("data-tag-name");stash.selection.files.forEach(e=>{t[e]=t[e].filter(t=>t!=a)}),$(e.currentTarget).remove()},a=a=>{a.split(" ").filter(t=>t.length&&stash.tags.isValid(t)).forEach(a=>{stash.selection.files.forEach(e=>{~t[e].indexOf(a)||t[e].push(a)}),n.find(`[data-tag-name=${a}]`).length?n.find(`[data-tag-name=${a}]`).children(".count").text(stash.selection.files.length):n.find(".tags").append(E("span").addClass("tag with-count").append(a,E("span").addClass("count").text(stash.selection.files.length)).attr("data-tag-name",a).on("click",e))}),n.find(".tag-input input").val("")},s={};stash.selection.files.map(t=>stash.tags.of(t,!1)).reduce((t,e)=>t.concat(e),[]).forEach(t=>s[t.name]=(s[t.name]||0)+1);const n=stash.page.modal().addClass("selection-required selection-tag-editor");n.find(".content").css("width","800px").append(E("h2").text("Tags for selected files"),E("p").text("Below are all tags from the selected files and the number of times they occur. To add a tag to all of the selected files, type it into the field below and click Add. You can add multiple at once by separating each tag with a space. To remove a tag from all applicable files, click the tag in the list."),E("p").append(E("sup").addClass("faded").text("Tags may only contain lowercase letters, numbers and hyphens."),E("br"),E("sup").addClass("faded").text("Tags must not start or end with a hyphen and must contain at least one letter.")),E("br"),E("div").addClass("row").append(E("div").addClass("tag-input"),E("div").addClass("button add-button").text("Add")),E("br"),E("div").addClass("tags").append(Object.keys(s).sort((t,e)=>s[e]-s[t]).map(t=>E("span").addClass("tag with-count").append(t,E("span").addClass("count").text(s[t])).attr("data-tag-name",t).on("click",e))),E("br"),E("div").addClass("row").append(E("div").addClass("inline button").text("Cancel").on("click",t=>stash.page.closeModal(n)),E("div").addClass("inline button").text("Done").on("click",e=>{const a=[];if(stash.selection.files.forEach(e=>{t[e].sort(naturalSorter);const s=(stash.data[e].tags.user||stash.data[e].tags.official).slice();(s.length!=t[e].length||s.find(a=>!~t[e].indexOf(a))||t[e].find(t=>!~s.indexOf(t)))&&a.push({id:stash.data[e].id,tags:t[e].join(",")})}),a.length){const e=stash.notify("Validating tags...","working");stash.tags.updateUser(a).then(()=>{stash.selection.files.forEach(e=>{stash.data[e].tags.user=t[e],stash.tags.checkDynamicImplicits(e)}),stash.page.closeModal(n),stash.tags.updateNames(),stash.tags.updateElements()}).finally(()=>{stash.dismissNotification(e)})}else stash.page.closeModal(n)}),E("div").addClass("filler"),E("div").addClass("inline button warning tt").text("Reset").attr("title","Reset tags of selected files.").on("click",t=>{const e=stash.page.modal(null,n.find(".content")).addClass("selection-required selection-tag-editor");e.find(".content").append(E("h2").text("Are you sure?"),E("p").text("This will undo any changes to tags you have made for the selected files on this account."),E("div").addClass("row").append(E("div").addClass("inline button").text("Cancel").on("click",()=>stash.page.closeModal(e)),E("div").addClass("inline button warning").text("Reset tags").on("click",()=>{const t=stash.notify("Resetting tags...","working");stash.tags.updateUser(stash.selection.files.map(t=>({id:stash.data[t].id,tags:null}))).then(()=>{stash.selection.files.forEach(t=>{stash.data[t].tags.user=null,stash.tags.checkDynamicImplicits(t)}),stash.page.closeModal(n),stash.tags.updateNames(),stash.tags.updateElements()}).finally(()=>{stash.dismissNotification(t)})})))})));const i=/(^|\s)([a-z0-9-]+)$/;CCInput(n.find(".tag-input"),{placeholder:"Example: iron sword",lists:[{name:"Tags",list:stash.tags.names.explicit}],value:t=>{const e=t.match(i);return e?e[2]:""},replace:(t,e,a)=>t.replace(i,(t,a)=>a+e),enter:a}),n.find(".add-button").on("click",()=>a(n.find(".tag-input input").val())),tippy(n.find(".tt").toArray())})})})(),stash.tags={names:{implicit:["untagged","selected","latest","image","zip","model","ctm","cit","texture-set","animated","user-tagged","mcmeta"].sort(naturalSorter),explicit:[],all:[],nonHidden:[]},alias:{},hidden:["beholder-panorama","beholder-skybox"]},stash.tags.updateNames=(()=>{const t=new Set;stash.files.forEach(e=>{stash.data[e].tags.official.forEach(e=>t.add(e)),stash.data[e].tags.user&&stash.data[e].tags.user.forEach(e=>t.add(e))}),stash.tags.names.explicit=Array.from(t).sort(naturalSorter),stash.tags.names.alias=Object.keys(stash.tags.alias).sort(naturalSorter),stash.tags.names.all=[].concat(stash.tags.names.implicit,stash.tags.names.explicit,stash.tags.names.alias).filter((t,e,a)=>a.indexOf(t)==e).sort(naturalSorter),stash.tags.names.nonHidden=stash.tags.names.all.filter(t=>!~stash.tags.hidden.indexOf(t))}),stash.tags.of=((t,e=!0)=>{const a=(stash.data[t].tags.user||stash.data[t].tags.official).map(e=>({name:e,type:~stash.data[t].tags.official.indexOf(e)?"official":"user",hidden:!!~stash.tags.hidden.indexOf(e)}));if(e)for(const e of stash.data[t].tags.implicit.values())a.push({name:e,type:"implicit",hidden:!!~stash.tags.hidden.indexOf(e)});return a}),stash.tags.checkDynamicImplicits=(t=>{(stash.data[t].tags.user||stash.data[t].tags.official).length?stash.data[t].tags.implicit.delete("untagged"):stash.data[t].tags.implicit.add("untagged"),stash.data[t].tags.user?stash.data[t].tags.implicit.add("user-tagged"):stash.data[t].tags.implicit.delete("user-tagged")}),stash.tags.element=(t=>E("div").addClass("tags").attr("data-file",t).append(stash.tags.of(t).filter(t=>"implicit"!=t.type).map(t=>E("span").addClass(t.type+" tag").attr("data-tag",t.name).text(t.name)))),stash.tags.updateElements=(()=>{$(".tags[data-file]").each((t,e)=>$(e).replaceWith(stash.tags.element($(e).attr("data-file")))),$(".stash-page-content").each((t,e)=>"function"==typeof e.onTagsUpdate&&e.onTagsUpdate())}),stash.tags.updateUser=(t=>new Promise((e,a)=>{stash.firebase.post("/tags/user",t).then(e).catch(t=>{"string"==typeof t?stash.notify("Failed to update user tags: "+t,null,"error"):t.responseJSON?stash.notify(`Failed to update user tags: ${t.responseJSON.message}`,null,"error"):stash.notify(`Failed to update user tags: ${t.status} ${t.statusText}`,null,"error"),console.error("Failed to update user tags",t),a(t)})})),stash.tags.isValid=(t=>t.match(rgxValidTag)&&!t.match(rgxInvalidTag));