<script>(()=>{let e=()=>{if($("#content .selected").length>0){let e=$("#content .selected").length;$("#number-of-selected-files").text(`${e} file${1===e?"":"s"}`),$("#selection-options").css("display","flex"),$("#link-to-selected").val("https://dokucraft.co.uk/stash/"+toSearchURLParams({id:$("#content .selected").toArray().map(e=>parseInt(getID($(e).attr("data-file")))).sort().reduce((e,t)=>{if(0==e.length)return e.push([t]),e;let s=e[e.length-1];return s[s.length-1]==t-1?(s.push(t),e[e.length-1]=s.filter((e,t)=>0==t||t==s.length-1)):e.push([t]),e},[]).reduce((e,t,s)=>{let o=s>0?",":"";return 1==t.length?e+=o+t[0]:e+=`${o}${t[0]}-${t[1]}`,e},"")}))}else $("#selection-options").css("display","none")},t=t=>{$("#content .selected").removeClass("selected"),e()};$("#deselect-selected-button").on("click",t);let s=e=>{$("#download-selected-button").text("Working...").off("click",s);let t=new JSZip,o=$("#content .selected").toArray().map(e=>$(e).attr("data-file"));o=o.concat(o.filter(e=>stash.data[e].M&&e.match(/\.png$/)).map(e=>e+".mcmeta"));let l=0,n=!1,a=[];for(let e=0;e<o.length&&!n;e++){let r=new XMLHttpRequest;a.push(r),r.responseType="blob",r.onreadystatechange=function(){if(r.readyState==XMLHttpRequest.DONE&&200==r.status){t.file(o[e],r.response,{createFolders:!0}),l++;let n=Math.floor(100*l/o.length);stash.setWorkProgress(n),l==o.length&&t.generateAsync({type:"blob"}).then(e=>{saveAs(e,"dokustash.zip"),stash.workComplete(),$("#download-selected-button").text("Download").on("click",s)})}else r.status>=400&&(n=!0,a.forEach(e=>e.abort()),$("#download-selected-button").text("Error while downloading"),stash.workError(()=>{$("#download-selected-button").text("Download").on("click",s)}))},r.open("GET",cors+stashURL+o[e],!0),r.send()}};$("#download-selected-button").on("click",s);stash.page.onRemove=(()=>{$(".remove-on-page-change").remove(),$("#sorting-options").addClass("hidden"),$("#selection-options").css("display","none"),$("#deselect-selected-button").off("click",t),$("#download-selected-button").off("click",s)}),$("#title").after($("<h2>",{id:"results-count",class:"remove-on-page-change"})),$("#results-count").after($("<div>",{id:"select-all-button",class:"header-button remove-on-page-change",text:"Select All"}).on("click",t=>{$("#content .file:not(.hidden)").addClass("selected"),e()})),$("#select-all-button").after($("<div>",{id:"header-hint",class:"remove-on-page-change",text:"Right-click to select individual files"}));let o=decodeQuery();setSearchFormVals(o.category,o.contributor,o.id,o.size,o.color),o.id=stringToIDList(o.id),o.size=stringToSize(o.size);let l=stash.files.all;null!=o.category&&o.category.length>0&&(l=stash.files.category[o.category]),null!=o.contributor&&o.contributor.length>0&&(l=l.filter(contributorFilter(o.contributor))),null!=o.id&&o.id.length>0&&(l=l.filter(idFilter(o.id))),null!=o.size&&(l=l.filter(sizeFilter(o.size))),(t=>{if($("#content").empty(),0==t.length)return $("#content").append($("<div>",{class:"hint",text:"No results"})),void $("#results-count").text("");if(t.length>2500)return $("#content").append($("<div>",{class:"hint",text:"Too many results (2500+), try narrowing your search"})),void $("#results-count").text("");$("#results-count").text(`Results: ${t.length}`);for(let s=0;s<t.length;s++){let o=t[s],l=createFilePreview(o,$("<div>",{class:"result"}));l.on("click",()=>{goToPage(toURLParams({details:getID(o)}))}),l.on("contextmenu",t=>{l.is(".selected")?l.removeClass("selected"):l.addClass("selected"),e(),t.preventDefault(),t.stopPropagation()});let n=getID(o),a=stash.data[o].S;l.attr("title",`<h3>${getContributor(o)} #${n}</h3><br>`+(stash.data[o].Z?`Type: ${stash.typeNames[stash.data[o].Z]}<br>`:`Size: ${a[0]}x${a[1]}<br>`)+`Date: ${formatDate(stash.data[o].T||getApproxTime(n))}<br><br>`+`<i>${getCategory(o)}</i>`),tippy(l[0],{placement:"right",arrow:!0,animation:"perspective",performance:!0}),$("#content").append(l)}$("#sorting-options").removeClass("hidden"),updateResultGroups(),$(".spinner-container").css("display","none").slice(0,10).css("display","flex"),updateFileScale()})(l.sort(naturalSorter)),o.color&&filterResultsByColor()})();</script>