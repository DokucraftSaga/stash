<link rel="stylesheet" href="/stash/pages/css/animation-editor.css"/><input class="sp-ae-file-input hidden" type="file" accept=".png,.mcmeta,.json"/><div class="sp-ae-wrapper"><div class="sp-ae-mcmeta-editor"><div class="tabs"><h2>Animation Editor</h2><div class="filler"></div><label><input type="radio" name="sp-ae-tabs" checked="checked"/><div class="tab">GUI</div><div class="tab-content"><div class="row">Frametime: <div class="sp-ae-mcmeta-frametime"></div><div class="sp-ae-mcmeta-interpolate filler"></div></div><div class="row"><h3>Frames</h3><div class="filler"></div><div class="sp-ae-mcmeta-add-frame button">Add</div></div><div class="sp-ae-mcmeta-frames-container"><ol class="sp-ae-mcmeta-frames"></ol><div class="sp-ae-mcmeta-frames-header row"><span>Index</span><span>Time</span><span></span></div></div></div></label><label><input type="radio" name="sp-ae-tabs"/><div class="tab">JSON</div><div class="tab-content"><textarea class="sp-ae-mcmeta-raw-json" spellcheck="false"></textarea><span class="sp-ae-mcmeta-json-status error"></span></div></label></div></div><div class="sp-ae-preview-pane"><div class="sp-ae-preview-container"><div class="sp-ae-static-preview" style="display:none;"></div></div><a class="sp-ae-download-image-link" style="display:none;" download="animation.png">Download Image</a><br/><div class="row"><div class="sp-ae-generate-link-button button" style="display:none;">Generate Shareable Link</div><div class="sp-ae-shareable-link" style="display:none;"></div><div class="sp-ae-copy-link-button button" style="display:none;">Copy</div></div></div><div class="sp-ae-frames-list-scroller"><div class="sp-ae-frames-list"></div></div></div><script>stash.page.identifier().then(async e=>{let a,t="",n={animation:{}};const i=()=>{n={animation:{}};const a=e.find(".sp-ae-mcmeta-frametime input").val();a.length>0&&"1"!=a&&(n.animation.frametime=parseInt(a));const t=e.find(".sp-ae-mcmeta-frames").children();t.length>0&&(n.animation.frames=[],t.toArray().forEach(e=>{const t=parseInt($(e).find(".sp-ae-mcmeta-frame-index input").val()),i=parseInt($(e).find(".sp-ae-mcmeta-frame-time input").val());i==a||isNaN(i)?n.animation.frames.push(t):n.animation.frames.push({index:t,time:i})})),"true"==e.find(".sp-ae-mcmeta-interpolate")[0].val()&&(n.animation.frametime||n.animation.frames)&&(n.animation.interpolate=!0),e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(n,null,2)),e.find(".sp-ae-mcmeta-json-status").text(""),s()},s=()=>{if(t.length>0){a&&a.stop(),a=new MCAnimation(t,n);const i=e.find(".sp-ae-preview-container");i.children(".mc-animation").remove(),i.append(a.canvas);const s=e.find(".sp-ae-static-preview");s.css("background-image",`url(${t})`);const r=e.find(".sp-ae-frames-list");a.texture.addEventListener("load",()=>{r.empty().css("background-image",`url(${t})`);let e=a.frameIndex;for(let t=0;t<a.texture.height/a.texture.width;t++)r.append(E("div").addClass("sp-ae-frame-index"+(t==e?" active":"")).text(t).on("mouseenter",()=>{a.pause(),$(a.canvas).hide(),s.show().css("background-position","0 "+-256*t+"px"),r.children().removeClass("active"),r.children().eq(t).addClass("active")}).on("mouseleave",()=>{a.play(),s.hide(),$(a.canvas).show(),r.children().removeClass("active"),r.children().eq(a.frameIndex).addClass("active")}))}),a.onNewFrame=(()=>{a.playing&&(r.children().removeClass("active"),r.children().eq(a.frameIndex).addClass("active"))}),e.find(".sp-ae-download-image-link").attr("href",t).show(),e.find(".sp-ae-generate-link-button").css("display","flex"),e.find(".sp-ae-shareable-link").hide(),e.find(".sp-ae-shareable-link input").val(""),e.find(".sp-ae-copy-link-button").css("display","none")}},r=(a=!0)=>{a&&e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(n,null,2)),n.hasOwnProperty("animation")?(n.animation.hasOwnProperty("frametime")?e.find(".sp-ae-mcmeta-frametime input").val(n.animation.frametime):e.find(".sp-ae-mcmeta-frametime input").val(1),n.animation.hasOwnProperty("interpolate")&&n.animation.interpolate?e.find(".sp-ae-mcmeta-interpolate")[0].val(!0):e.find(".sp-ae-mcmeta-interpolate")[0].val(!1),n.animation.hasOwnProperty("frames")&&Array.isArray(n.animation.frames)?e.find(".sp-ae-mcmeta-frames").empty().append(n.animation.frames.map(e=>E("li").addClass("sp-ae-mcmeta-frame row").append(CCInput(E("div").addClass("sp-ae-mcmeta-frame-index filler"),{type:"number",min:0,default:"number"==typeof e?e:e.index}).children(".ccin-input").on("input change",i).parent(),CCInput(E("div").addClass("sp-ae-mcmeta-frame-time filler"),{type:"number",min:1,default:"number"==typeof e?"":e.time}).children(".ccin-input").on("input change",i).parent(),E("div").addClass("button warning").text("X").on("click",e=>{$(e.currentTarget).parent().remove(),i()})))):e.find(".sp-ae-mcmeta-frames").empty()):(e.find(".sp-ae-mcmeta-frametime input").val(1),e.find(".sp-ae-mcmeta-interpolate")[0].val(!1),e.find(".sp-ae-mcmeta-frames").empty()),s()};CCInput(e.find(".sp-ae-mcmeta-frametime"),{type:"number",min:1,default:1}).children(".ccin-input").on("input change",i),CCInput(e.find(".sp-ae-mcmeta-interpolate"),{type:"select",lists:[{list:[{name:"No interpolation",value:!1,selected:!0},{name:"Interpolate between frames",value:!0}]}]}).on("change",i),e.find(".sp-ae-mcmeta-add-frame").on("click",()=>{e.find(".sp-ae-mcmeta-frames").append(E("li").addClass("sp-ae-mcmeta-frame row").append(CCInput(E("div").addClass("sp-ae-mcmeta-frame-index filler"),{type:"number",min:0,default:e.find(".sp-ae-mcmeta-frames").children().length}).children(".ccin-input").on("input change",i).parent(),CCInput(E("div").addClass("sp-ae-mcmeta-frame-time filler"),{type:"number",min:1,default:""}).children(".ccin-input").on("input change",i).parent(),E("div").addClass("button warning").text("X").on("click",e=>{$(e.currentTarget).parent().remove(),i()}))),i()}),e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(n,null,2)).on("change input",a=>{try{n=JSON.parse($(a.currentTarget).val()),e.find(".sp-ae-mcmeta-json-status").text(""),r(!1)}catch(a){e.find(".sp-ae-mcmeta-json-status").text(a.toString())}});const o=a=>{Promise.all(a.map(a=>new Promise(i=>{const s=/\.([^\.]+)$/.exec(a.name)[1].toLowerCase();if("png"==s){const e=new FileReader;e.onload=(e=>{t=e.target.result,i()}),e.readAsDataURL(a)}else if("mcmeta"==s||"json"==s){const t=new FileReader;t.onload=(a=>{e.find("sp-ae-mcmeta-raw-json").val(a.target.result);try{n=JSON.parse(a.target.result),e.find(".sp-ae-mcmeta-json-status").text("")}catch(a){e.find(".sp-ae-mcmeta-json-status").text(a.toString())}finally{i()}}),t.readAsText(a)}}))).then(()=>{r()})},m=e.find(".sp-ae-file-input");m.on("change",()=>{m[0].files&&o(Array.from(m[0].files)),m.val(null)}),e.find(".sp-ae-preview-container").on("click",()=>{m.trigger("click")});const l=e.find(".sp-ae-wrapper");l.on("dragover dragenter",e=>(e.preventDefault&&e.preventDefault(),!1)),l.on("drop",e=>{(e=e||window.event).preventDefault&&e.preventDefault();const a=e.originalEvent.dataTransfer;return o(Array.from(a.files)),!1});const p=getURLParams(e.attr("data-params"))["animation-editor"];if("string"==typeof p)if(~p.indexOf("id:")){const e=p.substring(3);if(~e.indexOf(":")){const a=e.split(":"),i=stash.nameOf(a[0]);if(!i)return void stash.notify("Parent file not found",null,"error");if("zip"!=stash.data[i].ext)return void stash.notify("Parent file is not a zip",null,"error");stash.workIndeterminate(),stash.getZIPContent(i).then(e=>{const i=e.find(e=>a[1]==(e.path.length>0?e.path+"/":"")+e.name);if(i){t="data:image/png;base64,"+i.content;const s=a[1]+".mcmeta",o=e.find(e=>s==(e.path.length>0?e.path+"/":"")+e.name);n=o?JSON.parse(o.content):{animation:{}},r(),stash.workComplete()}else stash.workError(),stash.notify("File not found",null,"error")})}else{const a=stash.nameOf(e);if(!a)return void stash.notify("File not found",null,"error");if("png"!=stash.data[a].ext)return void stash.notify("File is not an image",null,"error");t=stash.url.files+a,stash.data[a].mcmeta?(stash.workIndeterminate(),$.ajax(stash.url.files+a+".mcmeta").done(e=>{n=JSON.parse(e),stash.workComplete(),r()}).fail(e=>{stash.workError(),stash.notify(`Failed to load MCMETA. (${e.status} ${e.statusText})`,null,"error")})):(n={animation:{}},r())}}else{const e=await stash.api.get(`/animation/${p}`);if(void 0===e)return void stash.notify("Animation not found",null,"error");t=~e.image.indexOf(":")||~e.image.indexOf("/stash-files/")?e.image:"data:image/png;base64,"+e.image,n=e.mcmeta?e.mcmeta:{animation:{}},r()}e.find(".sp-ae-generate-link-button").on("click",async()=>{if(t.length<22)return void stash.notify("Invalid animation strip",null,"error");const a={image:t.replace("data:image/png;base64,","")};n&&n.animation&&Object.keys(n.animation).length>0&&(a.mcmeta={animation:n.animation});const i=stash.blockInput(!1,null),s=stash.notify("Working...","working");try{const t=await stash.api.post("/animation",JSON.stringify(a));if(t.status>=400)throw"Server error";const n=await t.text();e.find(".sp-ae-generate-link-button").css("display","none"),e.find(".sp-ae-shareable-link").show(),e.find(".sp-ae-shareable-link input").val("https://dokucraft.co.uk/stash/?animation-editor="+n),e.find(".sp-ae-copy-link-button").css("display","flex"),stash.dismissNotification(s),stash.removeInputBlocker(i)}catch(e){"string"==typeof e?stash.notify(`Failed to generate link: ${e}`,null,"error"):e.responseJSON?stash.notify(`Failed to generate link: ${e.responseJSON.message}`,null,"error"):stash.notify(`Failed to generate link: ${e.status} ${e.statusText}`,null,"error"),console.error("Failed to generate link",e),stash.dismissNotification(s),stash.removeInputBlocker(i)}}),CCInput(e.find(".sp-ae-shareable-link")).find("input").prop("readonly",!0),e.find(".sp-ae-copy-link-button").on("click",a=>{e.find(".sp-ae-shareable-link input").select(),document.execCommand("Copy")})});</script><img onload="stash.page.identifierLoaded(this);void(0);" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="/>