<input class="sp-ae-file-input hidden" type="file" accept=".png,.mcmeta,.json"/><div class="sp-ae-wrapper"><div class="sp-ae-mcmeta-editor"><div class="tabs"><h2>Animation Editor</h2><div class="filler"></div><label><input type="radio" name="sp-ae-tabs" checked="checked"/><div class="tab">GUI</div><div class="tab-content"><div class="row">Frametime: <div class="sp-ae-mcmeta-frametime"></div><div class="sp-ae-mcmeta-interpolate filler"></div></div><div class="row"><h3>Frames</h3><div class="filler"></div><div class="sp-ae-mcmeta-add-frame button">Add</div></div><ol class="sp-ae-mcmeta-frames"></ol></div></label><label><input type="radio" name="sp-ae-tabs"/><div class="tab">JSON</div><div class="tab-content"><textarea class="sp-ae-mcmeta-raw-json" spellcheck="false"></textarea><span class="sp-ae-mcmeta-json-status error"></span></div></label></div></div><div class="sp-ae-preview-pane"><div class="sp-ae-preview-container"><div class="sp-ae-static-preview" style="display:none;"></div></div><a class="sp-ae-download-image-link" style="display:none;" download="animation.png">Download Image</a><br/><div class="row"><div class="sp-ae-generate-link-button button" style="display:none;">Generate Shareable Link</div><div class="sp-ae-shareable-link" style="display:none;"></div><div class="sp-ae-copy-link-button button" style="display:none;">Copy</div></div></div><div class="sp-ae-frames-list-scroller"><div class="sp-ae-frames-list"></div></div></div><link rel="stylesheet" href="/stash/pages/css/animation-editor.css"/><script>stash.page.identifier().then(e=>{let a,n="",t={animation:{}};const i=()=>{t={animation:{}};const a=e.find(".sp-ae-mcmeta-frametime input").val();a.length>0&&"1"!=a&&(t.animation.frametime=parseInt(a));const n=e.find(".sp-ae-mcmeta-frames").children();n.length>0&&(t.animation.frames=[],n.toArray().forEach(e=>{const n=parseInt($(e).find(".sp-ae-mcmeta-frame-index input").val()),i=parseInt($(e).find(".sp-ae-mcmeta-frame-time input").val());i==a||isNaN(i)?t.animation.frames.push(n):t.animation.frames.push({index:n,time:i})})),"true"==e.find(".sp-ae-mcmeta-interpolate")[0].val()&&(t.animation.frametime||t.animation.frames)&&(t.animation.interpolate=!0),e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(t,null,2)),e.find(".sp-ae-mcmeta-json-status").text(""),s()},s=()=>{if(n.length>0){a&&a.stop(),a=new MCAnimation(n,t);const i=e.find(".sp-ae-preview-container");i.children(".mc-animation").remove(),i.append(a.canvas);const s=e.find(".sp-ae-static-preview");s.css("background-image",`url(${n})`);const r=e.find(".sp-ae-frames-list");a.texture.addEventListener("load",()=>{r.empty().css("background-image",`url(${n})`);let e=a.frameIndex;for(let n=0;n<a.texture.height/a.texture.width;n++)r.append(E("div").addClass("sp-ae-frame-index"+(n==e?" active":"")).text(n).on("mouseenter",()=>{a.pause(),$(a.canvas).hide(),s.show().css("background-position","0 "+-256*n+"px"),r.children().removeClass("active"),r.children().eq(n).addClass("active")}).on("mouseleave",()=>{a.play(),s.hide(),$(a.canvas).show(),r.children().removeClass("active"),r.children().eq(a.frameIndex).addClass("active")}))}),a.onNewFrame=(()=>{a.playing&&(r.children().removeClass("active"),r.children().eq(a.frameIndex).addClass("active"))}),e.find(".sp-ae-download-image-link").attr("href",n).show(),e.find(".sp-ae-generate-link-button").css("display","flex"),e.find(".sp-ae-shareable-link").hide(),e.find(".sp-ae-shareable-link input").val(""),e.find(".sp-ae-copy-link-button").css("display","none")}},r=(a=!0)=>{a&&e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(t,null,2)),t.hasOwnProperty("animation")?(t.animation.hasOwnProperty("frametime")?e.find(".sp-ae-mcmeta-frametime input").val(t.animation.frametime):e.find(".sp-ae-mcmeta-frametime input").val(1),t.animation.hasOwnProperty("interpolate")&&t.animation.interpolate?e.find(".sp-ae-mcmeta-interpolate")[0].val(!0):e.find(".sp-ae-mcmeta-interpolate")[0].val(!1),t.animation.hasOwnProperty("frames")&&Array.isArray(t.animation.frames)?e.find(".sp-ae-mcmeta-frames").empty().append(t.animation.frames.map(e=>E("li").addClass("sp-ae-mcmeta-frame row").append("Index: ",CCInput(E("div").addClass("sp-ae-mcmeta-frame-index"),{type:"number",min:0,default:"number"==typeof e?e:e.index}).children(".ccin-input").on("input change",i).parent(),"Time: ",CCInput(E("div").addClass("sp-ae-mcmeta-frame-time"),{type:"number",min:1,default:"number"==typeof e?"":e.time}).children(".ccin-input").on("input change",i).parent(),E("div").addClass("button warning").text("X").on("click",e=>{$(e.currentTarget).parent().remove(),i()})))):e.find(".sp-ae-mcmeta-frames").empty()):(e.find(".sp-ae-mcmeta-frametime input").val(1),e.find(".sp-ae-mcmeta-interpolate")[0].val(!1),e.find(".sp-ae-mcmeta-frames").empty()),s()};CCInput(e.find(".sp-ae-mcmeta-frametime"),{type:"number",min:1,default:1}).children(".ccin-input").on("input change",i),CCInput(e.find(".sp-ae-mcmeta-interpolate"),{type:"select",lists:[{list:[{name:"No interpolation",value:!1,selected:!0},{name:"Interpolate between frames",value:!0}]}]}).on("change",i),e.find(".sp-ae-mcmeta-add-frame").on("click",()=>{e.find(".sp-ae-mcmeta-frames").append(E("li").addClass("sp-ae-mcmeta-frame row").append("Index: ",CCInput(E("div").addClass("sp-ae-mcmeta-frame-index"),{type:"number",min:0,default:e.find(".sp-ae-mcmeta-frames").children().length}).children(".ccin-input").on("input change",i).parent(),"Time: ",CCInput(E("div").addClass("sp-ae-mcmeta-frame-time"),{type:"number",min:1,default:""}).children(".ccin-input").on("input change",i).parent(),E("div").addClass("button warning").text("X").on("click",e=>{$(e.currentTarget).parent().remove(),i()}))),i()}),e.find(".sp-ae-mcmeta-raw-json").val(JSON.stringify(t,null,2)).on("change input",a=>{try{t=JSON.parse($(a.currentTarget).val()),e.find(".sp-ae-mcmeta-json-status").text(""),r(!1)}catch(a){e.find(".sp-ae-mcmeta-json-status").text(a.toString())}});const m=a=>{Promise.all(a.map(a=>new Promise(i=>{const s=/\.([^\.]+)$/.exec(a.name)[1].toLowerCase();if("png"==s){const e=new FileReader;e.onload=(e=>{n=e.target.result,i()}),e.readAsDataURL(a)}else if("mcmeta"==s||"json"==s){const n=new FileReader;n.onload=(a=>{e.find("sp-ae-mcmeta-raw-json").val(a.target.result);try{t=JSON.parse(a.target.result),e.find(".sp-ae-mcmeta-json-status").text("")}catch(a){e.find(".sp-ae-mcmeta-json-status").text(a.toString())}finally{i()}}),n.readAsText(a)}}))).then(()=>{r()})},o=e.find(".sp-ae-file-input");o.on("change",()=>{o[0].files&&m(Array.from(o[0].files)),o.val(null)}),e.find(".sp-ae-preview-container").on("click",()=>{o.trigger("click")});const p=e.find(".sp-ae-wrapper");p.on("dragover dragenter",e=>(e.preventDefault&&e.preventDefault(),!1)),p.on("drop",e=>{(e=e||window.event).preventDefault&&e.preventDefault();const a=e.originalEvent.dataTransfer;return m(Array.from(a.files)),!1});const l=getURLParams(e.attr("data-params"))["animation-editor"];"string"==typeof l&&stash.firebase.db.collection("animations").doc(l).get().then(e=>{const a=e.data();void 0!==a?(n="data:image/png;base64,"+a.image,t=a.mcmeta?a.mcmeta:{animation:{}},r()):stash.notify("Animation not found",null,"error")}),e.find(".sp-ae-generate-link-button").on("click",()=>{if(n.length<22)return void stash.notify("Invalid animation strip",null,"error");const a={image:n.replace("data:image/png;base64,","")};t&&t.animation&&Object.keys(t.animation).length>0&&(a.mcmeta={animation:t.animation});const i=stash.blockInput(!1,null),s=stash.notify("Working...","working");$.ajax({url:stash.url.cloudFunctions+"/animation",type:"POST",dataType:"json",contentType:"application/json",data:JSON.stringify(a)}).done(a=>{e.find(".sp-ae-generate-link-button").css("display","none"),e.find(".sp-ae-shareable-link").show(),e.find(".sp-ae-shareable-link input").val("https://dokucraft.co.uk/stash/?animation-editor="+a.id),e.find(".sp-ae-copy-link-button").css("display","flex"),stash.dismissNotification(s),stash.removeInputBlocker(i)}).fail(e=>{e.responseJSON?stash.notify(`Failed to generate link: ${e.responseJSON.message}`,null,"error"):stash.notify(`Failed to generate link: ${e.status} ${e.statusText}`,null,"error"),console.log("Failed to generate link",e),stash.dismissNotification(s),stash.removeInputBlocker(i)})}),CCInput(e.find(".sp-ae-shareable-link")).find("input").prop("readonly",!0),e.find(".sp-ae-copy-link-button").on("click",a=>{e.find(".sp-ae-shareable-link input").select(),document.execCommand("Copy")})});</script><img onload="stash.page.identifierLoaded(this);void(0);" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="/>