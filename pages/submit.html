<div class="fill full-height" id="submit-page"><h2>Submit Files</h2><a id="login-status">Logging in...</a><p class="short">This page is for contributors. From here you can submit files to the stash. The files will be reviewed manually before being added and will not show up in the stash before they are approved.</p><br/><h2>Add and sort files</h2><p><i>Each file must be less than 2 MBs.</i></p><div class="button inline" onclick="$(&quot;#file-input&quot;)[0].click()">Browse local files</div><span> or simply drag or paste images here.</span><br/><br/><p class="short">To sort files into categories, select one or more files by clicking on them, then choose a category to sort them into and click 'Sort selected'. If you make a mistake you can sort a file again after putting it back into the unsorted list by clicking it again.</p><p><i>All files must be sorted before you can submit them.</i></p><p><i>All ZIP files must have a thumbnail image and be tagged with the appropriate package type before submitting.</i></p><br/><div class="text-input tt" title="&lt;h3&gt;Category name&lt;/h3&gt;&lt;br&gt;&lt;i&gt;Must match name exactly&lt;/i&gt;"><input id="sorter-category-input" type="text" spellcheck="false" placeholder="Category"/><span></span></div><div class="button inline tt" id="select-category-button" title="Select category from list">...</div><div class="button inline when-any-selected disabled" id="sort-selected-button">Sort selected</div><div class="button inline when-any-selected disabled" onclick="$(&quot;#unsorted-files .selected&quot;).removeClass(&quot;selected&quot;)">Deselect all</div><div class="button inline when-any-selected disabled" id="remove-selected-button">Remove selected</div><br/><h3>Unsorted files</h3><div id="unsorted-files"></div><div class="content" id="sorted-files"></div><h2>Submit for approval</h2><p class="short">Before you submit the files, you need to enter the name of the contributor who made them below. The files will be renamed to follow the format <code>&lt;Contributor Name&gt;_&lt;ID&gt;.png</code> before being added to the stash and this is where the name is used.</p><br/><div class="text-input tt" title="&lt;h3&gt;Contributor name&lt;/h3&gt;&lt;br&gt;&lt;i&gt;Only autocompletes names of contributors that already have textures in the stash; if your name is not in the list, just ignore it and type in the name manually.&lt;/i&gt;"><input id="sorter-name-input" type="text" spellcheck="false" placeholder="Name"/><span></span></div><div class="button inline disabled" id="submit-button">Submit</div><span id="submit-status"></span><input id="file-input" type="file" accept=".png,.zip" style="visibility:hidden;" multiple="multiple"/></div><script>(()=>{let e=null,t=[],a=/\.(png|zip)$/,l=null,n=!1,s=(e,i,n,s)=>{t.push({type:i,content:s.split(/;base64,/)[1]});let o=$("<div>",{class:"local file"}).attr("title",n?`<h3>${e}</h3><i>${n}</i>`:`<h3>${e}</h3>`).attr("data-file-index",t.length-1).on("click",e=>{if(o.is(".sorted")){let e=o.parent();return o.removeClass("sorted").detach().appendTo($("#unsorted-files")),0==e.find(".local.file").length&&e.remove(),void $("#submit-button").addClass("disabled")}o.is(".selected")?o.removeClass("selected"):o.addClass("selected");0==$("#unsorted-files .selected").length?$("#content .when-any-selected").addClass("disabled"):$("#content .when-any-selected").removeClass("disabled")}),r=$("<div>",{class:"overlay"}).appendTo(o);if(tippy(o[0],{arrow:!0,animation:"perspective",placement:"right"}),"png"==i){o.addClass("png").append($("<div>",{class:"img"}).css("background-image",`url(${s})`)),r.append($("<div>",{class:"action-button fullscreen-button",title:"Fullscreen"}).on("click",e=>{$("#fullscreen-cover").removeClass("hidden").css("background-image",`url(${s}), url(resources/transparent.png)`),e.stopPropagation()}));let e=new Image;e.onload=(()=>{e.width<128&&e.height<128&&o.addClass("pixelated")}),e.src=s}else"zip"==i&&(o.addClass("zip no-thumbnail"),r.append($("<div>",{class:"action-button add-thumbnail-button",title:"Add thumbnail"}).on("click",e=>{l=(()=>{$("#file-input").attr("multiple","").attr("accept",".png,.zip");let e=$("#file-input")[0].files[0];if(!e||e.size/1048576>2||!e.name.match(a))return;let i=new FileReader;i.onload=(()=>{o.removeClass("no-thumbnail").append($("<div>",{class:"img"}).css("background-image",`url(${i.result})`)),t[o.attr("data-file-index")].thumbnail=i.result.split(/;base64,/)[1];let e=new Image;e.onload=(()=>{e.width<128&&e.height<128?o.addClass("pixelated"):o.removeClass("pixelated")}),e.src=i.result}),i.readAsDataURL(e)}),$("#file-input").attr("multiple",null).attr("accept",".png")[0].click(),e.stopPropagation()})));r.append($("<div>",{class:"action-button mcmeta-button",title:"zip"==i?"Edit thumbnail mcmeta":"Edit mcmeta"}).on("click",e=>{$("#submit-page").hide(),removeAllTooltips();let a=$("<div>",{class:"fill"}).append($("<h2>").text("Add mcmeta file")).append($("<p>").text("Paste or type in the content of this texture's mcmeta file below.")).append($("<textarea>",{id:"mcmeta-input",spellcheck:!1}).on("input",e=>{let t=a.find("#mcmeta-input").val();if(t&&0!=t.length)try{JSON.parse(t),a.find("#done-button").removeClass("disabled").attr("title","Set the mcmeta of the texture to the above text")}catch(e){a.find("#done-button").addClass("disabled").attr("title",e.toString())}else a.find("#done-button").removeClass("disabled").attr("title","Remove mcmeta from texture")})).append($("<div>",{id:"done-button",class:"button disabled inline",text:"Done",title:"Enter mcmeta content above"}).on("click",e=>{if($(e.currentTarget).is(".disabled"))return;let i=a.find("#mcmeta-input").val();i&&0!=i.length?(t[o.attr("data-file-index")].mcmeta=JSON.parse(i),o.addClass("mcmeta")):(o.removeClass("mcmeta"),delete t[o.attr("data-file-index")].mcmeta),a.remove(),$("#submit-page").show()})).append($("<div>",{class:"button inline",text:"Cancel"}).on("click",e=>{a.remove(),$("#submit-page").show()})).appendTo($("#content")),i=t[o.attr("data-file-index")].mcmeta;a.find("#mcmeta-input").val(i?JSON.stringify(i,null,2):"").focus(),i&&a.find("#done-button").removeClass("disabled").attr("title","Add this mcmeta to the texture"),tippy(a.find("#done-button")[0],{placement:"right",arrow:!0,animation:"perspective",dynamicTitle:!0}),window.scrollTo(0,0),e.stopPropagation()})),"zip"==i&&r.append($("<div>",{class:"action-button set-tag-button",title:"Set tag"}).on("click",e=>{$("#submit-page").hide(),removeAllTooltips();let a=$("<div>",{class:"fill"}).append($("<h2>").text("Tag file")).append($("<p>",{class:"short"}).text("Because the stash doesn't automatically check what zip files contain, you must tag it with the appropriate type. Select one from the list below.")).append($("<div>",{class:"select"}).append($("<select>",{id:"tag-input"}).append($("<option>",{value:"model",selected:"selected",text:"Model"})).append($("<option>",{value:"ctm",text:"CTM"})).append($("<option>",{value:"cit",text:"CIT"})))).append($("<div>",{id:"done-button",class:"button inline",text:"Done"}).on("click",e=>{let i=a.find("#tag-input").val();i&&0!=i.length&&~["model","ctm","cit"].indexOf(i)&&(t[o.attr("data-file-index")].tag=i,o.addClass("tagged"),o.find(".set-tag-button").attr("title",`<p>Edit tag</p><i>Current tag: ${i}</i>`),a.remove(),$("#submit-page").show())})).append($("<div>",{class:"button inline",text:"Cancel"}).on("click",e=>{a.remove(),$("#submit-page").show()})).appendTo($("#content")),i=t[o.attr("data-file-index")].tag;i&&a.find("#tag-input").val(i),window.scrollTo(0,0),e.stopPropagation()})),tippy(r.find(".action-button").toArray(),{arrow:!0,animation:"perspective",performance:!0,dynamicTitle:!0}),$("#unsorted-files").append(o)},o=o=>{if(null==e)return;$("#login-status").addClass("logged-in").text("Logged in as "+o).on("click",()=>{localStorage.removeItem("gh-login-token"),goToPage("login")}),$("#file-input").on("change",()=>{if("function"==typeof l)return l(),l=null,void $("#file-input").val(null);let e=$("#file-input")[0];for(let t=0;t<e.files.length;t++){let i=e.files[t];if(i.size/1048576>2||!i.name.match(a))continue;let l=new FileReader;l.onload=(()=>{s(i.name.replace(a,""),a.exec(i.name)[1],"Local file",l.result)}),l.readAsDataURL(i)}$("#file-input").val(null)});let r=e=>{let t=(e.clipboardData||e.originalEvent.clipboardData).items;for(i in t)if(t.hasOwnProperty(i)){let e=t[i];if("image/png"===e.type){let t=e.getAsFile();if(t.size/1048576>2)continue;let a=new FileReader;a.onload=(e=>{s("Image from clipboard","png",null,a.result)}),a.readAsDataURL(t)}}};$(document).on("paste",r),$("#submit-page").on("drop",e=>{e.stopPropagation(),e.preventDefault();let t=e.originalEvent.dataTransfer.files;if(t)for(i in t)if(t.hasOwnProperty(i)){let e=t[i];if(e.name.match(a)&&e.size/1048576<=2){let t=new FileReader;t.onload=(i=>{s(e.name.replace(a,""),a.exec(e.name)[1],"Local file",t.result)}),t.readAsDataURL(e)}}}),$("#submit-page").on("dragover",e=>{e.stopPropagation(),e.preventDefault()}),$("#select-category-button").on("click",()=>{$("#submit-page").hide(),removeAllTooltips();let e=$("<div>",{class:"fill"}).append($("<h2>").text("Choose a category")).appendTo($("#content")),t=$("<div>",{class:"content"}).appendTo(e);for(let a=0;a<stash.categories.length;a++){let i=stash.categories[a],l=$("<a>",{class:"category button"});l.on("click",t=>{e.remove(),$("#sorter-category-input").val(i),$("#submit-page").show()}),l.append($("<div>",{class:"img b-lazy"}).attr("data-src",`/stash/resources/category-icons/${i}.png`).append($("<div>",{class:"spinner-container"}).append($("<div>",{class:"spinner"})))),l.append($("<p>",{text:i})),t.append(l)}window.scrollTo(0,0)}),$("#sort-selected-button").on("click",()=>{let e=$("#sorter-category-input").val();if(!~stash.categories.indexOf(e))return;let t=$("#unsorted-files .selected");if(0==t.length)return;let a=$(`#sorted-files .group[data-category-name="${e}"]`);0==a.length&&((a=$("<div>",{class:"group"}).append($("<h3>",{text:e}))).attr("data-category-name",e),$("#sorted-files").append(a));for(var i=0;i<t.length;i++)$(t[i]).removeClass("selected").addClass("sorted").detach().appendTo(a);$("#content .when-any-selected").addClass("disabled"),$("#unsorted-files").is(":empty")&&!$("#sorted-files").is(":empty")&&$("#submit-button").removeClass("disabled")}),$("#remove-selected-button").on("click",()=>{$("#unsorted-files .selected").remove();let e=[];files=$(".local.file").each((a,i)=>{e.push(t[$(i).attr("data-file-index")]),$(i).attr("data-file-index",e.length-1)}),t=e,0==$("#unsorted-files .file").length&&$("#sorted-files .file").length>0?$("#submit-button").removeClass("disabled"):$("#submit-button").addClass("disabled")}),$("#submit-button").on("click",()=>{if(n)return;if($("#submit-status").text("").removeClass("bad").removeClass("good"),!$("#unsorted-files").is(":empty"))return void $("#submit-status").text("All files must be sorted before submitting.").addClass("bad").removeClass("good");if($("#sorted-files").is(":empty"))return void $("#submit-status").text("No files to submit.").addClass("bad").removeClass("good");if(0==$("#sorter-name-input").val().length)return void $("#submit-status").text("Contributor name required.").addClass("bad").removeClass("good");if(!$("#sorter-name-input").val().match(/^[-_0-9a-zÀ-ÿ ]+$/i)){let e=/[^-_0-9a-zÀ-ÿ ]/i.exec($("#sorter-name-input").val());return void $("#submit-status").text(`Invalid character in contributor name: ${e[0]}`).addClass("bad").removeClass("good")}if($(".zip.no-thumbnail"))return void $("#submit-status").text("All zip files must have a thumbnail image before submitting.").addClass("bad").removeClass("good");if(~t.findIndex(e=>"zip"==e.type&&!e.tag))return void $("#submit-status").text("All zip files must be tagged before submitting.").addClass("bad").removeClass("good");n=!0;let a=$("#sorted-files .local.file"),i=[];for(var l=0;l<a.length;l++){let e=t[$(a[l]).attr("data-file-index")];if(e.content.length/1048576>2/.75)return $("#submit-status").text("One or more files exceed 2MB, submission cancelled.").addClass("bad").removeClass("good"),void(n=!1);let s={type:e.type,content:e.content,category:$(a[l]).parent().attr("data-category-name")};e.mcmeta&&(s.mcmeta=e.mcmeta),e.tag&&(s.tag=e.tag),e.thumbnail&&(s.thumbnail=e.thumbnail),i.push(s)}e.getIssues("DokucraftSaga","stash").createIssue({title:"!addfiles",body:"@DokucraftSaga\n"+JSON.stringify({contributor:$("#sorter-name-input").val(),files:i})}).then(e=>{e.status<300?($("#sorted-files .group").remove(),$("#submit-status").text("Textures submitted.").addClass("good").removeClass("bad"),n=!1):($("#submit-status").text(`Failed to submit textures. (${e.status} ${e.statusText})`).addClass("bad").removeClass("good"),n=!1)})}),new Awesomplete($("#sorter-category-input")[0],{list:stash.categories,autoFirst:!0,minChars:1,sort:bestMatchSort($("#sorter-category-input"))}),new Awesomplete($("#sorter-name-input")[0],{list:stash.contributors,autoFirst:!0,sort:bestMatchSort($("#sorter-name-input"))}),tippy("#content .fill .tt",{placement:"right",arrow:!0,hideOnClick:!1,animation:"perspective"}),pageCleanup=(()=>{$(document).off("paste",r)})},r=getURLParams();if(null!=r){if(r.hasOwnProperty("token"))return void(e=new GitHub({token:r.token})).getUser().getProfile((e,t)=>{e?(localStorage.removeItem("gh-login-token"),goToPage("login")):(localStorage.setItem("gh-login-token",r.token),o(t.name||t.login))});if(r.hasOwnProperty("code"))return void $.getJSON("https://dokustash-gatekeeper.herokuapp.com/authenticate/"+r.code,t=>{(e=new GitHub({token:t.token})).getUser().getProfile((e,a)=>{e?(localStorage.removeItem("gh-login-token"),goToPage("login")):(localStorage.setItem("gh-login-token",t.token),o(a.name||a.login))})})}null==localStorage.getItem("gh-login-token")?goToPage("login"):(e=new GitHub({token:localStorage.getItem("gh-login-token")})).getUser().getProfile((e,t)=>{e?(localStorage.removeItem("gh-login-token"),goToPage("login")):o(t.name||t.login)})})();</script>