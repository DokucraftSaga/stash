<link rel="stylesheet" href="/stash/pages/css/pack-builder.css"/><div class="center"><div class="sp-pack-builder-wrapper"><div class="row"><h1 class="filler">Pack Builder</h1><div class="sp-pack-builder-show-my-addons-button inline button when-logged-in-as-contributor">Always show my addons</div><a class="inline button when-logged-in-as-contributor" href="?addon-editor" onclick="stash.page.load(&quot;addon-editor&quot;, null, event)">Create Addon</a></div><br/><div class="sp-pack-builder-sticky-header"><div class="row"><h2 class="filler center">Available Addons</h2><h2 class="filler center">Active Addons</h2></div><div class="row"><div class="sp-pack-builder-addons-search-bar filler"></div><div class="row filler"><div class="filler"></div><div class="sp-pack-builder-pack-flavor inline"></div><div class="sp-pack-builder-pack-format inline"></div><div class="sp-pack-builder-download-button notable inline button">Download</div></div></div></div><div class="row"><div class="sp-pack-builder-available-addons filler"></div><div class="sp-pack-builder-active-addons filler"></div></div></div></div><script>stash.page.identifier().then(e=>{const a=/([a-zA-Z]+)([<>!]=|[<>]|==)(\S+)|true|false/,t=/\(([^\(]+)\)/g,s=/\s+/g,n=/\|/g,r=(e,d={})=>"boolean"==typeof e?e:e.match(t)?r(e.replace(t,(e,a)=>r(a,d).toString()),d):~e.indexOf(" ")?e.split(s).reduce((e,a)=>e=e&&r(a,d),!0):e.split(n).reduce((e,t)=>e=e||((e,t={})=>{if("boolean"==typeof e)return e;{const s=e.match(a);if(!s)return console.error("Invalid condition:",e),!1;if("true"==s[0])return!0;if("false"==s[0])return!1;if("=="==s[2])return t[s[1]]==s[3];if("<="==s[2])return t[s[1]]<=s[3];if(">="==s[2])return t[s[1]]>=s[3];if("<"==s[2])return t[s[1]]<s[3];if(">"==s[2])return t[s[1]]>s[3];if("!="==s[2])return t[s[1]]!=s[3]}})(t,d),!1),d=(e,a)=>{const t=a.split(":")[1];return e[a.split(":")[0]].find(e=>t==(e.path.length>0?e.path+"/":"")+e.name)},i=e=>e.replace(/\\/g,"/"),o={add:{fileInputs:[1],execute:(e,a,t)=>new Promise((s,n)=>{if("string"==typeof e[1]&&~e[1].indexOf(":")){const s=d(t,e[1]);if(!s)return void n("File is missing: "+e[1]);{a.file(i(e[2]),s.content,{base64:s.encoded});const n=d(t,e[1]+".mcmeta");n?a.file(i(e[2]+".mcmeta"),n.content,{base64:n.encoded}):a.file(i(e[2]+".mcmeta"))&&a.remove(i(e[2]+".mcmeta"))}}else a.file(i(e[2]),t[e[1]]),t.hasOwnProperty(e[1]+".mcmeta")?a.file(i(e[2]+".mcmeta"),t[e[1]+".mcmeta"]):stash.data[stash.nameOf(e[1])].animated?a.file(i(e[2]+".mcmeta"),'{"animation":{}}'):a.file(i(e[2]+".mcmeta"))&&a.remove(i(e[2]+".mcmeta"));s()})},crop:{fileInputs:[1],execute:(e,a,t)=>new Promise((e,a)=>{e()})},extract:{fileInputs:[1],execute:(e,a,t)=>new Promise((s,n)=>{let r=null;e[3]&&(r=e[4]?new RegExp(e[3],e[4]):new RegExp(e[3])),t[e[1]].forEach(t=>{const s=(t.path.length>0?t.path+"/":"")+t.name;r&&!s.match(r)||a.file(i((e[2]?e[2]:"")+s),t.content,{base64:t.encoded})}),s()})},remove:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.remove(i(e[1])),t()})},write:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.file(i(e[1]),e[2]?e[2].replace(/\\n/g,"\n"):""),t()})},insert:{fileInputs:[1],execute:(e,a,t)=>new Promise((e,a)=>{e()})}};stash.firebase.db.collection("addons").get().then(a=>{const t={};a.docs.forEach(e=>{try{const a=e.data();a.searchString=`${a.title}\n${a.desc}`.toLowerCase(),a.script=stash.parseAddonScript(a.script),t[e.id]=a}catch(a){console.error("Failed to load addon:",e.id,a)}}),stash.firebase.getUser().then(a=>{a.getIdTokenResult().then(s=>{e.find(".sp-pack-builder-available-addons").append(Object.keys(t).map(n=>{const r=t[n],d=E("div").addClass("sp-pack-builder-addon row"+(a&&r.user==a.uid?" my-addon":"")).attr("data-addon",n).append(E("div").addClass("sp-pack-builder-addon-icon").append(r.icon.map(e=>{const a=stash.nameOf(e);if(!a)return"";const t=E("div"),s=r.icon.length>1?64:128;return stash.data[a].size[0]<s&&(stash.data[a].animated||stash.data[a].size[1]<s)&&t.addClass("pixelated"),"png"==stash.data[a].ext?t.attr("data-src",stash.url.files+a):t.attr("data-src",stash.url.thumbnails+a.replace(/\.zip$/,".png")),stash.data[a].animated?(t.attr("data-mcmeta",stash.data[a].mcmeta),stash.lazy.animationObserver.observe(t[0])):stash.lazy.imageObserver.observe(t[0]),t})),E("div").addClass("filler").append(E("h3").text(r.title),E("p").addClass("sp-pack-builder-addon-desc").text(r.desc),E("div").addClass("row when-inactive").append(E("div").addClass("filler"),a&&(r.user==a.uid||s.claims.admin)?stash.anchor({"addon-editor":n}).addClass("inline button").text("Edit"):"",E("div").addClass("inline button").text("Activate").on("click",a=>{d.addClass("active").detach().prependTo(e.find(".sp-pack-builder-active-addons"))})),E("div").addClass("row when-active").append(E("div").addClass("filler"),E("div").addClass("inline button").text("Move up").on("click",e=>{d.prev().insertAfter(d)}),E("div").addClass("inline button").text("Move down").on("click",e=>{d.next().insertBefore(d)}),E("div").addClass("inline button").text("Deactivate").on("click",a=>{d.removeClass("active").detach().appendTo(e.find(".sp-pack-builder-available-addons")),e.find(".sp-pack-builder-addons-search-bar input").trigger("input")}))));return d})),d()})}),CCInput(e.find(".sp-pack-builder-addons-search-bar"),{placeholder:"Search Addons..."}).children("input").on("input",a=>{const s=$(a.currentTarget).val();e.find(".sp-pack-builder-available-addons .sp-pack-builder-addon.hidden").removeClass("hidden"),s&&s.length&&e.find(".sp-pack-builder-available-addons .sp-pack-builder-addon").filter((e,a)=>!~t[$(a).attr("data-addon")].searchString.indexOf(s.toLowerCase())).addClass("hidden")});const s=()=>({flavor:e.find(".sp-pack-builder-pack-flavor")[0].val(),format:e.find(".sp-pack-builder-pack-format")[0].val()});let n=!1;const d=()=>{const a=s();console.log(a),e.find(".sp-pack-builder-addon.not-compatible").removeClass("not-compatible"),e.find(".sp-pack-builder-addon").filter((e,s)=>!(r(t[$(s).attr("data-addon")].supports,a)||n&&$(s).is("my-addon"))).addClass("not-compatible")};CCInput(e.find(".sp-pack-builder-pack-flavor"),{type:"select",lists:[{name:"Dokucraft Flavors",list:[{name:"Dokucraft Light",value:"Light",selected:!0},{name:"Dokucraft Dark",value:"Dark"},{name:"Dokucraft High",value:"High"},{name:"Dokucraft Dwarven",value:"Dwarven"}]}]}).on("change",d),CCInput(e.find(".sp-pack-builder-pack-format"),{type:"select",lists:[{name:"Resource Pack Formats",list:[{name:"Minecraft 1.13 or later",value:4,selected:!0},{name:"Minecraft 1.12 or 1.11",value:3},{name:"Minecraft 1.10 or 1.9",value:2},{name:"Minecraft 1.8 or earlier",value:1}]}]}).on("change",d),e.find(".sp-pack-builder-show-my-addons-button").on("click",a=>{(n=!n)?(e.find(".sp-pack-builder-wrapper").addClass("always-show-my-addons"),e.find(".sp-pack-builder-show-my-addons-button").text("Filter my addons normally")):(e.find(".sp-pack-builder-wrapper").removeClass("always-show-my-addons"),e.find(".sp-pack-builder-show-my-addons-button").text("Always show my addons"))}),e.find(".sp-pack-builder-download-button").on("click",a=>{stash.workIndeterminate();const n=new JSZip,d=s(),i=e.find(".sp-pack-builder-active-addons .sp-pack-builder-addon:not(.not-compatible)").toArray().map(e=>t[$(e).attr("data-addon")]),l=[],c=e=>{Array.isArray(e)?l.push(e):e.hasOwnProperty("if")&&(r(e.if,d)?e.then.forEach(c):e.hasOwnProperty("else")&&e.else.forEach(c))};[].concat(...i.reverse().map(e=>e.script)).forEach(c);const p=new Set;l.forEach(e=>{o[e[0]]&&o[e[0]].fileInputs.forEach(a=>{const t=e[a];"string"==typeof t&&~t.indexOf(":")?p.add(t.split(":")[0]):p.add(t)})});const u=[];let f=0;const h={};Array.from(p).map(e=>stash.nameOf(e)).forEach(e=>{const a=stash.data[e].id;u.push("png"==stash.data[e].ext?$.ajax(stash.url.files+e,{xhrFields:{responseType:"blob"}}).done(e=>{h[a]=e,stash.setWorkProgress(Math.floor(100*++f/p.length))}).fail(a=>{stash.notify(`Failed to download file: ${e}<br>(${a.status} ${a.statusText})`,null,"error")}):stash.getZIPContent(e).then(e=>{h[a]=e,stash.setWorkProgress(Math.floor(100*++f/p.length))})),"png"==stash.data[e].ext&&stash.data[e].mcmeta&&u.push($.ajax(stash.url.files+e+".mcmeta",{xhrFields:{responseType:"blob"}}).done(e=>{h[a+".mcmeta"]=e}).fail(a=>{stash.notify(`Failed to download file: ${e+".mcmeta"}<br>(${a.status} ${a.statusText})`,null,"error")}))}),Promise.all(u).then(()=>(stash.workIndeterminate(),l.reduce((e,a)=>e.then(()=>o[a[0]].execute(a,n,h)),Promise.resolve()))).then(()=>(n.file("pack.mcmeta",JSON.stringify({pack:{pack_format:d.format,description:"§7Custom Patch\n§rGenerated by §9DokuStash"}}).replace(/§/g,"\\u00A7")),$.ajax("resources/pack.png",{xhrFields:{responseType:"blob"}}).done(e=>{n.file("pack.png",e)}).fail(e=>{stash.notify(`Failed to download file: pack.png<br>(${e.status} ${e.statusText})`,null,"error")}))).then(()=>{n.generateAsync({type:"blob"}).then(e=>{saveAs(e,"Dokucraft-Custom-Patch.zip"),stash.workComplete()})}).catch(e=>{stash.notify("An error occurred.<br>"+e.toString(),null,"error"),stash.workError()})})})});</script><img onload="stash.page.identifierLoaded(this);void(0);" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="/>