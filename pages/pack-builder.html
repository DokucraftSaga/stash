<link rel="stylesheet" href="/stash/pages/css/pack-builder.css"/><div class="center"><div class="sp-pack-builder-wrapper"><div class="row"><h1 class="filler">Pack Builder</h1><div class="sp-pack-builder-show-my-addons-button inline button when-logged-in-as-contributor">Always show my addons</div><a class="inline button when-logged-in-as-contributor" href="?addon-editor" onclick="stash.page.load(&quot;addon-editor&quot;, null, event)">Create Addon</a></div><br/><div class="sp-pack-builder-sticky-header"><div class="row"><h2 class="filler center">Available Addons</h2><h2 class="filler center">Active Addons</h2></div><div class="row"><div class="sp-pack-builder-addons-search-bar filler"></div><div class="row filler"><div class="filler"></div><div class="sp-pack-builder-pack-flavor inline"></div><div class="sp-pack-builder-pack-format inline"></div><div class="sp-pack-builder-download-button notable inline button">Download</div></div></div></div><div class="row"><div class="sp-pack-builder-available-addons filler"></div><div class="sp-pack-builder-active-addons filler"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/jimp@0.6.4/browser/lib/jimp.min.js"></script><script>stash.page.identifier().then(e=>{const a=/([a-zA-Z]+)([<>!]=|[<>]|==)(\S+)|true|false/,t=/\(([^\(]+)\)/g,s=/\s+/g,n=/\|/g,r=(e,i={})=>"boolean"==typeof e?e:e.match(t)?r(e.replace(t,(e,a)=>r(a,i).toString()),i):~e.indexOf(" ")?e.split(s).reduce((e,a)=>e=e&&r(a,i),!0):e.split(n).reduce((e,t)=>e=e||((e,t={})=>{if("boolean"==typeof e)return e;{const s=e.match(a);if(!s)return console.error("Invalid condition:",e),!1;if("true"==s[0])return!0;if("false"==s[0])return!1;if("=="==s[2])return t[s[1]]==s[3];if("<="==s[2])return t[s[1]]<=s[3];if(">="==s[2])return t[s[1]]>=s[3];if("<"==s[2])return t[s[1]]<s[3];if(">"==s[2])return t[s[1]]>s[3];if("!="==s[2])return t[s[1]]!=s[3]}})(t,i),!1),i=(e,a)=>{const t=a.split(":")[1];return e[a.split(":")[0]].find(e=>t==(e.path.length>0?e.path+"/":"")+e.name)},d=e=>e.replace(/\\/g,"/"),o={add:{fileInputs:[1],execute:(e,a,t)=>new Promise((s,n)=>{if("string"==typeof e[1]&&~e[1].indexOf(":"))if(e[1].match(/\/$/)){const s=d(e[1].split(":")[1]);t[e[1].split(":")[0]].forEach(t=>{const n=(t.path.length>0?t.path+"/":"")+t.name;0==n.indexOf(s)&&a.file(d(n).replace(s,e[2]?d(e[2]):""),t.content,{base64:t.encoded})})}else{const s=i(t,e[1]);if(!s)return void n("File is missing: "+e[1]);{a.file(d(e[2]),s.content,{base64:s.encoded});const n=i(t,e[1]+".mcmeta");n?a.file(d(e[2]+".mcmeta"),n.content,{base64:n.encoded}):a.file(d(e[2]+".mcmeta"))&&a.remove(d(e[2]+".mcmeta"))}}else a.file(d(e[2]),t[e[1]]),t.hasOwnProperty(e[1]+".mcmeta")?a.file(d(e[2]+".mcmeta"),t[e[1]+".mcmeta"]):stash.data[stash.nameOf(e[1])].animated?a.file(d(e[2]+".mcmeta"),'{"animation":{}}'):a.file(d(e[2]+".mcmeta"))&&a.remove(d(e[2]+".mcmeta"));s()})},crop:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.file(d(e[1])).async("arraybuffer").then(e=>Jimp.read(e)).then(s=>{s.crop(parseInt(e[4]),parseInt(e[5]),parseInt(e[2]),parseInt(e[3])),s.getBufferAsync(Jimp.MIME_PNG).then(s=>{a.file(d(e[1]),new Blob([s])),t()})})})},extract:{fileInputs:[1],execute:(e,a,t)=>new Promise((s,n)=>{let r=null;e[3]&&(r=e[4]?new RegExp(e[3],e[4]):new RegExp(e[3])),t[e[1]].forEach(t=>{const s=(t.path.length>0?t.path+"/":"")+t.name;r&&!s.match(r)||a.file(d((e[2]?e[2]:"")+s),t.content,{base64:t.encoded})}),s()})},remove:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.remove(d(e[1])),t()})},write:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.file(d(e[1]),e[2]?e[2].replace(/\\n/g,"\n"):""),t()})},insert:{fileInputs:[1],execute:(e,a,t)=>new Promise((s,n)=>{a.file(d(e[2])).async("arraybuffer").then(e=>Jimp.read(e)).then(s=>{if(e[1].match(/^(\d+|\d+:)/)){if(~e[1].indexOf(":")){const a=i(t,e[1]);return a?Promise.all([s,Buffer.from(a.content,"base64")]):void n("File is missing: "+e[1])}return Promise.all([s,new Promise(a=>{const s=new FileReader;s.onload=(e=>{a(e.target.result)}),s.readAsArrayBuffer(t[e[1]])})])}return Promise.all([s,a.file(d(e[1])).async("arraybuffer")])}).then(e=>Promise.all([e[0],Jimp.read(e[1])])).then(t=>{const n=parseInt(e[3]),r=parseInt(e[4]);t[0].scan(n,r,t[1].bitmap.width,t[1].bitmap.height,(e,a,s)=>{const i=t[1].getPixelIndex(e-n,a-r);t[0].bitmap.data[s+0]=t[1].bitmap.data[i+0],t[0].bitmap.data[s+1]=t[1].bitmap.data[i+1],t[0].bitmap.data[s+2]=t[1].bitmap.data[i+2],t[0].bitmap.data[s+3]=t[1].bitmap.data[i+3]}),t[0].getBufferAsync(Jimp.MIME_PNG).then(t=>{a.file(d(e[2]),new Blob([t])),s()})})})},replace:{fileInputs:[],execute:(e,a,t)=>new Promise((t,s)=>{a.file(d(e[1])).async("text").then(s=>{a.file(d(e[1]),s.split(e[2]).join(e[3]?e[3].replace(/\\n/g,"\n"):"")),t()})})}};stash.firebase.db.collection("addons").get().then(a=>{const t={};a.docs.forEach(e=>{try{const a=e.data();a.searchString=`${a.title}\n${a.desc}`.toLowerCase(),a.script=stash.parseAddonScript(a.script),t[e.id]=a}catch(a){console.error("Failed to load addon:",e.id,a)}});const s=(a,s)=>{e.find(".sp-pack-builder-available-addons").append(Object.keys(t).map(n=>{const r=t[n],i=E("div").addClass("sp-pack-builder-addon row"+(a&&r.user==a.uid?" my-addon":"")).attr("data-addon",n).append(E("div").addClass("sp-pack-builder-addon-icon").append(r.icon.map(e=>{const a=stash.nameOf(e);if(!a)return"";const t=E("div"),s=r.icon.length>1?64:128;let n=stash.data[a].size.slice(),i=!1;if(n[0]>128||!stash.data[a].animated&&n[1]>128){i=!0;const e=128/Math.max(...n);n=n.map(a=>a*e)}return n[0]<s&&(stash.data[a].animated||n[1]<s)&&t.addClass("pixelated"),"png"!=stash.data[a].ext||i&&!stash.data[a].animated?t.attr("data-src",stash.url.thumbnails+a.replace(/\.zip$/,".png")):t.attr("data-src",stash.url.files+a),stash.data[a].animated?(t.attr("data-mcmeta",stash.data[a].mcmeta),stash.lazy.animationObserver.observe(t[0])):stash.lazy.imageObserver.observe(t[0]),t})),E("div").addClass("filler").append(E("h3").text(r.title),E("p").addClass("sp-pack-builder-addon-desc").text(r.desc),E("div").addClass("row when-inactive").append(E("div").addClass("filler"),a&&(r.user==a.uid||s.claims.admin)?stash.anchor({"addon-editor":n}).addClass("inline button").text("Edit"):"",E("div").addClass("inline button").text("Activate").on("click",a=>{i.addClass("active").detach().prependTo(e.find(".sp-pack-builder-active-addons"))})),E("div").addClass("row when-active").append(E("div").addClass("filler"),E("div").addClass("inline button").text("Move up").on("click",e=>{i.prev().insertAfter(i)}),E("div").addClass("inline button").text("Move down").on("click",e=>{i.next().insertBefore(i)}),E("div").addClass("inline button").text("Deactivate").on("click",a=>{i.removeClass("active").detach().appendTo(e.find(".sp-pack-builder-available-addons")),e.find(".sp-pack-builder-addons-search-bar input").trigger("input")}))));return i})),d()};stash.firebase.getUser().then(e=>{e.getIdTokenResult().then(a=>{s(e,a)})}).catch(()=>{s()}),CCInput(e.find(".sp-pack-builder-addons-search-bar"),{placeholder:"Search Addons..."}).children("input").on("input",a=>{const s=$(a.currentTarget).val();e.find(".sp-pack-builder-available-addons .sp-pack-builder-addon.hidden").removeClass("hidden"),s&&s.length&&e.find(".sp-pack-builder-available-addons .sp-pack-builder-addon").filter((e,a)=>!~t[$(a).attr("data-addon")].searchString.indexOf(s.toLowerCase())).addClass("hidden")});const n=()=>({flavor:e.find(".sp-pack-builder-pack-flavor")[0].val(),format:e.find(".sp-pack-builder-pack-format")[0].val()});let i=!1;const d=()=>{const a=n();e.find(".sp-pack-builder-addon.not-compatible").removeClass("not-compatible"),e.find(".sp-pack-builder-addon").filter((e,s)=>!(r(t[$(s).attr("data-addon")].supports,a)||i&&$(s).is("my-addon"))).addClass("not-compatible")};CCInput(e.find(".sp-pack-builder-pack-flavor"),{type:"select",lists:[{name:"Dokucraft Flavors",list:[{name:"Dokucraft Light",value:"Light",selected:!0},{name:"Dokucraft Dark",value:"Dark"},{name:"Dokucraft High",value:"High"},{name:"Dokucraft Dwarven",value:"Dwarven"}]}]}).on("change",d),CCInput(e.find(".sp-pack-builder-pack-format"),{type:"select",lists:[{name:"Resource Pack Formats",list:[{name:"Minecraft 1.13 or later",value:4,selected:!0},{name:"Minecraft 1.12 or 1.11",value:3},{name:"Minecraft 1.10 or 1.9",value:2},{name:"Minecraft 1.8 or earlier",value:1}]}]}).on("change",d),e.find(".sp-pack-builder-show-my-addons-button").on("click",a=>{(i=!i)?(e.find(".sp-pack-builder-wrapper").addClass("always-show-my-addons"),e.find(".sp-pack-builder-show-my-addons-button").text("Filter my addons normally")):(e.find(".sp-pack-builder-wrapper").removeClass("always-show-my-addons"),e.find(".sp-pack-builder-show-my-addons-button").text("Always show my addons"))}),e.find(".sp-pack-builder-download-button").on("click",a=>{stash.workIndeterminate();const s=new JSZip,i=n(),d={},l=(e,a)=>{d[e]||(d[e]=[]),Array.isArray(a)?d[e].push(a):a.hasOwnProperty("if")&&(r(a.if,i)?a.then.forEach(a=>l(e,a)):a.hasOwnProperty("else")&&a.else.forEach(a=>l(e,a)))},c=e.find([".sp-pack-builder-active-addons .sp-pack-builder-addon:not(.not-compatible)",".always-show-my-addons .sp-pack-builder-active-addons .sp-pack-builder-addon.my-addon"].join(",")).toArray().map(e=>$(e).attr("data-addon")).reverse();c.forEach(e=>{t[e].script.forEach(a=>l(e,a))});const p=new Set;c.reduce((e,a)=>e.push(...d[a])&&e,[]).forEach(e=>{o[e[0]]&&o[e[0]].fileInputs.forEach(a=>{const t=e[a];"string"==typeof t&&~t.indexOf(":")?p.add(t.split(":")[0]):("number"==typeof t||"string"==typeof t&&!isNaN(t))&&p.add(t)})});const f=Array.from(p).map(e=>stash.nameOf(e)),m=[];let h=0;const u={};f.forEach(e=>{const a=stash.data[e].id;m.push("png"==stash.data[e].ext?$.ajax(stash.url.files+e,{xhrFields:{responseType:"blob"}}).done(e=>{u[a]=e,stash.setWorkProgress(Math.floor(100*++h/p.length))}).fail(a=>{stash.notify(`Failed to download file: ${e}<br>(${a.status} ${a.statusText})`,null,"error")}):stash.getZIPContent(e).then(e=>{u[a]=e,stash.setWorkProgress(Math.floor(100*++h/p.length))})),"png"==stash.data[e].ext&&stash.data[e].mcmeta&&m.push($.ajax(stash.url.files+e+".mcmeta",{xhrFields:{responseType:"blob"}}).done(e=>{u[a+".mcmeta"]=e}).fail(a=>{stash.notify(`Failed to download file: ${e+".mcmeta"}<br>(${a.status} ${a.statusText})`,null,"error")}))}),Promise.all(m).then(()=>(stash.workIndeterminate(),Promise.all(c.map(e=>new Promise(a=>{const t=new JSZip;d[e].reduce((e,a)=>e.then(e=>o[a[0]].execute(a,t,u)),Promise.resolve()).then(()=>a(t))}))).then(e=>Promise.all(e.map(e=>Promise.all(Object.keys(e.files).filter(a=>!e.files[a].dir).map(a=>e.file(a).async("blob").then(e=>s.file(a,e))))))))).then(()=>{s.file("pack.mcmeta",JSON.stringify({pack:{pack_format:parseInt(i.format),description:"§7Custom Patch\n§rGenerated by §9DokuStash"}}).replace(/§/g,"\\u00A7"));const e=new Set,a=t=>{e.add(stash.data[t].contributor),stash.data[t].parents&&stash.data[t].parents.filter(e=>!isNaN(e)).forEach(e=>a(stash.nameOf(e)))};return f.forEach(a),s.file("Patch Contributors.txt",[...e].join("\n")),$.ajax("resources/pack.png",{xhrFields:{responseType:"blob"}}).done(e=>{s.file("pack.png",e)}).fail(e=>{stash.notify(`Failed to download file: pack.png<br>(${e.status} ${e.statusText})`,null,"error")})}).then(()=>{s.generateAsync({type:"blob"}).then(e=>{saveAs(e,"Dokucraft-Custom-Patch.zip"),stash.workComplete()})}).catch(e=>{stash.notify("An error occurred.<br>"+e.toString(),null,"error"),stash.workError()})})})});</script><img onload="stash.page.identifierLoaded(this);void(0);" src="data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw=="/>